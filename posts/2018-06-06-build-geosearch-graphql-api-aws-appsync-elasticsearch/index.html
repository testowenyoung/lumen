<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.75 'Merriweather','Georgia',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.9);font-family:'Merriweather','Georgia',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:Montserrat,sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:2.5rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.73286rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.4427rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;letter-spacing:0.140625em;text-transform:uppercase;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.83255rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.75966rem;line-height:1.1;font-style:italic;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}ul{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;list-style:disc;}ol{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:0.85rem;line-height:1.75rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1rem;line-height:1.75rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}blockquote{margin-left:-1.75rem;margin-right:1.75rem;margin-top:0;padding-bottom:0;padding-left:1.42188rem;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1.20112rem;line-height:1.75rem;color:hsla(0,0%,0%,0.59);font-style:italic;border-left:0.32813rem solid hsla(0,0%,0%,0.9);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.75rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.75rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}li > ul{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.75rem / 2);}code{font-size:0.85rem;line-height:1.75rem;}kbd{font-size:0.85rem;line-height:1.75rem;}samp{font-size:0.85rem;line-height:1.75rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.16667rem;padding-right:1.16667rem;padding-top:0.875rem;padding-bottom:calc(0.875rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.75rem;color:hsla(0,0%,0%,0.9);font-weight:400;}blockquote cite:before{content:"— ";}ul,ol{margin-left:0;}@media only screen and (max-width:480px){ul,ol{margin-left:1.75rem;}blockquote{margin-left:-1.3125rem;margin-right:0;padding-left:0.98438rem;}}h1,h2,h3,h4,h5,h6{margin-top:3.5rem;}a{box-shadow:0 1px 0 0 currentColor;color:#007acc;text-decoration:none;}a:hover,a:active{box-shadow:none;}mark,ins{background:#007acc;color:white;padding:0.10938rem 0.21875rem;text-decoration:none;}a.gatsby-resp-image-link{box-shadow:none;}</style><style data-href="/lumen/styles.1d0daeadf0762b76da98.css">@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:100;src:local("Montserrat Thin "),local("Montserrat-Thin"),url(/lumen/static/montserrat-latin-100-191cc9f50f3b76b9617cb383f19acb7d.woff2) format("woff2"),url(/lumen/static/montserrat-latin-100-370318464551d5f25b0f0a78f374faac.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:100;src:local("Montserrat Thin italic"),local("Montserrat-Thinitalic"),url(/lumen/static/montserrat-latin-100italic-bdeaeb79db315697bd173a55b097dc18.woff2) format("woff2"),url(/lumen/static/montserrat-latin-100italic-ecf7d49386e8f265878e735db34a7c4b.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:200;src:local("Montserrat Extra Light "),local("Montserrat-Extra Light"),url(/lumen/static/montserrat-latin-200-85d5ef9db7f2dc6979172a4a3b2c57cb.woff2) format("woff2"),url(/lumen/static/montserrat-latin-200-1fc98e126a3d152549240e6244d7e669.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:200;src:local("Montserrat Extra Light italic"),local("Montserrat-Extra Lightitalic"),url(/lumen/static/montserrat-latin-200italic-49095760a498d024fe1a85a078850df9.woff2) format("woff2"),url(/lumen/static/montserrat-latin-200italic-fe46cf8b9462c820457d3bf537e4057f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:300;src:local("Montserrat Light "),local("Montserrat-Light"),url(/lumen/static/montserrat-latin-300-7c3daf12b706645b5d3710f863a4da04.woff2) format("woff2"),url(/lumen/static/montserrat-latin-300-8dc95fab9cf98d02ca8d76e97d3dff60.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:300;src:local("Montserrat Light italic"),local("Montserrat-Lightitalic"),url(/lumen/static/montserrat-latin-300italic-f20b178ca2024a5eac8e42e6649db86c.woff2) format("woff2"),url(/lumen/static/montserrat-latin-300italic-3fe16939288856e8e828fa2661bf2354.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:400;src:local("Montserrat Regular "),local("Montserrat-Regular"),url(/lumen/static/montserrat-latin-400-bc3aa95dca08f5fee5291e34959c27bc.woff2) format("woff2"),url(/lumen/static/montserrat-latin-400-8102c4838f9e3d08dad644290a9cb701.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:400;src:local("Montserrat Regular italic"),local("Montserrat-Regularitalic"),url(/lumen/static/montserrat-latin-400italic-5cad650422a7184467af5a4d17b264c4.woff2) format("woff2"),url(/lumen/static/montserrat-latin-400italic-d191f22af3bb50902b99ac577f81a322.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:500;src:local("Montserrat Medium "),local("Montserrat-Medium"),url(/lumen/static/montserrat-latin-500-92d16e458625f4d2c8940f6bdca0ff09.woff2) format("woff2"),url(/lumen/static/montserrat-latin-500-8b763220218ffc11c57c84ddb80e7b26.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:500;src:local("Montserrat Medium italic"),local("Montserrat-Mediumitalic"),url(/lumen/static/montserrat-latin-500italic-47bfcca6b69d6a9acca7a8bff17193e2.woff2) format("woff2"),url(/lumen/static/montserrat-latin-500italic-72c01f753c3940c0b9cb6bf2389caddf.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:600;src:local("Montserrat SemiBold "),local("Montserrat-SemiBold"),url(/lumen/static/montserrat-latin-600-6fb1b5623e528e27c18658fecf5ee0ee.woff2) format("woff2"),url(/lumen/static/montserrat-latin-600-7c839d15a6f54e7025ba8c0c4b333e8f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:600;src:local("Montserrat SemiBold italic"),local("Montserrat-SemiBolditalic"),url(/lumen/static/montserrat-latin-600italic-60789af1c9338ed1a9546722ec54b4f7.woff2) format("woff2"),url(/lumen/static/montserrat-latin-600italic-f3d4de8d0afb19e777c79032ce828e3d.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:700;src:local("Montserrat Bold "),local("Montserrat-Bold"),url(/lumen/static/montserrat-latin-700-39d93cf678c740f9f6b2b1cfde34bee3.woff2) format("woff2"),url(/lumen/static/montserrat-latin-700-80f10bd382f0df1cd650fec59f3c9394.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:700;src:local("Montserrat Bold italic"),local("Montserrat-Bolditalic"),url(/lumen/static/montserrat-latin-700italic-ba136d97b14e82284dd595e257f11c47.woff2) format("woff2"),url(/lumen/static/montserrat-latin-700italic-8c98142b425630821139c24bd1698700.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold "),local("Montserrat-ExtraBold"),url(/lumen/static/montserrat-latin-800-b7018be9ed6cd94da8b6675b3a468c3b.woff2) format("woff2"),url(/lumen/static/montserrat-latin-800-9a9befcf50d64f9d2d19d8b1d1984add.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold italic"),local("Montserrat-ExtraBolditalic"),url(/lumen/static/montserrat-latin-800italic-540ffdd223d1a9ad3d4e678e1a23372e.woff2) format("woff2"),url(/lumen/static/montserrat-latin-800italic-897086f99f4e1f45e6b1e9368527d0bc.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:900;src:local("Montserrat Black "),local("Montserrat-Black"),url(/lumen/static/montserrat-latin-900-58cd789700850375b834e8b6776002eb.woff2) format("woff2"),url(/lumen/static/montserrat-latin-900-26d42c9428780e545a540bbb50c84bce.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:900;src:local("Montserrat Black italic"),local("Montserrat-Blackitalic"),url(/lumen/static/montserrat-latin-900italic-451157bc8861fe54f523b3669a3def71.woff2) format("woff2"),url(/lumen/static/montserrat-latin-900italic-a8ec4957e1c24f5793305763ad9845b3.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:300;src:local("Merriweather Light "),local("Merriweather-Light"),url(/lumen/static/merriweather-latin-300-b1158cfcd4aacb9d8fb61625e37af46a.woff2) format("woff2"),url(/lumen/static/merriweather-latin-300-cc7de05e166e90320d7d896e0f72a19d.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:300;src:local("Merriweather Light italic"),local("Merriweather-Lightitalic"),url(/lumen/static/merriweather-latin-300italic-8fe52a48089d6ebe46db0b8e7cc66263.woff2) format("woff2"),url(/lumen/static/merriweather-latin-300italic-e1331f5397c2a673f9d3765138debdb5.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:400;src:local("Merriweather Regular "),local("Merriweather-Regular"),url(/lumen/static/merriweather-latin-400-8276fdb72ae8f4714d4e6eba704cc39f.woff2) format("woff2"),url(/lumen/static/merriweather-latin-400-69f09800f4f6479d06e44eba837df872.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:400;src:local("Merriweather Regular italic"),local("Merriweather-Regularitalic"),url(/lumen/static/merriweather-latin-400italic-3a9be9ea9f7aa4af6de7307df21d9fc0.woff2) format("woff2"),url(/lumen/static/merriweather-latin-400italic-d76079ed7541a433a54f79316de086e9.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:700;src:local("Merriweather Bold "),local("Merriweather-Bold"),url(/lumen/static/merriweather-latin-700-fa534be7ffa380e39a7f6e03bf9a5e03.woff2) format("woff2"),url(/lumen/static/merriweather-latin-700-ba56ea84b8084b7ff9677f50d3cd81bd.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:700;src:local("Merriweather Bold italic"),local("Merriweather-Bolditalic"),url(/lumen/static/merriweather-latin-700italic-1ef5edaaa20ae53ea50399884c5e48c6.woff2) format("woff2"),url(/lumen/static/merriweather-latin-700italic-534bc9e7ce93c73d73426e46acd78092.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:900;src:local("Merriweather Black "),local("Merriweather-Black"),url(/lumen/static/merriweather-latin-900-7528fb70e8a4a82c7305e72ff43ac25f.woff2) format("woff2"),url(/lumen/static/merriweather-latin-900-3799b6e2f5ed3fcccf9d7a708d7419fa.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:900;src:local("Merriweather Black italic"),local("Merriweather-Blackitalic"),url(/lumen/static/merriweather-latin-900italic-e1b4d2aaa78e12ad84aaf8a56321e4c2.woff2) format("woff2"),url(/lumen/static/merriweather-latin-900italic-2ae22f731b3424e8dbb4b37f7ca6e708.woff) format("woff")}code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 2.23.12"/><link rel="alternate" type="application/rss+xml" href="/lumen/rss.xml"/><link rel="icon" href="/lumen/favicon-32x32.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="manifest" href="/lumen/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/lumen/icons/icon-48x48.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="72x72" href="/lumen/icons/icon-72x72.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="96x96" href="/lumen/icons/icon-96x96.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="144x144" href="/lumen/icons/icon-144x144.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="192x192" href="/lumen/icons/icon-192x192.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="256x256" href="/lumen/icons/icon-256x256.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="384x384" href="/lumen/icons/icon-384x384.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="512x512" href="/lumen/icons/icon-512x512.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><title data-react-helmet="true">Build a Serverless GeoSearch GraphQL API using AWS AppSync &amp; Elasticsearch | Gatsby Starter Blog</title><meta data-react-helmet="true" name="description" content="Learn how to build a GraphQL location search service similar to AirBnB&#x27;s using a fully serverless stack on AWS."/><meta data-react-helmet="true" property="og:title" content="Build a Serverless GeoSearch GraphQL API using AWS AppSync &amp; Elasticsearch"/><meta data-react-helmet="true" property="og:description" content="Learn how to build a GraphQL location search service similar to AirBnB&#x27;s using a fully serverless stack on AWS."/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="kylemathews"/><meta data-react-helmet="true" name="twitter:title" content="Build a Serverless GeoSearch GraphQL API using AWS AppSync &amp; Elasticsearch"/><meta data-react-helmet="true" name="twitter:description" content="Learn how to build a GraphQL location search service similar to AirBnB&#x27;s using a fully serverless stack on AWS."/><link as="script" rel="preload" href="/lumen/webpack-runtime-c76c0c9d42bc9bf56761.js"/><link as="script" rel="preload" href="/lumen/framework-5fc6169171e885c3b522.js"/><link as="script" rel="preload" href="/lumen/styles-cd63080e784be7b7e7cf.js"/><link as="script" rel="preload" href="/lumen/app-36e457a5393b79b99515.js"/><link as="script" rel="preload" href="/lumen/commons-4c36ffabef1434ec1126.js"/><link as="script" rel="preload" href="/lumen/cd7d5f864fc9e15ed8adef086269b0aeff617554-c8f68cb3ade1320f5257.js"/><link as="script" rel="preload" href="/lumen/component---src-templates-blog-post-js-e4c781a4720974cc2679.js"/><link as="fetch" rel="preload" href="/lumen/page-data/posts/2018-06-06-build-geosearch-graphql-api-aws-appsync-elasticsearch/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/lumen/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div style="margin-left:auto;margin-right:auto;max-width:42rem;padding:2.625rem 1.3125rem"><header><h3 style="font-family:Montserrat, sans-serif;margin-top:0"><a style="box-shadow:none;color:inherit" href="/lumen/">Gatsby Starter Blog</a></h3></header><main><article><header><h1 style="margin-top:1.75rem;margin-bottom:0">Build a Serverless GeoSearch GraphQL API using AWS AppSync &amp; Elasticsearch</h1><p style="font-size:0.83255rem;line-height:1.75rem;display:block;margin-bottom:1.75rem">June 06, 2018</p></header><section><p>In this tutorial, we’re going to build an Elasticsearch-backed GraphQL API on AWS AppSync. All using the Serverless Framework.</p>
<p><a href="https://serverless.com/aws-appsync/">AppSync</a> offers the ability to create serverless GraphQL APIs with much less backend code than previously possible. We will take advantage of this to create our own geo search service (similar to the one used by AirBnB), which will allow users to search for items within a 10km radius of a given location.</p>
<p>Let’s get started!</p>
<ol>
<li><a href="#setup">Setup</a></li>
<li><a href="#deploy-elasticsearch">Deploy Elasticsearch on AWS</a></li>
<li><a href="#elasticsearch-geomappings">Elasticsearch Geo Mappings</a></li>
<li><a href="#graphql-schema">Define GraphQL Schema for API</a></li>
<li><a href="#es-mapping-templates">Appsync Mapping Template GraphQL Resolvers</a></li>
<li><a href="#deploy-api">Deploy GraphQL Appsync API</a></li>
<li><a href="#destroy">Teardown</a></li>
</ol>
<h2>1. <a name="setup"></a>Setup</h2>
<p>Go ahead and install the <a href="https://serverless.com/framework/">Serverless Framework</a> CLI and create a new directory for our project:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">$ <span class="token function">npm</span> <span class="token function">install</span> -g serverless
$ <span class="token function">mkdir</span> geosearch
$ <span class="token builtin class-name">cd</span> geosearch</code></pre></div>
<h2>2. <a name="deploy-elasticsearch"></a>Deploy Elasticsearch on AWS</h2>
<p>First we need to provision our elasticsearch deployment on AWS. Create a <code class="language-text">serverless.yml</code> file with the following contents:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">service</span><span class="token punctuation">:</span> appsync<span class="token punctuation">-</span>placesearch

<span class="token key atrule">frameworkVersion</span><span class="token punctuation">:</span> <span class="token string">">=1.21.0 &lt;2.0.0"</span>

<span class="token key atrule">provider</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> aws
  <span class="token key atrule">region</span><span class="token punctuation">:</span> eu<span class="token punctuation">-</span>west<span class="token punctuation">-</span><span class="token number">1</span>

<span class="token key atrule">custom</span><span class="token punctuation">:</span>
  <span class="token key atrule">esDomainName</span><span class="token punctuation">:</span> placesearch
  <span class="token key atrule">esRoleName</span><span class="token punctuation">:</span> AppSyncServiceRole

<span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token key atrule">Resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">ElasticSearchInstance</span><span class="token punctuation">:</span>
      <span class="token key atrule">Type</span><span class="token punctuation">:</span> AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>Elasticsearch<span class="token punctuation">:</span><span class="token punctuation">:</span>Domain
      <span class="token key atrule">Properties</span><span class="token punctuation">:</span>
        <span class="token key atrule">ElasticsearchVersion</span><span class="token punctuation">:</span> <span class="token number">6.2</span>
        <span class="token key atrule">DomainName</span><span class="token punctuation">:</span> <span class="token string">"${self:custom.esDomainName}"</span>
        <span class="token key atrule">EBSOptions</span><span class="token punctuation">:</span>
          <span class="token key atrule">EBSEnabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">VolumeType</span><span class="token punctuation">:</span> gp2
          <span class="token key atrule">VolumeSize</span><span class="token punctuation">:</span> <span class="token number">10</span>
        <span class="token key atrule">ElasticsearchClusterConfig</span><span class="token punctuation">:</span>
          <span class="token key atrule">InstanceType</span><span class="token punctuation">:</span> t2.small.elasticsearch
          <span class="token key atrule">InstanceCount</span><span class="token punctuation">:</span> <span class="token number">1</span>
          <span class="token key atrule">DedicatedMasterEnabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
          <span class="token key atrule">ZoneAwarenessEnabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">AppSyncESServiceRole</span><span class="token punctuation">:</span>
      <span class="token key atrule">Type</span><span class="token punctuation">:</span> <span class="token string">"AWS::IAM::Role"</span>
      <span class="token key atrule">Properties</span><span class="token punctuation">:</span>
        <span class="token key atrule">RoleName</span><span class="token punctuation">:</span> <span class="token string">"ElasticSearch-${self:custom.esRoleName}"</span>
        <span class="token key atrule">AssumeRolePolicyDocument</span><span class="token punctuation">:</span>
          <span class="token key atrule">Version</span><span class="token punctuation">:</span> <span class="token string">"2012-10-17"</span>
          <span class="token key atrule">Statement</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span>
              <span class="token key atrule">Effect</span><span class="token punctuation">:</span> <span class="token string">"Allow"</span>
              <span class="token key atrule">Principal</span><span class="token punctuation">:</span>
                <span class="token key atrule">Service</span><span class="token punctuation">:</span>
                  <span class="token punctuation">-</span> <span class="token string">"appsync.amazonaws.com"</span>
              <span class="token key atrule">Action</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> <span class="token string">"sts:AssumeRole"</span>
        <span class="token key atrule">Policies</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span>
            <span class="token key atrule">PolicyName</span><span class="token punctuation">:</span> <span class="token string">"AppSyncESServiceRolePolicy"</span>
            <span class="token key atrule">PolicyDocument</span><span class="token punctuation">:</span>
              <span class="token key atrule">Version</span><span class="token punctuation">:</span> <span class="token string">"2012-10-17"</span>
              <span class="token key atrule">Statement</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span>
                  <span class="token key atrule">Effect</span><span class="token punctuation">:</span> <span class="token string">"Allow"</span>
                  <span class="token key atrule">Action</span><span class="token punctuation">:</span>
                    <span class="token punctuation">-</span> <span class="token string">"es:*"</span>
                  <span class="token key atrule">Resource</span><span class="token punctuation">:</span>
                    <span class="token punctuation">-</span> <span class="token key atrule">'Fn::Join'</span><span class="token punctuation">:</span>
                        <span class="token punctuation">-</span> <span class="token string">''</span>
                        <span class="token punctuation">-</span>
                          <span class="token punctuation">-</span> <span class="token string">'arn:aws:es:'</span>
                          <span class="token punctuation">-</span> <span class="token key atrule">Ref</span><span class="token punctuation">:</span> <span class="token string">'AWS::Region'</span>
                          <span class="token punctuation">-</span> <span class="token string">':'</span>
                          <span class="token punctuation">-</span> <span class="token key atrule">Ref</span><span class="token punctuation">:</span> <span class="token string">'AWS::AccountId'</span>
                          <span class="token punctuation">-</span> <span class="token string">':domain/'</span>
                          <span class="token punctuation">-</span> <span class="token string">"${self:custom.esDomainName}"</span>
                          <span class="token punctuation">-</span> <span class="token string">'/*'</span></code></pre></div>
<p>This creates a cluster with a single instance running Elasticsearch version 6, and adds a role to access it. This will be used by the Appsync service we’re creating later.</p>
<p>Let’s go ahead and deploy this:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">$ serverless deploy</code></pre></div>
<h2>3. <a name="elasticsearch-geomappings"></a>Elasticsearch Geo Mappings</h2>
<p>Elasticsearch supports two types of geo data: <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-point.html"><code class="language-text">geo_point</code> fields</a> which support lat/lon pairs, and <code class="language-text">geo_shape</code> fields which support points, lines, circles, polygons, multi-polygons etc.</p>
<p>To keep things simple, we’re going to use <code class="language-text">geo_point</code> fields to create a <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-geo-distance-query.html">geo distance query</a>. This will enable us to find places by distance from a central point.</p>
<p>In order to be able to use <code class="language-text">geo_point</code> fields, we need to set up a mapping in elasticsearch. We’re going to create a Lambda function to do this.</p>
<p>We’ll use a library I wrote just for this purpose, <a href="https://github.com/techjacker/elasticsearchquery">elasticsearchquery</a>. It allows us to specify a JSON document containing our query to be invoked against an Elasticsearch deployment. The library takes care of <a href="https://docs.aws.amazon.com/general/latest/gr/signature-version-4.html">signing the requests</a>, which is required in order to query AWS Elasticsearch instances.</p>
<p>In order to instruct <code class="language-text">serverless</code> to install the library when it packages the Lambda function, we’ll need to create a <code class="language-text">requirements.txt</code> file listing our dependency:</p>
<div class="gatsby-highlight" data-language="ini"><pre class="language-ini"><code class="language-ini"><span class="token comment"># requirements.txt</span>
elasticsearchquery</code></pre></div>
<p>We’ll also need to install the <code class="language-text">serverless-python-requirements</code> plugin:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">$ <span class="token function">npm</span> <span class="token function">install</span> --dev serverless-python-requirements</code></pre></div>
<p>Now we’re ready to create our Elasticsearch mapping. Create a JSON document named <code class="language-text">location_geopoint_mapping.json</code> containing the query needed to create our geo mapping:</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"_doc"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"location"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"geo_point"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Then, create the Lambda function to trigger this query. Create a file at <code class="language-text">handlers/elasticsearch_geomapping.py</code> with the following contents:</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">from</span> elasticsearchquery <span class="token keyword">import</span> ElasticSearchQuery


<span class="token keyword">def</span> <span class="token function">handler</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">:</span>
    esQuery <span class="token operator">=</span> ElasticSearchQuery<span class="token punctuation">(</span>
        es_endpoint<span class="token operator">=</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'ES_ENDPOINT'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        index_name<span class="token operator">=</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'ES_INDEX'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        query_file<span class="token operator">=</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'ES_GEO_MAPPING_FILE'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        region<span class="token operator">=</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'ES_REGION'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    esQuery<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div>
<p>As you can see, we need to supply our Lambda function some parameters so that it knows the location of the Elaticsearch query JSON and the URL of the Elasticsearch deployment. We’ll need to update our serverless config file to supply these, and also to create the required permissions for the Lambda function to access the cluster.</p>
<p>Add the following to <code class="language-text">serverless.yml</code>:</p>
<div class="gatsby-highlight has-highlighted-lines" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">service</span><span class="token punctuation">:</span> appsync<span class="token punctuation">-</span>placesearch

<span class="token key atrule">frameworkVersion</span><span class="token punctuation">:</span> <span class="token string">">=1.21.0 &lt;2.0.0"</span>

<span class="gatsby-highlight-code-line"><span class="token key atrule">plugins</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">-</span> serverless<span class="token punctuation">-</span>python<span class="token punctuation">-</span>requirements</span>
<span class="token key atrule">provider</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> aws
  <span class="token key atrule">region</span><span class="token punctuation">:</span> eu<span class="token punctuation">-</span>west<span class="token punctuation">-</span><span class="token number">1</span>
<span class="gatsby-highlight-code-line">  <span class="token key atrule">runtime</span><span class="token punctuation">:</span> python3.6</span>
<span class="token key atrule">custom</span><span class="token punctuation">:</span>
  <span class="token key atrule">esDomainName</span><span class="token punctuation">:</span> placesearch
  <span class="token key atrule">esRoleName</span><span class="token punctuation">:</span> AppSyncServiceRole
<span class="gatsby-highlight-code-line">  <span class="token key atrule">esGeoIndex</span><span class="token punctuation">:</span> places</span><span class="gatsby-highlight-code-line">  <span class="token key atrule">esRegion</span><span class="token punctuation">:</span> eu<span class="token punctuation">-</span>west<span class="token punctuation">-</span><span class="token number">1</span></span><span class="gatsby-highlight-code-line">  <span class="token key atrule">esGeoMappingFile</span><span class="token punctuation">:</span> location_geopoint_mapping.json</span><span class="gatsby-highlight-code-line">  <span class="token key atrule">pythonRequirements</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">    <span class="token key atrule">dockerizePip</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="gatsby-highlight-code-line"><span class="token key atrule">functions</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">  <span class="token key atrule">elasticsearchGeoMapping</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">    <span class="token key atrule">handler</span><span class="token punctuation">:</span> handlers/elasticsearch_geomapping.handler</span><span class="gatsby-highlight-code-line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> elasticsearchGeoMapping</span><span class="gatsby-highlight-code-line">    <span class="token key atrule">description</span><span class="token punctuation">:</span> Creates geo mapping in Elasticsearch</span><span class="gatsby-highlight-code-line">    <span class="token key atrule">role</span><span class="token punctuation">:</span> esGeoLambdaServiceRole</span><span class="gatsby-highlight-code-line">    <span class="token key atrule">environment</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">      <span class="token key atrule">ES_ENDPOINT</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>self<span class="token punctuation">:</span>custom.esEndpoint<span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      <span class="token key atrule">ES_INDEX</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>self<span class="token punctuation">:</span>custom.esGeoIndex<span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      <span class="token key atrule">ES_GEO_MAPPING_FILE</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>self<span class="token punctuation">:</span>custom.esGeoMappingFile<span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      <span class="token key atrule">ES_REGION</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>self<span class="token punctuation">:</span>custom.esRegion<span class="token punctuation">}</span></span>
<span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token key atrule">Resources</span><span class="token punctuation">:</span>
<span class="gatsby-highlight-code-line">    <span class="token comment"># elkasticsearch resources omitted for brevity...</span></span><span class="gatsby-highlight-code-line">    <span class="token key atrule">esGeoLambdaServiceRole</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">      <span class="token key atrule">Type</span><span class="token punctuation">:</span> AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>IAM<span class="token punctuation">:</span><span class="token punctuation">:</span>Role</span><span class="gatsby-highlight-code-line">      <span class="token key atrule">Properties</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        <span class="token key atrule">RoleName</span><span class="token punctuation">:</span> esGeoLambdaServiceRole</span><span class="gatsby-highlight-code-line">        <span class="token key atrule">AssumeRolePolicyDocument</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">          <span class="token key atrule">Statement</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">            <span class="token punctuation">-</span> <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow</span><span class="gatsby-highlight-code-line">              <span class="token key atrule">Principal</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">                <span class="token key atrule">Service</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">                  <span class="token punctuation">-</span> lambda.amazonaws.com</span><span class="gatsby-highlight-code-line">              <span class="token key atrule">Action</span><span class="token punctuation">:</span> sts<span class="token punctuation">:</span>AssumeRole</span><span class="gatsby-highlight-code-line">        <span class="token key atrule">Policies</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">          <span class="token punctuation">-</span> <span class="token key atrule">PolicyName</span><span class="token punctuation">:</span> esGeoLambdaServiceRolePolicy</span><span class="gatsby-highlight-code-line">            <span class="token key atrule">PolicyDocument</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">              <span class="token key atrule">Version</span><span class="token punctuation">:</span> <span class="token string">"2012-10-17"</span></span><span class="gatsby-highlight-code-line">              <span class="token key atrule">Statement</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">                <span class="token punctuation">-</span> <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow</span><span class="gatsby-highlight-code-line">                  <span class="token key atrule">Action</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">                    <span class="token punctuation">-</span> logs<span class="token punctuation">:</span>CreateLogGroup</span><span class="gatsby-highlight-code-line">                    <span class="token punctuation">-</span> logs<span class="token punctuation">:</span>CreateLogStream</span><span class="gatsby-highlight-code-line">                    <span class="token punctuation">-</span> logs<span class="token punctuation">:</span>PutLogEvents</span><span class="gatsby-highlight-code-line">                  <span class="token key atrule">Resource</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">                    <span class="token punctuation">-</span> <span class="token key atrule">'Fn::Join'</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">                        <span class="token punctuation">-</span> <span class="token string">':'</span></span><span class="gatsby-highlight-code-line">                        <span class="token punctuation">-</span></span><span class="gatsby-highlight-code-line">                          <span class="token punctuation">-</span> <span class="token string">'arn:aws:logs'</span></span><span class="gatsby-highlight-code-line">                          <span class="token punctuation">-</span> <span class="token key atrule">Ref</span><span class="token punctuation">:</span> <span class="token string">'AWS::Region'</span></span><span class="gatsby-highlight-code-line">                          <span class="token punctuation">-</span> <span class="token key atrule">Ref</span><span class="token punctuation">:</span> <span class="token string">'AWS::AccountId'</span></span><span class="gatsby-highlight-code-line">                          <span class="token punctuation">-</span> <span class="token string">'log-group~:/aws/lambda/*:*:*'</span></span><span class="gatsby-highlight-code-line">                <span class="token punctuation">-</span> <span class="token key atrule">Effect</span><span class="token punctuation">:</span> <span class="token string">"Allow"</span></span><span class="gatsby-highlight-code-line">                  <span class="token key atrule">Action</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">                    <span class="token punctuation">-</span> <span class="token string">"es:*"</span></span><span class="gatsby-highlight-code-line">                  <span class="token key atrule">Resource</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">                    <span class="token punctuation">-</span> <span class="token key atrule">'Fn::Join'</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">                        <span class="token punctuation">-</span> <span class="token string">''</span></span><span class="gatsby-highlight-code-line">                        <span class="token punctuation">-</span></span><span class="gatsby-highlight-code-line">                          <span class="token punctuation">-</span> <span class="token string">'arn:aws:es:'</span></span><span class="gatsby-highlight-code-line">                          <span class="token punctuation">-</span> <span class="token key atrule">Ref</span><span class="token punctuation">:</span> <span class="token string">'AWS::Region'</span></span><span class="gatsby-highlight-code-line">                          <span class="token punctuation">-</span> <span class="token string">':'</span></span><span class="gatsby-highlight-code-line">                          <span class="token punctuation">-</span> <span class="token key atrule">Ref</span><span class="token punctuation">:</span> <span class="token string">'AWS::AccountId'</span></span><span class="gatsby-highlight-code-line">                          <span class="token punctuation">-</span> <span class="token string">':domain/'</span></span><span class="gatsby-highlight-code-line">                          <span class="token punctuation">-</span> <span class="token string">"${self:custom.esDomainName}"</span></span><span class="gatsby-highlight-code-line">                          <span class="token punctuation">-</span> <span class="token string">'/*'</span></span></code></pre></div>
<p>Ideally, we would trigger this with our CI tool as part of the deployment process, but in our case we will just invoke the Lambda function manually:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">$ serverless invoke -f elasticsearchGeoMapping -l</code></pre></div>
<p>If your command did not emit any errors, then your mappings should have been set up successfully and your Elasticsearch cluster is now ready to accept geo queries!</p>
<h2>4. <a name="graphql-schema"></a>Define GraphQL Schema for API</h2>
<p>Let’s set up our API.</p>
<p>First, we’ll define our GraphQL schema. Go ahead and create a file called <code class="language-text">schema.graphql</code>:</p>
<div class="gatsby-highlight" data-language="graphql"><pre class="language-graphql"><code class="language-graphql"><span class="token keyword">type</span> <span class="token class-name">Mutation</span> <span class="token punctuation">{</span>
  <span class="token attr-name">createPlace</span><span class="token punctuation">(</span><span class="token attr-name">input</span><span class="token punctuation">:</span> CreatePlaceInput<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Place
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token class-name">Query</span> <span class="token punctuation">{</span>
  <span class="token attr-name">searchPlaceByLatLng</span><span class="token punctuation">(</span><span class="token attr-name">lat</span><span class="token punctuation">:</span>Float<span class="token operator">!</span><span class="token punctuation">,</span> <span class="token attr-name">lng</span><span class="token punctuation">:</span>Float<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token punctuation">[</span>Place<span class="token punctuation">]</span><span class="token operator">!</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token class-name">Place</span> <span class="token punctuation">{</span>
  <span class="token attr-name">name</span><span class="token punctuation">:</span> String<span class="token operator">!</span>
  <span class="token attr-name">price</span><span class="token punctuation">:</span> Float<span class="token operator">!</span>
  <span class="token attr-name">lat</span><span class="token punctuation">:</span> Float<span class="token operator">!</span>
  <span class="token attr-name">lng</span><span class="token punctuation">:</span> Float<span class="token operator">!</span>
<span class="token punctuation">}</span>

<span class="token keyword">input</span> CreatePlaceInput <span class="token punctuation">{</span>
  <span class="token attr-name">name</span><span class="token punctuation">:</span> String<span class="token operator">!</span>
  <span class="token attr-name">price</span><span class="token punctuation">:</span> Float<span class="token operator">!</span>
  <span class="token attr-name">lat</span><span class="token punctuation">:</span> Float<span class="token operator">!</span>
  <span class="token attr-name">lng</span><span class="token punctuation">:</span> Float<span class="token operator">!</span>
<span class="token punctuation">}</span>

<span class="token keyword">schema</span> <span class="token punctuation">{</span>
  <span class="token attr-name">query</span><span class="token punctuation">:</span> Query
  <span class="token attr-name">mutation</span><span class="token punctuation">:</span> Mutation
<span class="token punctuation">}</span></code></pre></div>
<p>We’re defining the bare minimum in order to enable us to create places via the <code class="language-text">createPlace</code> mutation, and then search for them by location using the <code class="language-text">searchPlaceByLatLng</code> query method.</p>
<h2>5. <a name="es-mapping-templates"></a>Appsync Mapping Template GraphQL Resolvers</h2>
<p>We have our schema defined, and now we need to add resolvers for it. If you’re expecting to need to write a Lambda function to interact with Elasticsearch in order to do this, then you’d be wrong!</p>
<p>AppSync introduces the concept of <a href="https://docs.aws.amazon.com/appsync/latest/devguide/resolver-mapping-template-reference-overview.html">mapping templates</a>, which removes this need. Instead, the templates translate the request and response into JSON payloads that your backing database and client will accept. Currently, only DynamoDB and Elasticsearch are natively supported, but in the future I’m sure we’ll see support for SQL databases too.</p>
<p>Let’s create a directory to house our mapping templates:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">$ <span class="token function">mkdir</span> mapping-templates</code></pre></div>
<p>Then, let’s create the request template for our <code class="language-text">createPlace</code> query in a file called <code class="language-text">mapping-templates/createPlace-request-mapping-template.txt</code>. This is going to relay the query on to Elasticsearch for us in the format it expects. It’s written in <a href="http://velocity.apache.org/engine/2.0/vtl-reference.html">Apache Velocity Template Language (VTL)</a>, which is what Appsync uses as it’s templating language:</p>
<div class="gatsby-highlight" data-language="vtl"><pre class="language-vtl"><code class="language-vtl">{
    &quot;version&quot;:&quot;2017-02-28&quot;,
    &quot;operation&quot;:&quot;PUT&quot;,
    &quot;path&quot;:&quot;/places/_doc/$util.autoId()&quot;,
    &quot;params&quot;:{
        &quot;body&quot;: {
        &quot;name&quot;: &quot;$context.arguments.input.name&quot;,
        &quot;price&quot;: $context.arguments.input.price,
        &quot;location&quot;: {
            &quot;lat&quot;: $context.arguments.input.lat,
            &quot;lon&quot;: $context.arguments.input.lng
        }
      }
    }
}</code></pre></div>
<p>As you can see, we access the arguments through the <a href="https://docs.aws.amazon.com/appsync/latest/devguide/resolver-context-reference.html">$context variable</a>, which Appsync supplies to our template. As we want to create the resource, we use a <code class="language-text">PUT</code> operation.</p>
<p>We also specify that we want the document created in our <code class="language-text">places</code> index via the <code class="language-text">path</code> property. See the <a href="https://docs.aws.amazon.com/appsync/latest/devguide/resolver-mapping-template-reference-elasticsearch.html">Elasticsearch mapping template reference</a> for the full list of supported fields. Finally, we are using a convenience method that AppSync supplies via the <a href="https://docs.aws.amazon.com/appsync/latest/devguide/resolver-context-reference.html#utility-helpers-in-util"><code class="language-text">$util</code> object</a> to automatically assign a unique <code class="language-text">id</code> to the document.</p>
<p>Let’s go ahead and create the response template to translate Elasticsearch’s response into the JSON response defined in our GraphQL schema. Create <code class="language-text">mapping-templates/createPlace-request-mapping-template.txt</code> with the following contents:</p>
<div class="gatsby-highlight" data-language="vtl"><pre class="language-vtl"><code class="language-vtl">$util.toJson({
  &quot;name&quot;: &quot;$context.result.get(&#39;_source&#39;)[&#39;name&#39;]&quot;,
  &quot;price&quot;: $context.result.get(&#39;_source&#39;)[&#39;price&#39;],
  &quot;lat&quot;: $context.result.get(&#39;_source&#39;)[&#39;location&#39;][&#39;lat&#39;],
  &quot;lng&quot;: $context.result.get(&#39;_source&#39;)[&#39;location&#39;][&#39;lon&#39;]
})</code></pre></div>
<p>We use the <a href="https://docs.aws.amazon.com/appsync/latest/devguide/resolver-context-reference.html">$context variable</a> again, but this time it has been decorated with the response from Elasticsearch.</p>
<p>That’s all the code we need in order to create an item in our database, but what about querying it? To be able to search for items by location, we’ll create another set of templates to resolve the <code class="language-text">searchPlaceByLatLng</code> query.</p>
<p>Let’s with the request mapping template by creating a file at <code class="language-text">mapping-templates/searchPlaceByLatLng-request-mapping-template.txt</code>:</p>
<div class="gatsby-highlight" data-language="vtl"><pre class="language-vtl"><code class="language-vtl">{
  &quot;version&quot;: &quot;2017-02-28&quot;,
  &quot;operation&quot;: &quot;GET&quot;,
  &quot;path&quot;: &quot;/places/_search&quot;,
  &quot;params&quot;: {
    &quot;body&quot;: {
      &quot;query&quot;: {
        &quot;bool&quot;: {
          &quot;must&quot;: {
            &quot;match_all&quot;: {}
          },
          &quot;filter&quot;: {
            &quot;geo_distance&quot;: {
              &quot;distance&quot;: &quot;10km&quot;,
              &quot;location&quot;: {
                &quot;lat&quot;: $context.arguments.lat,
                &quot;lon&quot;: $context.arguments.lng,
              }
            }
          }
        }
      }
    }
  }
}</code></pre></div>
<p>Here, we are specifying the index to search against via the <code class="language-text">path</code> property. It is a <code class="language-text">GET</code> operation as we just want to query existing items. We then run the search for places within 10km of our specified loccation using a <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-geo-distance-query.html"><code class="language-text">geo_distance</code></a> Elasticsearch query.</p>
<p>Now, let’s create our response mapping template at <code class="language-text">mapping-templates/searchPlaceByLatLng-response-mapping-template.txt</code>:</p>
<div class="gatsby-highlight" data-language="vtl"><pre class="language-vtl"><code class="language-vtl">[
  #foreach($entry in $context.result.hits.hits)
    ## $velocityCount starts at 1 and increments with the #foreach loop **
    #if( $velocityCount &gt; 1 ) , #end
    $util.toJson({
      &quot;name&quot; : &quot;$entry.get(&#39;_source&#39;)[&#39;name&#39;]&quot;,
      &quot;lat&quot; : $entry.get(&#39;_source&#39;)[&#39;location&#39;][&#39;lat&#39;],
      &quot;lng&quot;: $entry.get(&#39;_source&#39;)[&#39;location&#39;][&#39;lon&#39;],
      &quot;price&quot;: $entry.get(&#39;_source&#39;)[&#39;price&#39;],
      &quot;id&quot;: &quot;$entry.get(&#39;_id&#39;)&quot;
    })
  #end
]</code></pre></div>
<p>We loop through the list of results using a VTL <code class="language-text">foreach</code> statement, and create a JSON object in the format specified in our GraphQL schema. We have a small bit of extra logic to ensure that we don’t end the list with a trailing comma; this ensures we return valid JSON in the response to the client.</p>
<p>That’s the end of the backend code we need to write!</p>
<h2>6. <a name="deploy-api"></a>Deploy the GraphQL AppSync API</h2>
<p>We need to update our serverless config to provision our GraphQL API. In order to do this, we’re going to use the <a href="https://github.com/sid88in/serverless-appsync-plugin">Serverless-AppSync-Plugin</a>.</p>
<p>Install it with <code class="language-text">npm</code>:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">$ <span class="token function">npm</span> <span class="token function">install</span> --dev serverless-appsync-plugin</code></pre></div>
<p>Then, update your serverless.yml to include the following lines:</p>
<div class="gatsby-highlight has-highlighted-lines" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">service</span><span class="token punctuation">:</span> appsync<span class="token punctuation">-</span>placesearch

<span class="token key atrule">frameworkVersion</span><span class="token punctuation">:</span> <span class="token string">">=1.21.0 &lt;2.0.0"</span>

<span class="token key atrule">plugins</span><span class="token punctuation">:</span>
<span class="gatsby-highlight-code-line">  <span class="token punctuation">-</span> serverless<span class="token punctuation">-</span>appsync<span class="token punctuation">-</span>plugin</span>  <span class="token punctuation">-</span> serverless<span class="token punctuation">-</span>python<span class="token punctuation">-</span>requirements

<span class="token key atrule">provider</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> aws
  <span class="token key atrule">region</span><span class="token punctuation">:</span> eu<span class="token punctuation">-</span>west<span class="token punctuation">-</span><span class="token number">1</span>
  <span class="token key atrule">runtime</span><span class="token punctuation">:</span> python3.6

<span class="token key atrule">custom</span><span class="token punctuation">:</span>
<span class="gatsby-highlight-code-line">  <span class="token key atrule">awsAccountId</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>env<span class="token punctuation">:</span>AWS_ACCOUNT_ID<span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">  <span class="token key atrule">esEndpoint</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>env<span class="token punctuation">:</span>ES_ENDPOINT<span class="token punctuation">}</span></span>  <span class="token key atrule">esRegion</span><span class="token punctuation">:</span> eu<span class="token punctuation">-</span>west<span class="token punctuation">-</span><span class="token number">1</span>
  <span class="token key atrule">esGeoIndex</span><span class="token punctuation">:</span> places
  <span class="token key atrule">esGeoMappingFile</span><span class="token punctuation">:</span> elasticsearch/location_geopoint_mapping.json
  <span class="token key atrule">esDomainName</span><span class="token punctuation">:</span> placesearch
  <span class="token key atrule">esRoleName</span><span class="token punctuation">:</span> AppSyncServiceRole
  <span class="token key atrule">pythonRequirements</span><span class="token punctuation">:</span>
    <span class="token key atrule">dockerizePip</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="gatsby-highlight-code-line">  <span class="token key atrule">appSync</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> appSyncElasticsearchTest</span><span class="gatsby-highlight-code-line">    <span class="token key atrule">apiId</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>env<span class="token punctuation">:</span>APPSYNC_API_ID<span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">    <span class="token key atrule">apiKey</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>env<span class="token punctuation">:</span>APPSYNC_API_KEY<span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">    <span class="token key atrule">authenticationType</span><span class="token punctuation">:</span> API_KEY</span><span class="gatsby-highlight-code-line">    <span class="token key atrule">mappingTemplatesLocation</span><span class="token punctuation">:</span> mapping<span class="token punctuation">-</span>templates</span><span class="gatsby-highlight-code-line">    <span class="token key atrule">mappingTemplates</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">-</span> <span class="token key atrule">dataSource</span><span class="token punctuation">:</span> esInstance</span><span class="gatsby-highlight-code-line">        <span class="token key atrule">type</span><span class="token punctuation">:</span> Query</span><span class="gatsby-highlight-code-line">        <span class="token key atrule">field</span><span class="token punctuation">:</span> searchPlaceByLatLng</span><span class="gatsby-highlight-code-line">        <span class="token key atrule">request</span><span class="token punctuation">:</span> searchPlaceByLatLng<span class="token punctuation">-</span>request<span class="token punctuation">-</span>mapping<span class="token punctuation">-</span>template.txt</span><span class="gatsby-highlight-code-line">        <span class="token key atrule">response</span><span class="token punctuation">:</span> searchPlaceByLatLng<span class="token punctuation">-</span>response<span class="token punctuation">-</span>mapping<span class="token punctuation">-</span>template.txt</span><span class="gatsby-highlight-code-line">      <span class="token punctuation">-</span> <span class="token key atrule">dataSource</span><span class="token punctuation">:</span> esInstance</span><span class="gatsby-highlight-code-line">        <span class="token key atrule">type</span><span class="token punctuation">:</span> Mutation</span><span class="gatsby-highlight-code-line">        <span class="token key atrule">field</span><span class="token punctuation">:</span> createPlace</span><span class="gatsby-highlight-code-line">        <span class="token key atrule">request</span><span class="token punctuation">:</span> createPlace<span class="token punctuation">-</span>request<span class="token punctuation">-</span>mapping<span class="token punctuation">-</span>template.txt</span><span class="gatsby-highlight-code-line">        <span class="token key atrule">response</span><span class="token punctuation">:</span> createPlace<span class="token punctuation">-</span>response<span class="token punctuation">-</span>mapping<span class="token punctuation">-</span>template.txt</span><span class="gatsby-highlight-code-line">    <span class="token key atrule">schema</span><span class="token punctuation">:</span> schema.graphql</span><span class="gatsby-highlight-code-line">    <span class="token key atrule">serviceRole</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>self<span class="token punctuation">:</span>custom.esRoleName<span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">    <span class="token key atrule">dataSources</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> AMAZON_ELASTICSEARCH</span><span class="gatsby-highlight-code-line">        <span class="token key atrule">name</span><span class="token punctuation">:</span> esInstance</span><span class="gatsby-highlight-code-line">        <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">'ElasticSearch'</span></span><span class="gatsby-highlight-code-line">        <span class="token key atrule">config</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">          <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>self<span class="token punctuation">:</span>custom.esEndpoint<span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">          <span class="token key atrule">serviceRoleArn</span><span class="token punctuation">:</span> arn<span class="token punctuation">:</span>aws<span class="token punctuation">:</span>iam<span class="token punctuation">:</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>self<span class="token punctuation">:</span>custom.awsAccountId<span class="token punctuation">}</span><span class="token punctuation">:</span>role/ElasticSearch<span class="token punctuation">-</span>$<span class="token punctuation">{</span>self<span class="token punctuation">:</span>custom.esRoleName<span class="token punctuation">}</span></span></code></pre></div>
<p>We add the Serverless-AppSync-Plugin to the <code class="language-text">custom</code> section, and tell it where to find the schema file and mapping templates we created earlier. We also specify the data source for the API (in our case, Elasticsearch), and the authentication type securing the API (in our case, we are using an API key which AWS will generate for us).</p>
<p>We then specify a couple of environment variables that the plugin requires, and the ID of the account where we created the Elasticsearch cluster earlier together with the endpoint URL. We will need to set the <code class="language-text">AWS_ACCOUNT_ID</code> variable in our environment along with <code class="language-text">ES_ENDPOINT</code> before running the command to deploy our GraphQL API. We can use the <code class="language-text">aws-cli</code> tools to dynamically populate the latter.</p>
<p>Create a file called <code class="language-text">.env</code> with the following contents, updating the <code class="language-text">AWS_ACCOUNT_ID</code> with the appropriate value:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell"><span class="token comment"># .env</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">AWS_ACCOUNT_ID</span><span class="token operator">=</span><span class="token number">123456789</span>

<span class="token builtin class-name">export</span> <span class="token assign-left variable">ES_DOMAIN</span><span class="token operator">=</span>placesearch
<span class="token assign-left variable">ENDPOINT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>aws es describe-elasticsearch-domain <span class="token punctuation">\</span>
  --domain-name $ES_DOMAIN <span class="token punctuation">\</span>
  --query <span class="token string">'DomainStatus.Endpoint'</span> <span class="token punctuation">\</span>
  --output text<span class="token variable">)</span></span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">ES_ENDPOINT</span><span class="token operator">=</span>https://<span class="token variable">$ENDPOINT</span></code></pre></div>
<p>Now, let’s surce our <code class="language-text">.env</code> file so the variables are present in our shell and then deploy our Appsync API:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">$ <span class="token builtin class-name">source</span> .env
$ appsync deploy-appsync</code></pre></div>
<p>Voila! We now have our GraphQL API fully deployed. Let’s log in to the AWS console and run some queries against it.</p>
<p>To start off, how about we create a place in Australia:</p>
<div class="gatsby-highlight" data-language="graphql"><pre class="language-graphql"><code class="language-graphql"><span class="token keyword">mutation</span> CreatePlace <span class="token punctuation">{</span>
  createPlace<span class="token punctuation">(</span><span class="token attr-name">input</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token attr-name">lat</span><span class="token punctuation">:</span> <span class="token number">-25.363</span><span class="token punctuation">,</span>
    <span class="token attr-name">lng</span><span class="token punctuation">:</span> <span class="token number">131.044</span><span class="token punctuation">,</span>
    <span class="token attr-name">name</span><span class="token punctuation">:</span> <span class="token string">"House in Australia"</span><span class="token punctuation">,</span>
    <span class="token attr-name">price</span><span class="token punctuation">:</span> <span class="token number">100.25</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    name
    price
    lat
    lng
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p><img src="https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/elasticsearch/graphql-mutation-createplace-australia.png" alt="Australia GraphQL Mutation" title="Australia GraphQL Mutation"></p>
<p>And another in London:</p>
<div class="gatsby-highlight" data-language="graphql"><pre class="language-graphql"><code class="language-graphql"><span class="token keyword">mutation</span> CreatePlace <span class="token punctuation">{</span>
  createPlace<span class="token punctuation">(</span><span class="token attr-name">input</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token attr-name">lat</span><span class="token punctuation">:</span> <span class="token number">51.6074</span><span class="token punctuation">,</span>
    <span class="token attr-name">lng</span><span class="token punctuation">:</span> <span class="token number">0.1378</span><span class="token punctuation">,</span>
    <span class="token attr-name">name</span><span class="token punctuation">:</span> <span class="token string">"House in London"</span><span class="token punctuation">,</span>
    <span class="token attr-name">price</span><span class="token punctuation">:</span> <span class="token number">200.25</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    name
    price
    lat
    lng
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p><img src="https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/elasticsearch/graphql-mutation-createplace-london.png" alt="London GraphQL Mutation" title="London GraphQL Mutation"></p>
<p>And then let’s search for places within 10km of London:</p>
<div class="gatsby-highlight" data-language="graphql"><pre class="language-graphql"><code class="language-graphql"><span class="token keyword">query</span> <span class="token punctuation">{</span>
  searchPlaceByLatLng<span class="token punctuation">(</span><span class="token attr-name">lat</span><span class="token punctuation">:</span> <span class="token number">51.5</span><span class="token punctuation">,</span> <span class="token attr-name">lng</span><span class="token punctuation">:</span> <span class="token number">0.12</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    name
    price
    lat
    lng
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p><img src="https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/elasticsearch/graphql-query-search-latlng.png" alt="London GraphQL LatLng Query" title="London GraphQL LatLng Query"></p>
<p>It only returns our London listing, so we can see our query is working just as we hoped!</p>
<h2>7. <a name="destroy"></a>Teardown</h2>
<p>We could easily add support for realtime updates to our API at this point, but we’ve already done a lot of work today. So let’s destroy our API and leave that for another tutorial.</p>
<p>In order to update or delete our API, we’ll need to feed our serverless config its <code class="language-text">apiId</code> and <code class="language-text">apiKey</code>. Let’s go ahead and add these to our <code class="language-text">serverless.yml</code> instructing it to pick them up via environment variables:</p>
<div class="gatsby-highlight has-highlighted-lines" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">service</span><span class="token punctuation">:</span> appsync<span class="token punctuation">-</span>placesearch

<span class="token key atrule">frameworkVersion</span><span class="token punctuation">:</span> <span class="token string">">=1.21.0 &lt;2.0.0"</span>

<span class="token key atrule">plugins</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> serverless<span class="token punctuation">-</span>appsync<span class="token punctuation">-</span>plugin
  <span class="token punctuation">-</span> serverless<span class="token punctuation">-</span>python<span class="token punctuation">-</span>requirements

<span class="token key atrule">provider</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> aws
  <span class="token key atrule">region</span><span class="token punctuation">:</span> eu<span class="token punctuation">-</span>west<span class="token punctuation">-</span><span class="token number">1</span>
  <span class="token key atrule">runtime</span><span class="token punctuation">:</span> python3.6

<span class="token key atrule">custom</span><span class="token punctuation">:</span>
  <span class="token key atrule">awsAccountId</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>env<span class="token punctuation">:</span>AWS_ACCOUNT_ID<span class="token punctuation">}</span>
  <span class="token key atrule">esEndpoint</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>env<span class="token punctuation">:</span>ES_ENDPOINT<span class="token punctuation">}</span>
  <span class="token key atrule">esGeoIndex</span><span class="token punctuation">:</span> places
  <span class="token key atrule">esRegion</span><span class="token punctuation">:</span> eu<span class="token punctuation">-</span>west<span class="token punctuation">-</span><span class="token number">1</span> <span class="token comment"># UPDATE ME</span>
  <span class="token key atrule">esGeoMappingFile</span><span class="token punctuation">:</span> elasticsearch/location_geopoint_mapping.json
  <span class="token key atrule">esDomainName</span><span class="token punctuation">:</span> placesearch
  <span class="token key atrule">esRoleName</span><span class="token punctuation">:</span> AppSyncServiceRole
  <span class="token key atrule">pythonRequirements</span><span class="token punctuation">:</span>
    <span class="token key atrule">dockerizePip</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">appSync</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> appSyncElasticsearchTest
<span class="gatsby-highlight-code-line">    <span class="token key atrule">apiId</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>env<span class="token punctuation">:</span>APPSYNC_API_ID<span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">    <span class="token key atrule">apiKey</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>env<span class="token punctuation">:</span>APPSYNC_API_KEY<span class="token punctuation">}</span></span>  <span class="token comment"># ...rest omitted for brevity</span></code></pre></div>
<p>Now, let’s add the following lines to our <code class="language-text">.env</code> file to dynamically populate these:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell"><span class="token comment"># .env</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">ES_DOMAIN</span><span class="token operator">=</span>placesearch
<span class="token builtin class-name">export</span> <span class="token assign-left variable">AWS_ACCOUNT_ID</span><span class="token operator">=</span><span class="token number">863589972288</span>
<span class="token assign-left variable">ENDPOINT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>aws es describe-elasticsearch-domain <span class="token punctuation">\</span>
  --domain-name $ES_DOMAIN <span class="token punctuation">\</span>
  --query <span class="token string">'DomainStatus.Endpoint'</span> <span class="token punctuation">\</span>
  --output text<span class="token variable">)</span></span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">ES_ENDPOINT</span><span class="token operator">=</span>https://<span class="token variable">$ENDPOINT</span>

<span class="token builtin class-name">export</span> <span class="token assign-left variable">APPSYNC_API_ID</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>aws appsync list-graphql-apis <span class="token punctuation">\</span>
  --query <span class="token string">'graphqlApis[?name==<span class="token variable"><span class="token variable">`</span>appSyncElasticsearchTest<span class="token variable">`</span></span>].apiId'</span> <span class="token punctuation">\</span>
   --output text<span class="token variable">)</span></span>

<span class="token builtin class-name">export</span> <span class="token assign-left variable">APPSYNC_API_KEY</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>aws appsync list-api-keys <span class="token punctuation">\</span>
  --api-id <span class="token string">"<span class="token variable">$APPSYNC_API_ID</span>"</span> <span class="token punctuation">\</span>
  --query <span class="token string">'apiKeys[0].id'</span> <span class="token punctuation">\</span>
   --output text<span class="token variable">)</span></span></code></pre></div>
<p>And with that, we can destroy our API:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">$ <span class="token builtin class-name">source</span> .env
$ serverless delete-appsync
$ serverless remove</code></pre></div>
<h2>Wrap-up</h2>
<p>We created a serverless GraphQL API. We got that API to handle an AirBnB-style geo search using Elasticsearch and AppSync. Not bad!</p>
<p>The
<a href="https://github.com/techjacker/appsync-elasticsearch-geosearch">full source code</a> for this tutorial is available on github, so feel free to check it out!</p>
<p>My name is Andrew Griffiths, and <a href="https://andrewgriffithsonline.com">here’s where you can find me</a> on the web.</p></section><hr style="margin-bottom:1.75rem"/><footer><div style="display:flex;margin-bottom:4.375rem"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden;display:inline-block;width:50px;height:50px;margin-right:0.875rem;margin-bottom:0;min-width:50px;border-radius:100%"><img aria-hidden="true" src="data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGQABAQADAQAAAAAAAAAAAAAAAAUBAgME/8QAFwEBAAMAAAAAAAAAAAAAAAAAAgABA//aAAwDAQACEAMQAAABtTuWpVlGVPBk0HAFf//EABsQAAICAwEAAAAAAAAAAAAAAAECAxMAESMk/9oACAEBAAEFAnOlgZ7cvIZnEYuxj6ZjxjOh/8QAGBEAAgMAAAAAAAAAAAAAAAAAAAEQEiH/2gAIAQMBAT8BwqOP/8QAGREAAQUAAAAAAAAAAAAAAAAAAAEQEiEx/9oACAECAQE/AbJCY3//xAAgEAABAgUFAAAAAAAAAAAAAAABABECAxASITFBYYGR/9oACAEBAAY/Ai2qYx3A0tPifYlsLBBT8qX3T//EABoQAQADAQEBAAAAAAAAAAAAAAEAESExQVH/2gAIAQEAAT8hRVcZF9KXnJkRaRWsbCd3oQNMD6x1eoRshVw76T//2gAMAwEAAgADAAAAENvoAP/EABkRAAIDAQAAAAAAAAAAAAAAAAABESExUf/aAAgBAwEBPxCEpsj00xYf/8QAGhEAAgIDAAAAAAAAAAAAAAAAAAEQESExUf/aAAgBAgEBPxBNs0X5A9n/xAAeEAEBAQACAQUAAAAAAAAAAAABEQAhMUFRYXGBkf/aAAgBAQABPxClwdnV0whQo4lO/wAzyyrjkGw+cZbkILxecbfXBH7zSeBntAmta2n5uEBbXZ4N/9k=" alt="Kyle Mathews" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms;border-radius:50%"/><noscript><picture><source srcset="/lumen/static/4f27694bd7811d13157e5e488ad64f43/99438/profile-pic.jpg 1x,
/lumen/static/4f27694bd7811d13157e5e488ad64f43/aba1d/profile-pic.jpg 1.5x,
/lumen/static/4f27694bd7811d13157e5e488ad64f43/b315d/profile-pic.jpg 2x" /><img loading="lazy" width="50" height="50" srcset="/lumen/static/4f27694bd7811d13157e5e488ad64f43/99438/profile-pic.jpg 1x,
/lumen/static/4f27694bd7811d13157e5e488ad64f43/aba1d/profile-pic.jpg 1.5x,
/lumen/static/4f27694bd7811d13157e5e488ad64f43/b315d/profile-pic.jpg 2x" src="/lumen/static/4f27694bd7811d13157e5e488ad64f43/99438/profile-pic.jpg" alt="Kyle Mathews" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div><p>Written by <strong>Kyle Mathews</strong> <!-- -->who lives and works in San Francisco building useful things.<!-- --> <a href="https://twitter.com/kylemathews">You should follow him on Twitter</a></p></div></footer></article><nav><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" href="/lumen/posts/2018-06-04-how-write-first-serverless-component/">← <!-- -->How to write your first Serverless Component</a></li><li><a rel="next" href="/lumen/posts/2018-06-13-giving-back-community-teen-tech-coding-workshop/">Giving back to the community with a TeenTech coding workshop<!-- --> →</a></li></ul></nav></main><footer>© <!-- -->2020<!-- -->, Built with<!-- --> <a href="https://www.gatsbyjs.org">Gatsby</a></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/posts/2018-06-06-build-geosearch-graphql-api-aws-appsync-elasticsearch/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-36e457a5393b79b99515.js"],"component---src-pages-404-js":["/component---src-pages-404-js-9578b926700cf49bb4fc.js"],"component---src-pages-index-js":["/component---src-pages-index-js-753a3f9bde0636fce206.js"],"component---src-pages-using-typescript-tsx":["/component---src-pages-using-typescript-tsx-f16d60f62c7d2b3e9bcc.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-e4c781a4720974cc2679.js"]};/*]]>*/</script><script src="/lumen/component---src-templates-blog-post-js-e4c781a4720974cc2679.js" async=""></script><script src="/lumen/cd7d5f864fc9e15ed8adef086269b0aeff617554-c8f68cb3ade1320f5257.js" async=""></script><script src="/lumen/commons-4c36ffabef1434ec1126.js" async=""></script><script src="/lumen/app-36e457a5393b79b99515.js" async=""></script><script src="/lumen/styles-cd63080e784be7b7e7cf.js" async=""></script><script src="/lumen/framework-5fc6169171e885c3b522.js" async=""></script><script src="/lumen/webpack-runtime-c76c0c9d42bc9bf56761.js" async=""></script></body></html>