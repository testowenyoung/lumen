{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/2018-12-21-api-gateway-websockets-example/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"20997548-4eb8-5766-82c7-f118b089c807","excerpt":"Update: As of v1.38, the Serverless Framework supports WebSockets in core. No need for a plugin! Read the announcement and how-to here. As we approach the end…","html":"<p><strong>Update:</strong> As of v1.38, the Serverless Framework supports WebSockets in core. No need for a plugin! <a href=\"https://serverless.com/blog/api-gateway-websockets-support\">Read the announcement and how-to here.</a></p>\n<p>As we approach the end of 2018, I’m incredibly excited to announce that we at Serverless have a small gift for you: You can work with Amazon API Gateway WebSockets in your Serverless Framework applications starting <em>right now</em>.</p>\n<p>But before we dive into the how-to, there are some interesting caveats that I want you to be aware of.</p>\n<p>First, this is <em>not</em> supported in AWS CloudFormation just yet, though AWS has publicly stated it will be early next year! As such, we decided to implement our initial support as a plugin and keep it out of core until the official AWS CloudFormation support is added.</p>\n<p>Second, the configuration syntax should be pretty close, but we make no promises that anything implemented with this will carry forward after core support. And once core support is added with AWS CloudFormation, you will need to recreate your API Gateway resources managed by CloudFormation. This means that any clients using your WebSocket application would need to be repointed, or other DNS would have needed to be in place, to facilitate the cutover.</p>\n<p>I recommend you check out <a href=\"https://serverless.com/blog/api-gateway-websockets-support/\">my original post</a> for a basic understanding of how WebSockets works at a technical level via connections and callbacks to the Amazon API Gateway connections management API.</p>\n<p>With all that out of the way, play with our new presents!</p>\n<h4>How it works—we kept it familiar</h4>\n<p>Integrating a WebSocket API in your serverless app will feel like second nature if you’re already using our <code class=\"language-text\">http</code> events.</p>\n<p>A simple application might look something like the following <code class=\"language-text\">serverless.yml</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token key atrule\">stage</span><span class=\"token punctuation\">:</span> dev\n  <span class=\"token key atrule\">websocketApiRouteSelectionExpression</span><span class=\"token punctuation\">:</span> $request.body.action\n\n<span class=\"token key atrule\">plugins</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> serverless<span class=\"token punctuation\">-</span>websockets<span class=\"token punctuation\">-</span>plugin\n\n<span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">connectionHandler</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> src/handler.handler\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">websocket</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">routeKey</span><span class=\"token punctuation\">:</span> $connect\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">websocket</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">routeKey</span><span class=\"token punctuation\">:</span> $disconnect\n  <span class=\"token key atrule\">defaultHandler</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">websocket</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">routeKey</span><span class=\"token punctuation\">:</span> $default\n  <span class=\"token key atrule\">actionHandler</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">websocket</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">routeKey</span><span class=\"token punctuation\">:</span> myAction</code></pre></div>\n<p>To get started from scratch, you’ll need to create your serverless project: <code class=\"language-text\">sls create --template aws-nodejs</code>. Go ahead and <code class=\"language-text\">npm install --save serverless-websockets-plugin</code>, and then add the plugin to your <code class=\"language-text\">serverless.yml</code> plugins listing:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">plugins</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> serverless<span class=\"token punctuation\">-</span>websockets<span class=\"token punctuation\">-</span>plugin</code></pre></div>\n<p>Check the <a href=\"https://github.com/serverless/serverless-websockets-plugin\">plugin docs</a> for more about configuration of the plugin and related events.</p>\n<h4>The “hello world” of WebSocket apps</h4>\n<p>No release of anything using WebSockets would be complete without an example app, so we put one together. And it just so happens to be a massively scalable, serverless chat app.</p>\n<p>We’re leveraging the usual suspects here: API Gateway WebSockets (of course), AWS Lambda, DynamoDB, and—perhaps the most interesting piece of this entire thing—we’ll talk about DynamoDB streams.</p>\n<h5>Chat app architecture</h5>\n<img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/websockets/connection-management.png\" alt=\"connection management diagram\">\n<p>As users connect and disconnect, we store their connection Id in the DynamoDB table, as well as register them into the “General” chat channel.</p>\n<p>Users can then:</p>\n<ul>\n<li>Subscribe to a channel (the first subscription creates the channel)</li>\n<li>Unsubscribe from a channel</li>\n<li>Send a message to all users in a channel</li>\n</ul>\n<img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/websockets/send-message.png\" alt=\"send channel a message diagram\">\n<p>Each time any of these things occurs, we send out a broadcast to all subscribers of a channel what has happened. If someone joined the channel, left (or disconnected and left all channels), or a message was sent.</p>\n<p>When a user disconnects, we use the “disconnect” message from API Gateway to delete all the connection subscriptions so we don’t waste cycles trying to send messages to dead connections.</p>\n<p>When a user sends a message via the WebSockets, we look up all the subscriptions and their connection Id’s from the DynamoDB table, and send them a message over their corresponding WebSocket with the content and other information—straightforward behavior, and similar to what you would expect for WebSockets.</p>\n<h5>Why DynamoDB streams?</h5>\n<p>So, what are we leveraging DynamoDB streams for you ask?</p>\n<p>We decided to think about things a bit differently to demonstrate the power of this architecture. When a user unsubscribes or subscribes to a channel, we don’t <em>immediately</em> notify everyone in the same Lambda invocation. Rather, we have AWS Lambda receive that stream and process it asynchronously.</p>\n<img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/websockets/channel-subscriber.png\" alt=\"channel subscriber flow diagram\">\n<p>It still happens extremely fast, and to all WebSocket clients, it appears no different.</p>\n<p>The real power of this approach is: say you have sub-services or systems running that want to send messages, or ban users. Those subsystems don’t need to care about the implementation of the WebSocket system; they simply work with the DynamoDB table and can create, update and delete subscriptions, send bot messages, etc. Those changes flow through the exact same pattern as if they were issued via WebSocket clients themselves.</p>\n<p>I think this is a pretty neat concept, and I am curious to see what folks build with it!</p>\n<h4>A couple notes about WebSockets and the ApiGatewayManagementApi</h4>\n<p>You cannot send messages back the typical way as an HTTP response payload you may be used to with API Gateway HTTP. Just return back a statusCode (ex: 200) property in your payload to tell API Gateway everything is good, but it will not send that to the client. If there are errors like a 500, those <em>will</em> go to the client.</p>\n<p>You cannot send a WebSocket message via the Management API in the <code class=\"language-text\">$connect</code> route, that needs to succeed before the socket connection will allow messages to flow. You will get a <code class=\"language-text\">410</code> code meaning the connection is “Gone” (or doesn’t exist yet.).</p>\n<p>For some psuedo-code, it would look something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> success <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  statusCode<span class=\"token operator\">:</span> <span class=\"token number\">200</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">connectionHandler</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">event<span class=\"token punctuation\">,</span> context</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">await</span> <span class=\"token function\">saveConnectionInfoToDynamoDB</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>requestContext<span class=\"token punctuation\">.</span>connectionId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> success<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// if we would try to post to the websocket management api here, we would get a 410</span>\n  <span class=\"token comment\">// we must first \"successfully\" execute this connection handler to establish the WebSocket</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// assume there is other logic and processes that save \"channel\" subscriptions for each</span>\n<span class=\"token comment\">// subscriber, along with their connectionId information</span>\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">messageHandler</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">event<span class=\"token punctuation\">,</span> context</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> payload <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// fetch anyone subscribed to a channel defined in payload for a datastore</span>\n  <span class=\"token keyword\">const</span> subscribers <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetchSubscribersToChannel</span><span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">.</span>channelId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// for each subscriber to the channel, we have to send a message per connection</span>\n  <span class=\"token comment\">// (no batch, one call to Api Gateway Management API per message)</span>\n  <span class=\"token keyword\">const</span> messages <span class=\"token operator\">=</span> subscribers<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">subscriber</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">sendMessageToSubscriber</span><span class=\"token punctuation\">(</span>subscriber<span class=\"token punctuation\">.</span>connectionId<span class=\"token punctuation\">,</span> payload<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  \n  <span class=\"token comment\">// make sure they all send</span>\n  <span class=\"token keyword\">await</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>messages<span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// still have to let api gateway know we were successful!</span>\n  <span class=\"token keyword\">return</span> success<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">410</code> error codes mean the connection is gone (or isn’t established yet). Depending on your use case, you may want to clean those up in your data store so you don’t keep trying to send messages!</p>\n<p>You can close connections from the “server” side via the ApiGatewayManagementApi. In addition, the <code class=\"language-text\">$disconnect</code> route invoke is a best attempt, and not a guarantee. (That said, I haven’t seen it fail yet, so it seems like a small edge case.)</p>\n<p>If you are using the AWS CLI to send messages, be sure to use the <code class=\"language-text\">--endpoint</code> parameter to override the default api used to your actual <code class=\"language-text\">wss</code> api endpoint. The <a href=\"https://docs.aws.amazon.com/cli/latest/reference/apigatewaymanagementapi/index.html?highlight=api%20gateway%20management\">docs</a> mention this in the top level description of the command, but not in the <code class=\"language-text\">post-to-connection</code> description.</p>\n<p>Check out the docs for the ApiGatewayManagementApi for <a href=\"https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/ApiGatewayManagementApi.html\">AWS NodeJS SDK</a> and <a href=\"https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/apigatewaymanagementapi.html?highlight=apigatewaymanagementapi\">Boto3</a> to learn more.</p>\n<h4>Now, try it out!</h4>\n<p>You can <a href=\"https://github.com/serverless/serverless-websockets-plugin/tree/master/example\">find all the code on GitHub</a>, and run this sample chat app in your own AWS account with a single <code class=\"language-text\">serverless deploy</code>.</p>\n<p>Now get out there and build something great!</p>\n<h5>Resources</h5>\n<ul>\n<li><a href=\"https://github.com/serverless/serverless-websockets-plugin/tree/master/example\">Full chat app example on GitHub</a></li>\n<li><a href=\"https://serverless.com/blog/api-gateway-websockets-support/\">Explainer: Real-time applications with API Gateway WebSockets</a></li>\n</ul>","frontmatter":{"title":"Using API Gateway WebSockets with the Serverless Framework","date":"December 21, 2018","description":"We built a plugin to let you use API Gateway WebSockets with the Serverless Framework, even in advance of CloudFormation support! Try it out."}}},"pageContext":{"slug":"/posts/2018-12-21-api-gateway-websockets-example/","previous":{"fields":{"slug":"/posts/2018-12-17-announcing-framework-v135/"},"frontmatter":{"title":"Serverless Framework v.1.35: Local Invoke Ruby, CloudFormation variable syntax"}},"next":{"fields":{"slug":"/posts/2019-01-09-introducing-framework-v136/"},"frontmatter":{"title":"Serverless Framework v1.36: Bug fixes and quality of life improvements for all!"}}}}}