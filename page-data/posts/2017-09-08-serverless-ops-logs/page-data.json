{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/2017-09-08-serverless-ops-logs/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"fa35cf04-760b-5058-9b96-f6299b14efcb","excerpt":"In our last ops post, we set up simple alarms to monitor your Lambda functions with CloudWatch metrics and alarms. This gives you a baseline understanding of…","html":"<p>In our <a href=\"https://serverless.com/blog/serverless-ops-metrics/\">last ops post</a>, we set up simple alarms to monitor your Lambda functions with CloudWatch metrics and alarms. This gives you a baseline understanding of what is happening in your functions.</p>\n<p>But metrics can only take you so far. When errors are firing and alarms are triggering, you need visibility into how and why your functions are failing.</p>\n<p>Enter an old friend of every developer: the log. Logging lets you drop status updates from your code and provide additional detail around errors.</p>\n<p>Inspecting logs in a serverless world uses some different patterns — no SSH-ing onto a production box and grep-ing through text files for you. In this post, we’ll talk about the basic logging mechanisms with AWS Lambda and dive into some advanced practices for understanding your functions.</p>\n<h2>The Basics: Logging to CloudWatch</h2>\n<p>First, let’s start with a walkthrough of how logging works with AWS Lambda. We’ll create a Serverless service to test logging. I like to use Python, but the mechanics are similar with Javascript or the other supported languages.</p>\n<p>To follow along, you’ll need to install and configure the Serverless Framework. Check the instructions <a href=\"https://serverless.com/framework/docs/providers/aws/guide/quick-start/\">here</a> if you haven’t done that yet.</p>\n<p>First, let’s create a simple service to demonstrate logging:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ sls create -t aws-python3 -p logging\nServerless: Generating boilerplate<span class=\"token punctuation\">..</span>.\nServerless: Generating boilerplate <span class=\"token keyword\">in</span> <span class=\"token string\">\"/Users/alexdebrie/scratch/logging\"</span>\n _______                             __\n<span class=\"token operator\">|</span>   _   .-----.----.--.--.-----.----<span class=\"token operator\">|</span>  .-----.-----.-----.\n<span class=\"token operator\">|</span>   <span class=\"token operator\">|</span>___<span class=\"token operator\">|</span>  -__<span class=\"token operator\">|</span>   _<span class=\"token operator\">|</span>  <span class=\"token operator\">|</span>  <span class=\"token operator\">|</span>  -__<span class=\"token operator\">|</span>   _<span class=\"token operator\">|</span>  <span class=\"token operator\">|</span>  -__<span class=\"token operator\">|</span>__ --<span class=\"token operator\">|</span>__ --<span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>____   <span class=\"token operator\">|</span>_____<span class=\"token operator\">|</span>__<span class=\"token operator\">|</span>  <span class=\"token punctuation\">\\</span>___/<span class=\"token operator\">|</span>_____<span class=\"token operator\">|</span>__<span class=\"token operator\">|</span> <span class=\"token operator\">|</span>__<span class=\"token operator\">|</span>_____<span class=\"token operator\">|</span>_____<span class=\"token operator\">|</span>_____<span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>   <span class=\"token operator\">|</span>   <span class=\"token operator\">|</span>             The Serverless Application Framework\n<span class=\"token operator\">|</span>       <span class=\"token operator\">|</span>                           serverless.com, v1.19.0\n -------\n\nServerless: Successfully generated boilerplate <span class=\"token keyword\">for</span> template: <span class=\"token string\">\"aws-python3\"</span>\n$ <span class=\"token builtin class-name\">cd</span> logging\n$ <span class=\"token function\">ls</span>\nhandler.py\tserverless.yml</code></pre></div>\n<p>We used the <code class=\"language-text\">create</code> command to create a Python3 service from a template, then changed into our directory which contains a <code class=\"language-text\">serverless.yml</code> config file and a <code class=\"language-text\">handler.py</code> file with our function code.</p>\n<p>Open your <code class=\"language-text\">handler.py</code> file and add the following code:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># handler.py</span>\n\n<span class=\"token keyword\">import</span> json\n<span class=\"token keyword\">import</span> logging\n\n\nlogger <span class=\"token operator\">=</span> logging<span class=\"token punctuation\">.</span>getLogger<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nlogger<span class=\"token punctuation\">.</span>setLevel<span class=\"token punctuation\">(</span>logging<span class=\"token punctuation\">.</span>INFO<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">hello</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'I can log with a Python print statement.'</span><span class=\"token punctuation\">)</span>\n\n    logger<span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">(</span><span class=\"token string\">'I can also log with the Python logging library.'</span><span class=\"token punctuation\">)</span>\n\n    response <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"statusCode\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"body\"</span><span class=\"token punctuation\">:</span> json<span class=\"token punctuation\">.</span>dumps<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">'message'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'I did some logging.'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> response</code></pre></div>\n<p>After you update your handler, deploy your function:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ sls deploy</code></pre></div>\n<p>Then invoke your function with the <code class=\"language-text\">--log</code> flag to display the logging output to your terminal:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ sls invoke -f hello --log\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"statusCode\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">200</span>,\n    <span class=\"token string\">\"body\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"{<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>message<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>: <span class=\"token entity\" title=\"\\&quot;\">\\\"</span>I did some logging.<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>}\"</span>\n<span class=\"token punctuation\">}</span>\n--------------------------------------------------------------------\nSTART RequestId: 29505d9b-93d1-11e7-8418-5f5a64c6f12a Version: <span class=\"token variable\">$LATEST</span>\nI can log with a Python print statement.\n<span class=\"token number\">2017</span>-09-07 <span class=\"token number\">13</span>:33:41.102 <span class=\"token punctuation\">(</span>+00:00<span class=\"token punctuation\">)</span>\t29505d9b-93d1-11e7-8418-5f5a64c6f12a\t<span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span>\tI can also log with the Python logging library.\nEND RequestId: 29505d9b-93d1-11e7-8418-5f5a64c6f12a\nREPORT RequestId: 29505d9b-93d1-11e7-8418-5f5a64c6f12a\tDuration: <span class=\"token number\">0.37</span> ms\tBilled Duration: <span class=\"token number\">100</span> ms \tMemory Size: <span class=\"token number\">1024</span> MB\tMax Memory Used: <span class=\"token number\">21</span> MB</code></pre></div>\n<p>In the logs, we can see two logging statements. The first is from the print statement with just the bare message passed in. The second is from the logger and includes formatting such as a timestamp, the RequestId, the log level, and the log message. Either method will work. Both will be captured by CloudWatch without adding significant latency to your functions.</p>\n<p>This is similar for other runtimes. For example, in Node, use <code class=\"language-text\">console.log()</code> for logging to CloudWatch.</p>\n<h2>Viewing your logs</h2>\n<p>If you’re actively developing a function, the fastest way to view your logs is with the Serverless Framework itself. As shown above, you can invoke a function and get logs for that specific invocation:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ sls invoke -f <span class=\"token operator\">&lt;</span>function<span class=\"token operator\">></span> --log\n<span class=\"token punctuation\">..</span>.log output<span class=\"token punctuation\">..</span>.</code></pre></div>\n<p>Or you can use the <code class=\"language-text\">sls logs</code> command to get logs for many invocations:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ sls logs -f <span class=\"token operator\">&lt;</span>function<span class=\"token operator\">></span>\n<span class=\"token punctuation\">..</span>.log output<span class=\"token punctuation\">..</span>.</code></pre></div>\n<p><strong>Pro tip:</strong> Open a different window in your terminal and run <code class=\"language-text\">sls logs -f &lt;function&gt; --tail</code>. The <code class=\"language-text\">--tail</code> flag will continuously poll your function’s log group, so you can stream in logs as you invoke your function with different input.</p>\n<p>If you’re looking to search a larger portion of your logs, you can use the <a href=\"https://console.aws.amazon.com/cloudwatch/home\">CloudWatch Console</a>. Make sure you’re in the right region for your function, then click on “Logs”:</p>\n<img width=\"1396\" alt=\"CloudWatch Console\" src=\"https://user-images.githubusercontent.com/6509926/30168029-d80134e0-93ad-11e7-8604-218c5280915f.png\">\n<p>This will show all of your Log Groups in the region. Use the search box to filter to the function you want. By default, the group will be named <code class=\"language-text\">/aws/lambda/&lt;service&gt;-&lt;stage&gt;-&lt;function&gt;</code></p>\n<img width=\"1392\" alt=\"CloudWatch Logs Filter\" src=\"https://user-images.githubusercontent.com/6509926/30168071-f7234c96-93ad-11e7-9a7d-e0534425d059.png\">\n<p>Click on your Log Group. You will see a list of Log Streams listed. Each function “container” that spins up for your function will get its own Log Stream, but they will all feed into the same Log Group. If you want to look at logs across all instances of your function, click “Search Log Group”.</p>\n<p>You’ll see a screen like the following:</p>\n<img width=\"1388\" alt=\"CloudWatch Raw Logs\" src=\"https://user-images.githubusercontent.com/6509926/30168167-31033868-93ae-11e7-8f5c-65290304aeb3.png\">\n<p>This has all of your function’s logs. In addition to your log statements, it contains Lambda output such as when a request has started, when a request has ended and a report of the resources used by that request invocation.</p>\n<p>The Lambda logs usually aren’t useful for debugging, so I filter them out at the top with <code class=\"language-text\">-&quot;RequestId: &quot;</code>, which means “remove all logs that have the string “RequestId: ” in them.</p>\n<img width=\"1396\" alt=\"Filtered CloudWatch Logs\" src=\"https://user-images.githubusercontent.com/6509926/30168406-e9162884-93ae-11e7-8d28-4acda5feeac0.png\">\n<p>Once you’ve done that, it’s easier to browse your logs for the information you want.</p>\n<h2>Advanced Usage: Centralized Logging</h2>\n<p>The terminal and CloudWatch console are fine for small-scale debugging purposes, but they quickly break down. If you’re looking through high volumes of log messages or correlating errors across multiple Lambda functions, you’ll be pulling your hair out with the CloudWatch console.</p>\n<p>At this point, you should move to a log aggregator. There are a number of options out there — Splunk, SumoLogic, Loggly, LogDNA, etc. The particular choice doesn’t matter, as long as it has a way to ship logs in via HTTP.</p>\n<p>AWS allows you to invoke a Lambda function whenever a particular Log Group receives a new log. This means you can have a log forwarding Lambda function whose sole purpose is to take CloudWatch logs and send them to your central aggregator for inspection and debugging.</p>\n<p>To get started, you should first deploy a Serverless service with your log forwarding function. Your <code class=\"language-text\">serverless.yml</code> should be similar to:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token comment\"># serverless.yml</span>\n\n<span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> log<span class=\"token punctuation\">-</span>forwarder\n\n<span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token key atrule\">runtime</span><span class=\"token punctuation\">:</span> nodejs6.10\n  <span class=\"token key atrule\">stage</span><span class=\"token punctuation\">:</span> prod\n  <span class=\"token key atrule\">region</span><span class=\"token punctuation\">:</span> us<span class=\"token punctuation\">-</span>east<span class=\"token punctuation\">-</span><span class=\"token number\">1</span>\n  <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> <span class=\"token number\">30</span>\n  <span class=\"token key atrule\">memorySize</span><span class=\"token punctuation\">:</span> <span class=\"token number\">128</span>\n\n<span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">forwarder</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.handler\n\n<span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">Resources</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">ForwarderLambdaPermission</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">Type</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"AWS::Lambda::Permission\"</span>\n      <span class=\"token key atrule\">Properties</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">Action</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"lambda:InvokeFunction\"</span>\n        <span class=\"token key atrule\">FunctionName</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">Fn::GetAtt</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> ForwarderLambdaFunction\n            <span class=\"token punctuation\">-</span> Arn\n        <span class=\"token key atrule\">Principal</span><span class=\"token punctuation\">:</span> logs.$<span class=\"token punctuation\">{</span>self<span class=\"token punctuation\">:</span>provider.region<span class=\"token punctuation\">}</span>.amazonaws.com</code></pre></div>\n<p>Your service should have a <code class=\"language-text\">handler.js</code> file which takes a CloudWatch log input and forwards it to your aggregator service. If you need examples, some aggregator services have built these functions for you:</p>\n<ul>\n<li><a href=\"https://github.com/SumoLogic/sumologic-aws-lambda/tree/master/cloudwatchlogs\">Sumologic log forwarder</a></li>\n<li><a href=\"https://www.splunk.com/blog/2016/11/29/announcing-new-aws-lambda-blueprints-for-splunk.html\">Splunk log forwarder blueprints</a></li>\n</ul>\n<p>Once you have your handler, run <code class=\"language-text\">sls deploy</code> to put your forwarding function into production. Then, get the ARN of your Lambda using <code class=\"language-text\">sls info -v</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ sls info -v\n\nService Information\nservice: log-forwarder\nstage: prod\nregion: us-east-2\napi keys:\n  None\nendpoints:\n  None\nfunctions:\n  forwarder: log-forwarder-prod-forwarder\n\nStack Outputs\nForwarderLambdaFunctionQualifiedArn: arn:aws:lambda:us-west-2:111111111111:function:log-forwarder-prod-forwarder:1\nServerlessDeploymentBucketName: log-forwarder-prod-serverlessdeploymentbuck-9asdfjasoir1</code></pre></div>\n<p>In the <code class=\"language-text\">StackOutput</code> section, there’s a <code class=\"language-text\">ForwarderLambdaFunctionQualifiedArn</code>. Copy this, and remove the <code class=\"language-text\">:&lt;number&gt;</code> at the very end. The number is the version, which you shouldn’t worry about.</p>\n<p>Now that you have a log forwarding function, you can subscribe that function to the CloudWatch Log Groups of your other services. The easiest way to do so is with the <a href=\"https://github.com/amplify-education/serverless-log-forwarding\">serverless-log-forwarding plugin</a> from Amplify Education.</p>\n<p>To use it, go to your Serverless service whose logs you would like to forward. Then, install the <code class=\"language-text\">serverless-log-forwarding</code> plugin:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">npm</span> <span class=\"token function\">install</span> --save-dev serverless-log-forwarding</code></pre></div>\n<p>Then, add the forwarding configuration to your <code class=\"language-text\">serverless.yml</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token comment\"># serverless.yml</span>\n\n<span class=\"token key atrule\">plugins</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> serverless<span class=\"token punctuation\">-</span>log<span class=\"token punctuation\">-</span>forwarding\n\n<span class=\"token key atrule\">custom</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">logForwarding</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">destinationARN</span><span class=\"token punctuation\">:</span> &lt;forwarding<span class=\"token punctuation\">-</span>function<span class=\"token punctuation\">-</span>ARN<span class=\"token punctuation\">></span>\n    <span class=\"token key atrule\">filterPattern</span><span class=\"token punctuation\">:</span> <span class=\"token key atrule\">\"-\\\"RequestId</span><span class=\"token punctuation\">:</span> \\\"\"</code></pre></div>\n<p>Use the ARN from your log forwarding function previously as the <code class=\"language-text\">destinationARN</code>. The <code class=\"language-text\">filterPattern</code> is optional, but I use it to filter out the internal Lambda logs as shown in the CloudWatch console walkthrough.</p>\n<p>Once you <code class=\"language-text\">sls deploy</code> your function, your CloudWatch Log Groups will be wired up to send to your forwarding function to be shipped to your log aggregator!</p>\n<h2>Additional Reading</h2>\n<p><a href=\"https://twitter.com/theburningmonk\">Yan Cui</a> recently did an <a href=\"https://hackernoon.com/centralised-logging-for-aws-lambda-b765b7ca9152\">excellent series on managing CloudWatch logs with Lambda</a>. He goes further in depth with logging, including using correlation Ids to trace requests across function boundaries. Yan is an excellent resource on Lambda in general, having managed some large Lambda-backed deployments at Yubl. His series on Yubl’s <a href=\"http://theburningmonk.com/yubls-road-to-serverless-architecture/\">road to Serverless architecture</a> is well worth reading.</p>\n<h3>Other posts in the Serverless Ops series:</h3>\n<ul>\n<li><a href=\"https://serverless.com/blog/serverless-ops-metrics/\">Serverless Ops 101: CloudWatch Metrics and Alarms</a></li>\n</ul>","frontmatter":{"title":"Serverless Ops 102 - CloudWatch Logs and Centralized Logging with AWS Lambda","date":"September 08, 2017","description":"Monitor and Debug your Serverless Lambda functions with CloudWatch and centralized logging."}}},"pageContext":{"slug":"/posts/2017-09-08-serverless-ops-logs/","previous":{"fields":{"slug":"/posts/2017-09-07-scaling-the-resistance-zero-maintenance-donations-platform/"},"frontmatter":{"title":"Scaling the Resistance - a Zero-maintenance Donations Platform with Serverless and AWS"}},"next":{"fields":{"slug":"/posts/2017-09-11-serverless-api-gateway-domain/"},"frontmatter":{"title":"How to set up a custom domain name for Lambda & API Gateway with Serverless"}}}}}