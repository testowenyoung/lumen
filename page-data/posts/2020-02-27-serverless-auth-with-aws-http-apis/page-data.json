{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/2020-02-27-serverless-auth-with-aws-http-apis/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"f865d62d-9837-585f-b751-32e5ab530dd3","excerpt":"New AWS HTTP APIs Earlier this week, we announced support for AWS HTTP APIs and talked a bit about what is possible with them. If you’d like to learn more about…","html":"<h2>New AWS HTTP APIs</h2>\n<p>Earlier this week, <a href=\"http://serverless.com/blog/aws-http-api-support\">we announced</a> support for AWS HTTP APIs and talked a bit about what is possible with them. If you’d like to learn more about the AWS HTTP API and the new event source we’ve added integrate with it check that post out. </p>\n<p>In this post, however we’ll jump in to using the new AWS HTTP APIs with one of the new features they offer - the JSON Web Token integration. I’ll show you how to use Amazon Cognito to add authentication and authorization to your AWS HTTP API endpoints. </p>\n<p>You can choose to follow along with examples in either Node.js or Python and towards the end, I’ll show how you could modify the examples in order to work with a tool like Auth0 or Okta instead of Amazon Cognito.</p>\n<p>Let’s get started!</p>\n<h2>Setup</h2>\n<p>In this guide, we will create an Amazon Cognito User Pool, App Client, and Domain all from scratch in the <code class=\"language-text\">resources</code> section of <code class=\"language-text\">serverless.yml</code>. You can choose to use either the Node.js or the Python version of the code. Run one of the following commands to get started:</p>\n<ul>\n<li>For Node.js - <code class=\"language-text\">git clone https://github.com/fernando-mc/aws-http-api-node-cognito.git</code></li>\n<li>For Python - <code class=\"language-text\">git clone https://github.com/fernando-mc/aws-http-api-python-cognito.git</code></li>\n</ul>\n<p>After you have the code, make sure you’ve also <a href=\"https://serverless.com/framework/docs/getting-started/\">installed the Serverless Framework</a>, setup and configured the <a href=\"https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html\">AWS CLI</a>, and (optionally) created a <a href=\"https://dashboard.serverless.com/\">Framework Pro</a> account.</p>\n<h2>Deploying the Project</h2>\n<p>With the repository cloned, change directories into the repository and make sure you’re on the same level as the <code class=\"language-text\">serverless.yml</code> file. Then you can make a few changes to the demo code:</p>\n<ol>\n<li>Either configure your own <code class=\"language-text\">org</code> and <code class=\"language-text\">app</code> name with <a href=\"https://dashboard.serverless.com/\">Framework Pro</a> or remove the <code class=\"language-text\">org</code> and <code class=\"language-text\">app</code> from the top of <code class=\"language-text\">serverless.yml</code>.</li>\n<li>Update the <code class=\"language-text\">DOMAIN_SUFFIX</code> value in the provider environment section to something unique. I recommend you use something like your name and favorite mythical animal. </li>\n<li>After that, save the file and run <code class=\"language-text\">serverless deploy</code>.</li>\n</ol>\n<p>This should deploy all the Amazon Cognito resources required as well as all the parts of our new HTTP API.</p>\n<p>After the deployment completes, you should see two API endpoints in the output:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">endpoints</span><span class=\"token punctuation\">:</span>\n  GET <span class=\"token punctuation\">-</span> https<span class=\"token punctuation\">:</span>//yea4h11vtb.execute<span class=\"token punctuation\">-</span>api.us<span class=\"token punctuation\">-</span>east<span class=\"token punctuation\">-</span>1.amazonaws.com/user/profile\n  POST <span class=\"token punctuation\">-</span> https<span class=\"token punctuation\">:</span>//yea4h11vtb.execute<span class=\"token punctuation\">-</span>api.us<span class=\"token punctuation\">-</span>east<span class=\"token punctuation\">-</span>1.amazonaws.com/user/profile\n<span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">getProfileInfo</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">-</span>api<span class=\"token punctuation\">-</span>node<span class=\"token punctuation\">-</span>dev<span class=\"token punctuation\">-</span>getProfileInfo\n  <span class=\"token key atrule\">createProfileInfo</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">-</span>api<span class=\"token punctuation\">-</span>node<span class=\"token punctuation\">-</span>dev<span class=\"token punctuation\">-</span>createProfileInfo\n<span class=\"token key atrule\">layers</span><span class=\"token punctuation\">:</span>\n  None</code></pre></div>\n<p>Copy your endpoints down and then try using the GET endpoint by pasting it into your browser or a tool like Postman. You should see this result:</p>\n<p><code class=\"language-text\">{&quot;message&quot;:&quot;Unauthorized&quot;}</code></p>\n<p>Similarly, if you try to send JSON data to the POST endpoint you should see the same result.</p>\n<p>This means these endpoints are protected and will only work with a valid JSON Web Token! In order to get this, we’ll need to generate one using the Cognito User Pool Hosted UI.</p>\n<p>Log into the AWS Console and navigate to the <a href=\"https://console.aws.amazon.com/cognito/home?region=us-east-1#\">Cognito section</a> of the dashboard. Make sure you’re in the same region you deployed your service to and click Manage User Pools:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/2020-02-27-aws-http-api-guide/main-cognito-page.png\" alt=\"Image of the Amazon Cognito Dashboard entry page\"></p>\n<p>From there, click on the user pool you created:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/2020-02-27-aws-http-api-guide/user-pools.png\" alt=\"Image of the Amazon Cognito User Pools\"></p>\n<p>And then navigate to the “App Client Settings” page:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/2020-02-27-aws-http-api-guide/app-client-settings.png\" alt=\"The Cognito App Client Settings\"></p>\n<p>And then scroll down to find the “Launch Hosted UI” button.</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/2020-02-27-aws-http-api-guide/hosted-ui.png\" alt=\"The Hosted UI Button\"></p>\n<p>Then sign up for your own account on the hosted UI</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/2020-02-27-aws-http-api-guide/sign-up.png\" alt=\"The Hosted UI Sign Up Modal\"></p>\n<p>After you sign up, you should be redirected to a non-available localhost page. Copy the URL out of your browser. It should look something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">https://localhost:3000/#id_token=eyJraWQiOiJzR1c3aDZvcis5VDIrVnlxWU53NVBrbVhJdnFEWFVISVJpcmRBY1R5R3VvPSIsImFsZyI6IlJTMjU2In0.eyJhdF9oYXNoIjoiT1l2bTNlcFdpUHc3S0szXzZRenJ4USIsInN1YiI6IjM3MzMyNTZmLWVmZTgtNDJhMC1iZmE3LWFiMmY1MzAzNDAzMSIsImF1ZCI6IjJ2aTUybnFwdjA1cWpxZnZuOXU4Z2htOWY4IiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImV2ZW50X2lkIjoiZWNiMzhlNDItYWEwYy00ZDVmLWJlNjItY2Y1MDRkNWY5MTIzIiwidG9rZW5fdXNlIjoiaWQiLCJhdXRoX3RpbWUiOjE1ODI2NzkwOTUsImlzcyI6Imh0dHBzOlwvXC9jb2duaXRvLWlkcC51cy1lYXN0LTEuYW1hem9uYXdzLmNvbVwvdXMtZWFzdC0xX0FaQ084elZJWCIsImNvZ25pdG86dXNlcm5hbWUiOiIzNzMzMjU2Zi1lZmU4LTQyYTAtYmZhNy1hYjJmNTMwMzQwMzEiLCJleHAiOjE1ODI2ODI2OTUsImlhdCI6MTU4MjY3OTA5NSwiZW1haWwiOiJmZXJuYW5kb0BzZXJ2ZXJsZXNzLmNvbSJ9.4ezu7ArGG3wpq7uBlh6L_GQMGHy5IoTZxD5H-ixOaA2pgL3AeRaz7aF7ZfOmJ6hV22D0AgdwA8k7VxiIXWWs79FddCEV8jlNkg6nVcH5711kVgDG3Rm9TjzTJgD343hIW7NGANlczZwm96yvamwkf7sad05kAjrhRTt3NaskWAMbfbS4PZwkQ1kaC47kSUISP6f7-Ol2iY3LM-1MjYTTlk27y5rmZiSWKIuCUK_-qBnvqEpL5qiqBZhqJY7rEaKzA7wcjd9lFpHjdKdr9jNpLeLxFVgGuG9qemBm_xQAYA71wEAXKRW4YZ542_MQyRZOj3w7TF5JhnRZw_Bj4nSkqw&amp;access_token=eyJraWQiOiJiOUNUNHJydmxvcW8wSTBjM05DTEExaGxSbkJUNStOYjdtUHhrOVlNbTRRPSIsImFsZyI6IlJTMjU2In0.eyJzdWIiOiIzNzMzMjU2Zi1lZmU4LTQyYTAtYmZhNy1hYjJmNTMwMzQwMzEiLCJldmVudF9pZCI6ImVjYjM4ZTQyLWFhMGMtNGQ1Zi1iZTYyLWNmNTA0ZDVmOTEyMyIsInRva2VuX3VzZSI6ImFjY2VzcyIsInNjb3BlIjoiYXdzLmNvZ25pdG8uc2lnbmluLnVzZXIuYWRtaW4gcGhvbmUgb3BlbmlkIHByb2ZpbGUgZW1haWwiLCJhdXRoX3RpbWUiOjE1ODI2NzkwOTUsImlzcyI6Imh0dHBzOlwvXC9jb2duaXRvLWlkcC51cy1lYXN0LTEuYW1hem9uYXdzLmNvbVwvdXMtZWFzdC0xX0FaQ084elZJWCIsImV4cCI6MTU4MjY4MjY5NSwiaWF0IjoxNTgyNjc5MDk1LCJ2ZXJzaW9uIjoyLCJqdGkiOiI5ODZlNzJkYi01ZmQyLTQxNjMtYjVhYS1mN2QzNWIxNzBhOWUiLCJjbGllbnRfaWQiOiIydmk1Mm5xcHYwNXFqcWZ2bjl1OGdobTlmOCIsInVzZXJuYW1lIjoiMzczMzI1NmYtZWZlOC00MmEwLWJmYTctYWIyZjUzMDM0MDMxIn0.XthMHJwEi9Q6S9CI-JEA3NOrCL_pVoe3p5UUHgyLy0ABRkUc55CK9l8aIHrYaOxYp_xMOwkugtLGRF7wlW7mZ2-zhJW1okxblvGajZHi0M0rqjmE1GRygOyeT__RdYbsyq0H-KuE-j4Aa50W7BBvgnvRyzSlE7tP0a7hZtknIZaxmKfqLmPjQRvd965wkxJUqXlBJkjYF4uHor2GalTjzsR4vqm8rPoMfTcOhRRiBE8THp83Z7_eA8KH0DcGTdcFSkmH4Mrjrbu7zO3MMM36PsrRQ5tKo-nVdOAsPS5td1pTqouKhBM4jC5dQqgIivZIldnXBMHsjb2aUxerRxo9Og&amp;expires_in=3600&amp;token_type=Bearer</code></pre></div>\n<p>That URL contains two JSON web tokens, an <code class=\"language-text\">id_token</code> and an <code class=\"language-text\">access_token</code>. They each serve different purposes, but either can be used in this case to verify against the API. </p>\n<p>Grab the <code class=\"language-text\">id_token</code> by copying everything after the <code class=\"language-text\">id_token=</code> and before the <code class=\"language-text\">&amp;access_token</code>. You can inspect the JSON web token on a site like <a href=\"https://jwt.io/\">jwt.io</a>. Just paste the token in the debugger as shown below:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/2020-02-27-aws-http-api-guide/jwt-io.png\" alt=\"Decoding the JWT in jwt.io\"></p>\n<p>From here, you can open up something like Postman and set the Authorization section of the request as shown below before testing the GET endpoint:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/2020-02-27-aws-http-api-guide/postman-get.png\" alt=\"Postman example sending a request with authorization\"></p>\n<p>You’ll need to select the Type of Bearer Token and paste your token into the text box. Keep in mind that you’ll need to copy it exactly! You can’t have extra spaces, new lines, or a trailing <code class=\"language-text\">&amp;</code> character that you might have copied accidentally.</p>\n<p>It should return a nice juicy response containing all the fun information you might want about the token’s owner in the <code class=\"language-text\">message.requestContext.authorizer.claims</code>. </p>\n<p><strong>Importantly</strong> if you try again with the <code class=\"language-text\">access_token</code> you’ll get a different set of information in the response. These two tokens are designed for different purposes and as such they contain different sets of information.</p>\n<h2>Cognito Alternatives</h2>\n<p>I included Cognito in this service to make it easier to demonstrate without including third party services. However, you could also easily replace Cognito with something like Auth0 by removing the <code class=\"language-text\">resources</code> section from <code class=\"language-text\">serverless.yml</code> and then replacing the values in the <code class=\"language-text\">provider</code> section under the <code class=\"language-text\">httpApi</code> and <code class=\"language-text\">authorizers</code>. </p>\n<p>The updated <code class=\"language-text\">httpAPi</code> section would look something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">  <span class=\"token key atrule\">httpApi</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">authorizers</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">serviceAuthorizer</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">identitySource</span><span class=\"token punctuation\">:</span> $request.header.Authorization\n        <span class=\"token key atrule\">issuerUrl</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//YOUR_AUTH0_DOMAIN.auth0.com\n        <span class=\"token key atrule\">audience</span><span class=\"token punctuation\">:</span> YOUR_API_ID</code></pre></div>\n<p>This JWT integration simply requires that you send either an <code class=\"language-text\">id_token</code> or <code class=\"language-text\">access_token</code> in via the <code class=\"language-text\">Authorization</code> header with the value of <code class=\"language-text\">Bearer &lt;token&gt;</code>. AWS will then take care of validating the token against the provided <code class=\"language-text\">issuerUrl</code> and <code class=\"language-text\">audience</code>.</p>\n<p>Here are two examples that have a more simplistic configuration like this:</p>\n<ol>\n<li><a href=\"https://github.com/fernando-mc/simple-aws-http-api-jwt-node.git\">HTTP API with Node.js</a></li>\n<li><a href=\"https://github.com/fernando-mc/simple-aws-http-api-jwt-python.git\">HTTP API with Python</a> </li>\n</ol>\n<p>Simply clone either repository and follow most of the same steps shown in the earlier section. You’ll be able to skip setting the <code class=\"language-text\">DOMAIN_SUFFIX</code> environment variable as you’ll already have configured and created your own resources to replace the User Pool Domain.</p>\n<p>You will also need to figure out how to generate the <code class=\"language-text\">id_token</code> or <code class=\"language-text\">access_token</code> on your own using the other provider in order to test the integration.</p>\n<h2>Now What?</h2>\n<p>Congratulations! At this point, you deployed and tested your AWS HTTP API and it’s ability to authenticate users who want to access an endpoint! </p>\n<p>In the future, you may want to learn how to manage scopes and permissions with the <code class=\"language-text\">access_token</code>. But for now, you can start to use this new tool to shave hundreds of lines of JWT verification code out of your AWS HTTP API projects! </p>\n<p>You can also start to evaluate the limitations of the AWS HTTP API to see if it is ready to support your existing API Gateway workloads.</p>\n<p>Have questions about the guide? <a href=\"https://twitter.com/fmc_sea\">Get in touch</a> or leave a comment below!</p>","frontmatter":{"title":"Serverless Auth with AWS HTTP APIs","date":"February 27, 2020","description":"Learn how to create an AWS HTTP API and set it up with a Cognito Authorizer."}}},"pageContext":{"slug":"/posts/2020-02-27-serverless-auth-with-aws-http-apis/","previous":{"fields":{"slug":"/posts/2020-02-25-aws-http-api-support/"},"frontmatter":{"title":"Announcing Support for AWS HTTP APIs"}},"next":{"fields":{"slug":"/posts/2020-03-06-cicd-for-monorepos/"},"frontmatter":{"title":"CI/CD for monorepos"}}}}}