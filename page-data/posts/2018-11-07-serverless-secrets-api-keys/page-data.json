{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/2018-11-07-serverless-secrets-api-keys/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"5c76f9d2-aed9-5e90-9f49-3f59f3b5763c","excerpt":"Serverless applications are often service-full applications. This means you use hosted services to augment your applications—think DynamoDB for data storage or…","html":"<p>Serverless applications are often <em>service-full</em> applications. This means you use hosted services to augment your applications—think DynamoDB for data storage or Mailchimp for sending emails.</p>\n<p>When using other services in your Serverless applications, you often need configuration data to make your application work correctly. This includes things like API keys, resource identifiers, or other items.</p>\n<p>In this post, we’ll talk about a few different ways to handle these configuration items. This post covers:</p>\n<ul>\n<li>Using environment variables in your functions;</li>\n<li>Handling secrets for small Serverless projects; and</li>\n<li>Managing secrets for larger Serverless projects.</li>\n</ul>\n<p>Let’s get started!</p>\n<h4>Using Environment Variables with Lambda</h4>\n<p>When building my first web applications, Heroku’s <a href=\"https://12factor.net/\">12 Factor App</a> was hugely influential—a set of twelve principles to deploy stateless, scalable web applications. I found many of them were directly applicable to Serverless applications.</p>\n<p>One of the twelve factors was to <a href=\"https://12factor.net/config\">store config in your environment</a>. It recommended using environment variables for config (e.g. credentials or hostnames) as these would be easy to change between deploys without changing code.</p>\n<p>Lambda and Serverless provide support for environment variables, and I would recommend using them <em>in certain situations</em>. Check out the last section on managing secrets with large projects for when you shouldn’t use environment variables and how you should approach configuration in those situations.</p>\n<p>Let’s do a quick example to see how environment variables work. Imagine you’re making a Twitter bot that checks for tweets with certain hashtags and retweets them with slight changes, similar to the <a href=\"https://twitter.com/serverlesssuper\">Serverless Superman</a> bot. To post these retweets, you’ll need to get an <a href=\"https://developer.twitter.com/en/docs/basics/authentication/guides/access-tokens.html\">access token</a> to sign your requests.</p>\n<p>Once you have your access token, you’ll need to make it accessible to your function. Let’s see how that’s done.</p>\n<p>Create an empty directory, and add the following <code class=\"language-text\">serverless.yml</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token comment\"># severless.yml</span>\n\n<span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> env<span class=\"token punctuation\">-</span>variables\n\n<span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token key atrule\">runtime</span><span class=\"token punctuation\">:</span> python3.6\n  <span class=\"token key atrule\">stage</span><span class=\"token punctuation\">:</span> dev\n  <span class=\"token key atrule\">region</span><span class=\"token punctuation\">:</span> us<span class=\"token punctuation\">-</span>east<span class=\"token punctuation\">-</span><span class=\"token number\">1</span>\n  <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">TWITTER_ACCESS_TOKEN</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'1234abcd'</span>\n\n<span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">superman</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> superman.handler\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">schedule</span><span class=\"token punctuation\">:</span> rate(10 minutes)</code></pre></div>\n<p>This is a simple service with a single function, <code class=\"language-text\">superman</code>, which will run the code for the Serverless Superman bot. Notice in the <code class=\"language-text\">provider</code> section that we have an <code class=\"language-text\">environment</code> block — these are the environment variables that will be added to our Lambda environment.</p>\n<p>In Python, you’ll be able to access these environment variables in the <code class=\"language-text\">os.environ</code> dictionary, where the key is the name of the environment variable. For our example above, this would look like:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> os\n\naccess_token <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>environ<span class=\"token punctuation\">[</span><span class=\"token string\">'TWITTER_ACCESS_TOKEN'</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>In Javascript, you can access environment variables from the <code class=\"language-text\">process.env</code> object:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> access_token <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">TWITTER_ACCESS_TOKEN</span></code></pre></div>\n<p>One final note: environment variables in the <code class=\"language-text\">provider</code> block are accessible to <em>all</em> functions in the service. You can also scope environment variables on a per-function basis by adding environment variables under the <code class=\"language-text\">function</code> block.</p>\n<p>For example, imagine you ran both the Serverless Superman and <a href=\"https://twitter.com/BigDataBatman\">Big Data Batman</a> Twitter bots. Because these are separate accounts, they would each have their own Twitter access tokens. You would structure it as follows:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token comment\"># serverless.yml</span>\n\n<span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> env<span class=\"token punctuation\">-</span>variables\n\n<span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token key atrule\">runtime</span><span class=\"token punctuation\">:</span> python3.6\n  <span class=\"token key atrule\">stage</span><span class=\"token punctuation\">:</span> dev\n  <span class=\"token key atrule\">region</span><span class=\"token punctuation\">:</span> us<span class=\"token punctuation\">-</span>east<span class=\"token punctuation\">-</span><span class=\"token number\">1</span>\n\n<span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">superman</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> superman.main\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">schedule</span><span class=\"token punctuation\">:</span> rate(10 minutes)\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">TWITTER_ACCESS_TOKEN</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'mySupermanToken'</span>\n  <span class=\"token key atrule\">batman</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> batman.main\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">schedule</span><span class=\"token punctuation\">:</span> rate(10 minutes)\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">TWITTER_ACCESS_TOKEN</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'myBatmanToken'</span></code></pre></div>\n<p>Now we have two functions—<code class=\"language-text\">superman</code> and <code class=\"language-text\">batman</code>—and each one has its unique access token for authenticating with Twitter. Success!</p>\n<h4>Handling Secrets for Small Teams &#x26; Projects</h4>\n<p>Now that we’ve got the basics down, let’s dig a little deeper into handling secrets for your projects.</p>\n<p>In the example above, the big problem is that our access token is in plaintext directly in our <code class=\"language-text\">serverless.yml</code>. This is a sensitive secret that we don’t want to commit to source control.</p>\n<p>A better option is to use the <a href=\"https://dashboard.serverless.com\">Serverless Framework Pro Dashboard</a> Parameters feature. If you are already using Serverless Framework Pro for monitoring your Serverless Services, it makes sense to use the same tool to help you centrally maintain your secrets. And this can be very easily done across stages (or environments) as well.</p>\n<p>When you have logged into your <code class=\"language-text\">org</code> on the dashboard, click on ‘profiles’ in the top left, then either choose from an existing profile you already assign to a particular stage or create a new one. Once you have opened a profile, you will see a tab labelled parameters. It is here that you can then add whatever parameter you like for that deployment profiles stage. You can then repeat that for any other stage that your services may need and add the values specific to that stage.</p>\n<p>But how does this work? Well, within our <code class=\"language-text\">serverless.yml</code> we can reference those parameters using the <code class=\"language-text\">${param:keyname}</code> syntax. And then, on deployment time, the Serverless Framework will read the values from our Serverless Pro configuration and replace the variable syntax with the actual values.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token punctuation\">...</span>\n  <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">MY_DASHBOARD_PARAM</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>param<span class=\"token punctuation\">:</span>nameOfKey<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">...</span></code></pre></div>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/secrets-api-keys/secrets-api-keys.gif\" alt=\"Video of process to add new param\"></p>\n<h4>Managing Secrets for Larger Projects and Teams</h4>\n<p>The methods mentioned above work well for certain types of projects. However, there are two different areas that may cause problems.</p>\n<p>First, environment variables are inserted into your Lambda function as plain-text. This may be unacceptable for security purposes.</p>\n<p>Second, environment variables are set at <em>deploy time</em> rather than being evaluated at <em>run time</em>. This can be problematic for configuration items that change occasionally. This is even more painful if the same config item is used across multiple functions, such as a database connection string. If you need to change the configuration item for any reason, you’ll need to redeploy all of the services that use that configuration item. This can be a nightmare.</p>\n<p>If this is the case, I would recommend using AWS Parameter Store to handle your secrets. It’s very simple to use and allows for nice access controls on who and what is allowed to access certain secrets.</p>\n<p>However, you’ll have to write code within your Lambda handler to interact with Parameter Store—you can’t use the easy shorthand from the Serverless Framework.</p>\n<p>Here’s an example of how you would get a configuration value from SSM in your Lambda function in Python:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> boto3\n\nclient <span class=\"token operator\">=</span> boto3<span class=\"token punctuation\">.</span>client<span class=\"token punctuation\">(</span><span class=\"token string\">'ssm'</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">get_secret</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\tresp <span class=\"token operator\">=</span> client<span class=\"token punctuation\">.</span>get_parameter<span class=\"token punctuation\">(</span>\n\t\tName<span class=\"token operator\">=</span>key<span class=\"token punctuation\">,</span>\n\t\tWithDecryption<span class=\"token operator\">=</span><span class=\"token boolean\">True</span>\n\t<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">return</span> resp<span class=\"token punctuation\">[</span><span class=\"token string\">'Parameter'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'Value'</span><span class=\"token punctuation\">]</span>\n\naccess_token <span class=\"token operator\">=</span> get_secret<span class=\"token punctuation\">(</span><span class=\"token string\">'supermanToken'</span><span class=\"token punctuation\">)</span>\ndatabase_connection <span class=\"token operator\">=</span> get_secret<span class=\"token punctuation\">(</span><span class=\"token string\">'databaseConn'</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>We create a simple helper utility that wraps a Boto3 call to the Parameter Store and returns the value for a requested secret. Then we can easily call that helper function by providing the name of the secret we want.</p>\n<h4>Other considerations</h4>\n<p>This is just scratching the surface of handling configuration in a larger Serverless project. Another issue you’ll want to consider is refreshing your config within a particular Lambda container. Because a Lambda instance can be reused across many function invocations, you’ll want to periodically refresh the configuration in case it changed since the instance was initially started.</p>\n<p>We have <a href=\"https://serverless.com/blog/aws-secrets-management\">another blog post</a> that goes into even more detail about secrets management and if you are looking for more information I would recommend reading that one as well.</p>","frontmatter":{"title":"Managing secrets, API keys and more with Serverless","date":"November 07, 2017","description":"Use Lambda environment variables and AWS Parameter Store to handle configuration in your Serverless projects"}}},"pageContext":{"slug":"/posts/2018-11-07-serverless-secrets-api-keys/","previous":{"fields":{"slug":"/posts/2017-11-06-cornelia-davis-models-event-driven-programming-emit-2017/"},"frontmatter":{"title":"Cornelia Davis - models for event-driven programming"}},"next":{"fields":{"slug":"/posts/2017-11-07-future-event-driven-compute-emit-2017/"},"frontmatter":{"title":"Serverless panel - the future of event-driven compute"}}}}}