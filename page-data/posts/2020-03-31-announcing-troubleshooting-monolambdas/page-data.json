{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/2020-03-31-announcing-troubleshooting-monolambdas/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"f1ee2235-7e3b-57b0-8b66-3a9e40a17b0c","excerpt":"Troubleshooting Serverless APIs While it might feel like Express.js or Flask are more “Monolithic” approaches to serverless, it’s actually a very common pattern…","html":"<h1>Troubleshooting Serverless APIs</h1>\n<p>While it might feel like Express.js or Flask are more “Monolithic” approaches to serverless, it’s actually a very common pattern for many different applications. And we’re excited to announce that you can now deploy your Express.js and Flask microservices with the same automatic monitoring and debugging features as traditional Serverless Framework microservices.</p>\n<p>While Serverless <a href=\"http://dashboard.serverless.com/\">Framework Pro</a> previously had <a href=\"https://serverless.com/blog/troubleshoot-serverless-apis/\">automatic monitoring and troubleshooting</a> tools integrated out of the box, we lacked support for monolambda microservices. Developers using Express.js, Flask, Lambda API, or other development frameworks were unable to take advantage of many of the tools we offer to help review function invocations, sort invocations by API endpoint and more. That changes today.</p>\n<p>There’s a lot of information on the <a href=\"https://serverless.com/blog/\">Serverless Blog</a> and in our <a href=\"https://serverless.com/framework/docs/dashboard/\">dashboard documentation</a> about how you can leverage <a href=\"http://dashboard.serverless.com/\">Framework Pro</a> if you haven’t already had a chance to use it. But for now, let’s take a look at some of the features you now have access to with monolambda applications.</p>\n<h1>What’s New for Monolambdas?</h1>\n<p>Because monolambda applications output lots to the same Amazon CloudWatch log stream, debugging monolambda applications has historically been a huge nuisance. In order to find the single API request you were looking for you’d have to dig through hundreds of unrelated logs from other API requests just to find the invocation and API endpoint you were trying to debug. With our automatic monolambda monitoring and troubleshooting tools that’s no longer an issue.</p>\n<p>You can review the API requests for all the endpoints across your monolambda application:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/troubleshooting-monolambdas/errors.png\" alt=\"Errors Overview\"></p>\n<p>This starting point gives you an at-a-glance view into the successful and failed requests across your API endpoints. If you want a deeper look at particular endpoints, you can sort them by the API route in question:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/troubleshooting-monolambdas/endpoint_explorer.png\" alt=\"Endpoint Overview\"></p>\n<p>The best part about this? For Express.js, Flask, and Lambda API, all these API routes are automatically sorted out for you. You don’t have to instrument a single endpoint yourself. For frameworks outside of this list that want the same experience, you can leverage the Serverless SDK’s <a href=\"https://serverless.com/framework/docs/dashboard/sdk/nodejs#setendpoint\">setEndpoint</a> functionality to get a similar experience.</p>\n<p>When you find the invocation you’re looking for, you’ll get the same information you’re used to seeing from the Framework Pro explorer monitoring:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/troubleshooting-monolambdas/invocation_example.png\" alt=\"Endpoint Overview\"></p>\n<h1>Configuring Your Existing Serverless Monolambda</h1>\n<h2>Prerequisites</h2>\n<p>So how do you get started with these new features? First, <a href=\"https://serverless.com/framework/docs/getting-started/\">update</a> your version of the Framework to the latest version. If you installed it with NPM you can use <code class=\"language-text\">npm update -g serverless</code>. You’ll need v1.67.0 or greater of the Framework and v3.6.1 or greater of the Framework Pro plugin.</p>\n<p>Next, in order to add the automated troubleshooting, you’ll need to have already created a <a href=\"http://dashboard.serverless.com/\">Framework Pro</a> account and add the <code class=\"language-text\">org</code> and <code class=\"language-text\">app</code> values inside of your <code class=\"language-text\">serverless.yml</code> file. You may need to create a new <code class=\"language-text\">app</code> for your service.</p>\n<h2>Existing Express.js and Flask apps</h2>\n<p>If you’ve already created your own Express.js or Flask app and deployed it previously with the Serverless Framework, all you need to do now is run <code class=\"language-text\">serverless deploy</code> again and test out some of your endpoints. </p>\n<p>In the <a href=\"http://dashboard.serverless.com/\">Framework Pro Dashboard</a> for that service you should see all your logs and troubleshooting capabilities for each route you test in your monolambda. Keep in mind, that the routes will only start to appear after you run requests against them. </p>\n<p>The two line configuration change and <em>zero changes</em> to your application code should trigger a new deployment with the automatic Monolambda troubleshooting and monitoring instrumentation.</p>\n<h2>Creating a simple monolambda app</h2>\n<p>If it’s your first time deploying a monolambda application with the Serverless Framework you can follow the steps below for an Express.js or Flask app before deploying and testing the new functionality.</p>\n<p><strong>Express.js</strong></p>\n<p>Assuming you’ve already installed the latest version of the Serverless Framework globally you can start your new Express.js project by installing a few dependencies.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm install serverless-http --save\nnpm install express --save</code></pre></div>\n<p>Then, you can create an <code class=\"language-text\">index.js</code> file that contains your Express.js app code:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// index.js</span>\n<span class=\"token keyword\">const</span> serverless <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'serverless-http'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/hello/:name'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> name <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>name\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Hello </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>name<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">!</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nmodule<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span>handler <span class=\"token operator\">=</span> <span class=\"token function\">serverless</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Next, you’ll have a <code class=\"language-text\">serverless.yml</code> file:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">org</span><span class=\"token punctuation\">:</span> myorg\n<span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> helloapp\n<span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> express<span class=\"token punctuation\">-</span>api\n\n<span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token key atrule\">runtime</span><span class=\"token punctuation\">:</span> nodejs12.x\n\n<span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> index.handler\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span> ANY /\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'ANY {proxy+}'</span></code></pre></div>\n<p>This will setup an Amazon API Gateway proxy endpoint for the <code class=\"language-text\">app</code> function which will allow any custom routes to be handled by your Express.js application. You can do this by creating a single function <code class=\"language-text\">app</code> with a handler of <code class=\"language-text\">index.handler</code> pointing towards the <code class=\"language-text\">handler</code> function we just created inside of the <code class=\"language-text\">index.js</code> file.</p>\n<p>You’ll also need to make sure that the <code class=\"language-text\">org</code> and <code class=\"language-text\">app</code> values are included in the file and reference your Framework Pro account.</p>\n<p>From there, just run <code class=\"language-text\">serverless deploy</code> and you should get a new endpoint to test out:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/troubleshooting-monolambdas/new_endpoint.png\" alt=\"New Endpoint\"></p>\n<p>From there, just load up the endpoint in to your browser and test out the <code class=\"language-text\">hello/name</code> route:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/troubleshooting-monolambdas/hello_fernando.png\" alt=\"New Endpoint\"></p>\n<p>After you test the endpoint out, you should see it appear in the <a href=\"http://dashboard.serverless.com/\">Framework Pro</a> Dashboard under the explorer for that service:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/troubleshooting-monolambdas/hello_name_explorer.png\" alt=\"New Endpoint\"></p>\n<p>From there, you can add new routes, test them, and monitor and troubleshoot the rest of your application!</p>\n<p><strong>Flask</strong></p>\n<p>Let’s try the same thing with a simple Flask application. To start, I’ll assume you have Python 3 installed, along with the updated Serverless Framework version from earlier and Node/NPM.</p>\n<p>First, run <code class=\"language-text\">echo Flask &gt; requirements.txt</code> to create a <code class=\"language-text\">requirements.txt</code> file that you can use to install Flask and other dependencies when deploying to AWS. </p>\n<p>Then, create an <code class=\"language-text\">app.py</code> file that contains your Flask routes:</p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token comment\"># app.py</span>\n\n<span class=\"token keyword\">from</span> flask <span class=\"token keyword\">import</span> Flask\napp <span class=\"token operator\">=</span> Flask<span class=\"token punctuation\">(</span>__name__<span class=\"token punctuation\">)</span>\n\n<span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/hello/&lt;name>'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">hello</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string\">'Hello '</span> <span class=\"token operator\">+</span> name <span class=\"token operator\">+</span> <span class=\"token string\">'!'</span></code></pre></div>\n<p>Next, create a <code class=\"language-text\">serverless.yml</code> file that you can use to deploy the app. It will have a single function that is configured using <code class=\"language-text\">wsgi_handler.handler</code> as the handler because we will be using the <code class=\"language-text\">serverless-wsgi</code> plugin to deploy our Flask application. It will also need the same HTTP events we configured earlier.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">org</span><span class=\"token punctuation\">:</span> myorg\n<span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> helloapp\n<span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> flask<span class=\"token punctuation\">-</span>api\n\n<span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token key atrule\">runtime</span><span class=\"token punctuation\">:</span> python3.7\n\n<span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> wsgi_handler.handler\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span> ANY /\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'ANY {proxy+}'</span>\n\n<span class=\"token key atrule\">custom</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">wsgi</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> app.app\n    <span class=\"token key atrule\">pythonBin</span><span class=\"token punctuation\">:</span> python3 <span class=\"token comment\"># Some systems with Python3 may require this</span>\n    <span class=\"token key atrule\">packRequirements</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n  <span class=\"token key atrule\">pythonRequirements</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">dockerizePip</span><span class=\"token punctuation\">:</span> non<span class=\"token punctuation\">-</span>linux\n\n<span class=\"token key atrule\">plugins</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> serverless<span class=\"token punctuation\">-</span>wsgi\n  <span class=\"token punctuation\">-</span> serverless<span class=\"token punctuation\">-</span>python<span class=\"token punctuation\">-</span>requirements</code></pre></div>\n<p>If you compare to the Express.js application, you’ll also notice that we have an additional <code class=\"language-text\">custom</code> and <code class=\"language-text\">plugins</code> section. These are to allow us to configure the plugins we need to deploy Python dependencies with <code class=\"language-text\">serverless-python-requirements</code> and to deploy Python monolambda apps with <code class=\"language-text\">serverless-wsgi</code>. </p>\n<p>Make sure to update the <code class=\"language-text\">app</code> and <code class=\"language-text\">org</code> names with your own <a href=\"http://dashboard.serverless.com/\">Framework Pro</a> configuration.</p>\n<p>From there, we’ll need to install these plugins with:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm install serverless-wsgi --save \nnpm install serverless-python-requirements --save</code></pre></div>\n<p>After we install these plugins, we can deploy our application with <code class=\"language-text\">serverless deploy</code>! You may also need to install Docker in order to use <code class=\"language-text\">serverless-python-requirements</code>.</p>\n<p>After your service has deployed, you should see a new endpoint to use:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/troubleshooting-monolambdas/new_endpoint_flask.png\" alt=\"New Endpoint Flask\"></p>\n<p>Then, you can test the endpoint in to your browser and see how the <code class=\"language-text\">hello/name</code> route works:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/troubleshooting-monolambdas/hello_fernando_flask.png\" alt=\"New Endpoint Flask Test\"></p>\n<p>Then, you will see the new endpoint appear in the <a href=\"http://dashboard.serverless.com/\">Framework Pro</a> Dashboard with the route you used:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/troubleshooting-monolambdas/hello_name_explorer_flask.png\" alt=\"Explorer Flask\"></p>\n<p>Now, you can add new Flask routes, test them all out and continue to monitor and troubleshoot your applications!</p>\n<h1>What Next?</h1>\n<p>Well, if you are just starting with Flask or Express.js or you’re not sure how to get it working with the Serverless Framework on AWS Lambda, you can look at these guides on creating your own applications with them:</p>\n<ul>\n<li><a href=\"https://serverless.com/blog/serverless-express-rest-api/\">Deploy a REST API using Serverless, Express and Node.js</a></li>\n<li><a href=\"https://serverless.com/blog/flask-python-rest-api-serverless-lambda-dynamodb/\">Build a Python REST API with Serverless, Lambda, and DynamoDB</a></li>\n</ul>\n<p>If you’d like a more full-fledged example application to review, you can look at an example “Survey Service” that contains a handful of entities like customers, surveys and responses to surveys. It then takes these entities, stores them in DynamoDB and makes them accessible via different API routes. I’ve created the service with both <a href=\"https://github.com/fernando-mc/serverless-express\">Express.js and Node.js</a> and <a href=\"https://github.com/fernando-mc/serverless-flask\">Python3 and Flask</a>.</p>","frontmatter":{"title":"Announcing Troubleshooting Monolambdas with Express.js and Flask","date":"March 31, 2020","description":"You can now automatically monitor and troubleshoot monolambdas like Express.js and Flask with the Serverless Framework Pro!"}}},"pageContext":{"slug":"/posts/2020-03-31-announcing-troubleshooting-monolambdas/","previous":{"fields":{"slug":"/posts/2020-03-13-official-guide-aws-http-apis/"},"frontmatter":{"title":"The Official Guide to AWS HTTP APIs"}},"next":{"fields":{"slug":"/posts/2020-04-02-serverless-components-ga/"},"frontmatter":{"title":"Announcing Serverless Components GA"}}}}}