{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/2017-09-11-serverless-api-gateway-domain/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"022ca9ab-7eb7-56a9-a139-c7a3e871d139","excerpt":"With Serverless, it’s easier than ever to deploy production-ready API endpoints. However, using AWS API Gateway results in odd hostnames for your endpoints…","html":"<p>With Serverless, it’s easier than ever to deploy production-ready API endpoints. However, using <a href=\"https://serverless.com/amazon-api-gateway/\">AWS API Gateway</a> results in odd hostnames for your endpoints. Further, these hostnames will change if you remove and redeploy your service, which can cause problems for existing clients.</p>\n<p>In this guide, I’ll show you how to map a custom domain name to your endpoints.</p>\n<p>This post is the first in a two-part series. Check out the next post to configure <a href=\"https://serverless.com/blog/api-gateway-multiple-services/\">multiple Serverless services on the same domain name</a> for maximum microservice awesomeness.</p>\n<h4>Before you start</h4>\n<p>To get started, you’ll need the <a href=\"https://serverless.com/framework/docs/providers/aws/guide/quick-start/\">Serverless Framework</a> installed.</p>\n<p>You should also have your desired domain name registered through AWS. Read the documentation on that <a href=\"http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/registrar.html\">here</a>.</p>\n<h4>Getting a certificate for your domain</h4>\n<p>The steps below walk through setting up a certificate for your domain. If you already have a certificate issued, skip to the next section.</p>\n<p>API Gateway requests must be served over HTTPS, so you need to get an SSL/TLS certificate. You may manually upload your certificate to Amazon, but I find it easier to use AWS Certificate Manager to handle my certificates. Best of all, it’s free!</p>\n<p>To set up the certificate:</p>\n<p>First, make sure you have the domain name in your <a href=\"https://console.aws.amazon.com/route53/home?#DomainListing:\">Registered Domains</a> in Route 53.</p>\n<img width=\"1324\" alt=\"Route 53 Registered Domains\" src=\"https://user-images.githubusercontent.com/6509926/30004079-329556f2-908e-11e7-94a8-f1ed63367a5a.png\">\n<p>If you have a domain that’s registered with a different registrar, you can <a href=\"http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/domain-transfer-to-route-53.html\">transfer registration to Route 53</a>. If you don’t have a domain yet, you can purchase one through Route 53.</p>\n<p>Once you have your domain, <a href=\"https://console.aws.amazon.com/acm/home?region=us-east-1#/wizard/\">request a new certificate</a> with the AWS Certificate Manager. <strong>Note that you’ll need to be in region us-east-1</strong>. This is the only region that works with API Gateway.</p>\n<img width=\"1322\" alt=\"Request a Certificate\" src=\"https://user-images.githubusercontent.com/6509926/30004102-a01f7586-908e-11e7-882f-3c72e928f65a.png\">\n<p>Add the domain name you want, then hit Review and Request. After you confirm, it will say that a confirmation email has been sent to the registered owner of the domain to confirm the certificate. At this point, the certificate will be in a “Pending validation” status.</p>\n<img width=\"1322\" alt=\"Certificate Pending Validation\" src=\"https://user-images.githubusercontent.com/6509926/30004126-11db2e0e-908f-11e7-821d-70092a330d37.png\">\n<p>The registered owner of your domain will get a confirmation email from AWS. Click the link in the email to confirm issuance of the certificate. Once you do that, the certificate will change to an “Issued” status.</p>\n<img width=\"1296\" alt=\"Certificate Issued\" src=\"https://user-images.githubusercontent.com/6509926/30004144-58c61c7a-908f-11e7-8bc9-0d7b538a0a52.png\">\n<p>Your certificate is ready to go! Move on to the next step to create a custom domain in API Gateway.</p>\n<h4>Create your serverless backend</h4>\n<p>Before you go any further, you should have a Serverless service with at least one function that has an HTTP event trigger. If you don’t have that, you can use the code below. This example is in Python, but any runtime will work.</p>\n<p>In a clean directory, add a <code class=\"language-text\">handler.py</code> file with the following contents:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># handler.py</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">hello</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    response <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"statusCode\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"body\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Hello, world!'</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> response\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">goodbye</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    response <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"statusCode\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"body\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Goodbye, world!'</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> response</code></pre></div>\n<p>We’ve created two simple functions, <code class=\"language-text\">hello</code> and <code class=\"language-text\">goodbye</code>, to demonstrate how to write HTTP handlers in Serverless. Now, let’s connect them with a Serverless service. Create a <code class=\"language-text\">serverless.yml</code> file with the following contents:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token comment\"># serverless.yml</span>\n\n<span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> serverless<span class=\"token punctuation\">-</span>http\n\n<span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token key atrule\">runtime</span><span class=\"token punctuation\">:</span> python3.6\n\n<span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">hello</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.hello\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> hello\n          <span class=\"token key atrule\">method</span><span class=\"token punctuation\">:</span> get\n  <span class=\"token key atrule\">goodbye</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.goodbye\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> goodbye\n          <span class=\"token key atrule\">method</span><span class=\"token punctuation\">:</span> get</code></pre></div>\n<p>This <code class=\"language-text\">serverless.yml</code> file configures the functions to respond to HTTP requests. It says that the <code class=\"language-text\">hello</code> function will be triggered on the <code class=\"language-text\">/hello</code> path of your API Gateway, while the <code class=\"language-text\">goodbye</code> function will be triggered on the <code class=\"language-text\">/goodbye</code> path.</p>\n<p>Run <code class=\"language-text\">sls deploy</code> to send your function to production:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ sls deploy\n\nService Information\nservice: serverless-http\nstage: dev\nregion: us-east-1\nstack: serverless-http-dev\napi keys:\n  None\nendpoints:\n  GET - https://4aan6avk54.execute-api.us-east-1.amazonaws.com/dev/hello\n  GET - https://4aan6avk54.execute-api.us-east-1.amazonaws.com/dev/goodbye\nfunctions:\n  hello: serverless-http-dev-hello\n  goodbye: serverless-http-dev-goodbye</code></pre></div>\n<p>Once the deploy is finished, you will see the Service Information output. This includes the API Gateway domain where you can trigger your functions. In the example above, my <code class=\"language-text\">hello</code> function is available at <code class=\"language-text\">https://4aan6avk54.execute-api.us-east-1.amazonaws.com/dev/hello</code>.  I can visit that in my browser:</p>\n<img width=\"1128\" alt=\"Hello Endpoint\" src=\"https://user-images.githubusercontent.com/6509926/30276986-1e40fcf8-96cc-11e7-86d4-b73f2d740591.png\">\n<p>and I get my <code class=\"language-text\">Hello, world!</code> response. If I change to the <code class=\"language-text\">/goodbye</code> endpoint, I’ll get the <code class=\"language-text\">Goodbye, world!</code> response.</p>\n<p>It’s nice how easy this is to get a production API endpoint, but this still isn’t ideal. My domain is impossible to remember (<code class=\"language-text\">4aan6avk54.execute-api.us-east-1.amazonaws.com</code>). Plus, if I ever remove my service and then redeploy, I’ll get a new random domain.</p>\n<p>Finally, the path is odd as well — <code class=\"language-text\">/dev/hello</code> includes my stage as well as my actual page. I’d rather have a cleaner path. This shows the need for using a custom domain.</p>\n<h4>Create a custom domain in API Gateway</h4>\n<p>By this point, you should have an issued certificate and a Serverless service with an HTTP event configured. Now you need to create a custom domain in API Gateway that you can use with your deployed gateways.</p>\n<p>The easiest way to do this with Serverless is with the <a href=\"https://github.com/amplify-education/serverless-domain-manager\">serverless-domain-manager</a> plugin. Big thanks to the people at Amplify Education for developing this plugin.</p>\n<p>To use the plugin, first make sure you have a <code class=\"language-text\">package.json</code> file in your service. Run <code class=\"language-text\">npm init -y</code> to generate one.</p>\n<p>Then, you’ll need to install the plugin in your service:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">npm</span> <span class=\"token function\">install</span> serverless-domain-manager --save-dev</code></pre></div>\n<p>Then, configure it into your <code class=\"language-text\">serverless.yml</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">plugins</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> serverless<span class=\"token punctuation\">-</span>domain<span class=\"token punctuation\">-</span>manager\n\n<span class=\"token key atrule\">custom</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">customDomain</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">domainName</span><span class=\"token punctuation\">:</span> &lt;registered_domain_name<span class=\"token punctuation\">></span>\n    <span class=\"token key atrule\">basePath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">''</span>\n    <span class=\"token key atrule\">stage</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>self<span class=\"token punctuation\">:</span>provider.stage<span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">createRoute53Record</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></code></pre></div>\n<p>Make sure you replace the <code class=\"language-text\">domainName</code> value with the domain name that you’ve configured your certificate for. If you’re using a certificate that doesn’t exactly match your domain name, such as a wildcard certificate, you’ll need to specify the certificate name with a <code class=\"language-text\">certificateName</code> property under <code class=\"language-text\">customDomain</code>.</p>\n<p>Once this is ready, you can create your custom domain with a single command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ sls create_domain\nServerless: Domain was created, may take up to <span class=\"token number\">40</span> mins to be initialized</code></pre></div>\n<p>As the output notes, it can take up to 40 minutes for your domain to be ready. This is how long it takes AWS to provision a CloudFront distribution. In my experience, it generally takes 10-20 minutes.</p>\n<p>Once your domain name is ready, run <code class=\"language-text\">sls deploy</code> again to redeploy your service:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ sls deploy\n\nService Information\nservice: serverless-http\nstage: dev\nregion: us-east-1\nstack: serverless-http-dev\napi keys:\n  None\nendpoints:\n  GET - https://4aan6avk54.execute-api.us-east-1.amazonaws.com/dev/hello\n  GET - https://4aan6avk54.execute-api.us-east-1.amazonaws.com/dev/goodbye\nfunctions:\n  hello: serverless-http-dev-hello\n  goodbye: serverless-http-dev-goodbye\n\nServerless Domain Manager Summary\nDomain Name\n  mysubdomain.serverless.com\nDistribution Domain Name\n  a2fcnefljuq1t1.cloudfront.net</code></pre></div>\n<p>At the end of the <code class=\"language-text\">Service Information</code> block, you’ll also get a <code class=\"language-text\">Serverless Domain Manager Summary</code> that shows the domain name associated with your domain. Now you can visit that domain in your browser with the cleaner path that you’ve assigned to your functions:</p>\n<img width=\"1130\" alt=\"Hello Endpoint Custom Domain\" src=\"https://user-images.githubusercontent.com/6509926/30277377-3a1921fc-96cd-11e7-8f76-3e7e736d38f8.png\">\n<p>Voila! You have a much cleaner URL for your endpoints.</p>\n<p>If you want to put multiple services on the same domain, be sure to check out the <a href=\"https://serverless.com/blog/api-gateway-multiple-services/\">follow up post</a>!</p>","frontmatter":{"title":"How to set up a custom domain name for Lambda & API Gateway with Serverless","date":"September 11, 2017","description":"Learn how to set up a custom domain name for AWS Lambda & API Gateway using the Serverless Framework to configure a clean domain name for your services."}}},"pageContext":{"slug":"/posts/2017-09-11-serverless-api-gateway-domain/","previous":{"fields":{"slug":"/posts/2017-09-08-serverless-ops-logs/"},"frontmatter":{"title":"Serverless Ops 102 - CloudWatch Logs and Centralized Logging with AWS Lambda"}},"next":{"fields":{"slug":"/posts/2017-09-12-event-driven-serverless-app-local-dev-exp/"},"frontmatter":{"title":"Writing an Event-driven Serverless Application with Full Local Development Experience"}}}}}