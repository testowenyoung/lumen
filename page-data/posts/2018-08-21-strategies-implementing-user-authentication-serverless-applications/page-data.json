{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/2018-08-21-strategies-implementing-user-authentication-serverless-applications/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"bcb8b722-1fda-5cfa-959e-fa4bb1e44609","excerpt":"Searching for a way to do user authentication in your serverless project? Look no further. In this post I’ll be covering robust approaches to storing…","html":"<p>Searching for a way to do user authentication in your serverless project?</p>\n<p>Look no further. In this post I’ll be covering robust approaches to storing authentication-related data in serverless applications!</p>\n<p>We’ll talk about storing user information with sessions and JWT, token validity with Lambda Custom Authorizers, user management from scratch vs hosted services, and so much more. (Spoiler alert: there is no one perfect solution.)</p>\n<p>I’ll cover a few examples of implementing both authentication and user management, and give my thoughts on the future of authentication mechanisms for the Serverless architecture.</p>\n<p>I’ll be mentioning the following examples in this post; feel free to check them out beforehand if you’d like:</p>\n<ul>\n<li><a href=\"https://github.com/serverless/examples/tree/master/aws-node-auth0-custom-authorizers-api\">API Gateway + Custom Authorizer + Auth0</a></li>\n<li><a href=\"https://github.com/adnanrahic/a-crash-course-on-serverless-auth\">Serverless Authentication + Authorization</a></li>\n</ul>\n<h4>Where to store user information</h4>\n<p>When implementing authentication in your Serverless project, there are two steps: (1) give your users the ability to identify themselves, (2) retrieve their identity in your Serverless functions.</p>\n<p>The most common ways to accomplish this are storing user sessions, and writing user information inside JSON Web Tokens.</p>\n<h5>Sessions - standard approach</h5>\n<p>Sessions are a standard for storing authentication-related information.</p>\n<p>Upon authentication, the user gets a token. The token is then sent to the server on every request, and used to look up user information in the database—the status of the session, expiration time, and authentication scopes.</p>\n<p>Typically, you would store session data in either Redis or Memcached. But for Serverless projects, it makes sense to use hosted datastores instead—Amazon ElastiCache or DynamoDB, Google Cloud Datastore, etc.</p>\n<p>The down side is, hitting DynamoDB or another datastore to retrieve session information can be a challenge. With a high enough load on your application, retrieving sessions might add a significant amount to the datastore costs and increase page load times for users. Not so optimal.</p>\n<h5>JWT - convenient for serverless</h5>\n<p>Enter JSON Web Tokens (JWT), a growing favorite for serverless projects.</p>\n<p>The authentication mechanism here is similar to sessions, in that the user gets a token upon logging in, and then sends that token back to the endpoint on every request. But JWT has a key advantage; it makes it easy to store additional user information directly in the token, not just the access credentials.</p>\n<p>On every request, the user will send the whole token to the endpoint. If you store their username or access scopes in the JWT token, it will be very easy to access that information in every HTTP request you receive.</p>\n<h5>The good</h5>\n<p>This has a number of benefits for serverless projects compared to sessions:</p>\n<ul>\n<li>you don’t have to access the datastore for getting user information, which can decrease operational costs significantly</li>\n<li>changing the shape of the data stored in JWT tokens during development is faster, and that enables easier experiments</li>\n<li>implementing JWT can be just plain easier than reading and writing sessions</li>\n</ul>\n<h5>The bad</h5>\n<p>Unfortunately, JWT isn’t a holy grail:</p>\n<ul>\n<li>JWT tokens are larger than average session keys, so your clients may be sending more data to your endpoints overall</li>\n<li>All issued tokens are encrypted with a single keypair. If a leak occurs, the keypair-affected applications would need to invalidate all existing JWT tokens. Clients are allowed to choose the encryption method used on the JWT token issued to them, which could potentially expose additional attack vectors. (This <a href=\"https://www.nds.rub.de/media/ei/veroeffentlichungen/2017/10/17/main.pdf\">whitepaper</a> on the topic is quite thought-provoking.)</li>\n<li>Implementing authentication via JWT in a production app certainly requires spending extra time on ensuring that the tokens are used correctly, that you only store the most necessary information in the tokens, and that you are keeping your encryption keys safe.</li>\n</ul>\n<h4>Where to check session or token validity?</h4>\n<p>So when and where should you check the user’s credentials inside your app?</p>\n<p>One solution would be to check the JWT or session content on every call to any of your functions. This gives you the most control over the authentication flow, but it is complicated to implement; you have to do everything yourself. It’s also not optimal from the database access standpoint.</p>\n<p>Another solution that improves on some of these issues is using Custom Authorizers supported by API Gateway.</p>\n<h5>Lambda Custom Authorizers</h5>\n<p>AWS Lambda offers a convenient way to perform authentication outside of your core functions. With API Gateway’s Custom Authorizers, you can specify a separate Lambda function that is <em>only</em> going to take care of authenticating your users.</p>\n<p>In <code class=\"language-text\">serverless.yml</code>, you can specify custom authorizers as follows:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">create</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> posts.create\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> posts/create\n          <span class=\"token key atrule\">method</span><span class=\"token punctuation\">:</span> post\n          <span class=\"token key atrule\">authorizer</span><span class=\"token punctuation\">:</span> authorizerFunc <span class=\"token comment\"># execute this before posts.create!</span>\n  <span class=\"token key atrule\">authorizerFunc</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.authorizerFunc</code></pre></div>\n<p>Custom Authorizers are currently only supported in joint use of Amazon API Gateway + Lambda. The Authorizer function has to return a policy of  a specific shape. It’s a little inconvenient at first, but gets you access to a lot of flexibility.</p>\n<p>Amazon provides a blueprint for implementing authorizer functions, which you can find <a href=\"https://github.com/awslabs/aws-apigateway-lambda-authorizer-blueprints/blob/master/blueprints/nodejs/index.js\">right\nhere</a>.</p>\n<p>You can also find a working implementation of an Authorizer function <a href=\"https://github.com/serverless/examples/tree/master/aws-node-auth0-custom-authorizers-api\">here in the Serverless Examples repo</a>.</p>\n<p>The best part: API Gateway will cache the resulting policy that gets returned by the Authorizer function for up to one hour. If the Custom Authorizer gets user information from, say, DynamoDB, this caching is going to reduce DynamoDB traffic significantly and improve the load times of your Serverless app’s endpoints. Nice.</p>\n<p>Check out our documentation on <a href=\"https://serverless.com/framework/docs/providers/aws/events/apigateway/#http-endpoints-with-custom-authorizers\">using the Custom Authorizers with the Serverless Framework</a>.</p>\n<h4>User management from scratch vs hosted services</h4>\n<p>To manage users, you’ll need to create and delete them, as well as log them in and out. So the the big question is: should you manage users entirely yourself, or use a hosted service?</p>\n<h5>Implementing it yourself</h5>\n<p>This basically requires a CRUD interface for your Users database, plus a <code class=\"language-text\">login</code> method to generate a new JWT token or to create a session. Those can be implemented as separate functions.</p>\n<p>I found <a href=\"https://github.com/adnanrahic/a-crash-course-on-serverless-auth/blob/master/auth/AuthHandler.js\">this example</a> to be very useful. The Register User function is simply:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// https://github.com/adnanrahic/a-crash-course-on-serverless-auth/blob/master/auth/AuthHandler.js</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">eventBody</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">checkIfInputIsValid</span><span class=\"token punctuation\">(</span>eventBody<span class=\"token punctuation\">)</span> <span class=\"token comment\">// validate input</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n      User<span class=\"token punctuation\">.</span><span class=\"token function\">findOne</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> email<span class=\"token operator\">:</span> eventBody<span class=\"token punctuation\">.</span>email <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// check if user exists</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user</span> <span class=\"token operator\">=></span>\n      user\n        <span class=\"token operator\">?</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'User with that email exists.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">:</span> bcrypt<span class=\"token punctuation\">.</span><span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>eventBody<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// hash the pass</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">hash</span> <span class=\"token operator\">=></span>\n      User<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> name<span class=\"token operator\">:</span> eventBody<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">,</span> email<span class=\"token operator\">:</span> eventBody<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">,</span> password<span class=\"token operator\">:</span> hash <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// create the new user</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> auth<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> token<span class=\"token operator\">:</span> <span class=\"token function\">signToken</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>_id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// sign the token and send it back</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Which then gets wrapped in a handler:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// https://github.com/adnanrahic/a-crash-course-on-serverless-auth/blob/master/auth/AuthHandler.js</span>\n\nmodule<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">register</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event<span class=\"token punctuation\">,</span> context</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  context<span class=\"token punctuation\">.</span>callbackWaitsForEmptyEventLoop <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">connectToDatabase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n      <span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">session</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      statusCode<span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n      body<span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>session<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      statusCode<span class=\"token operator\">:</span> err<span class=\"token punctuation\">.</span>statusCode <span class=\"token operator\">||</span> <span class=\"token number\">500</span><span class=\"token punctuation\">,</span>\n      headers<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">'Content-Type'</span><span class=\"token operator\">:</span> <span class=\"token string\">'text/plain'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      body<span class=\"token operator\">:</span> err<span class=\"token punctuation\">.</span>message\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>And specified in the <code class=\"language-text\">serverless.yml</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token comment\"># https://github.com/adnanrahic/a-crash-course-on-serverless-auth/blob/master/serverless.yml</span>\n<span class=\"token punctuation\">...</span>\n  <span class=\"token key atrule\">register</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> auth/AuthHandler.register\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> register\n          <span class=\"token key atrule\">method</span><span class=\"token punctuation\">:</span> post\n          <span class=\"token key atrule\">cors</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n<span class=\"token punctuation\">...</span></code></pre></div>\n<p>You can find the full example in <a href=\"https://github.com/adnanrahic/a-crash-course-on-serverless-auth\">this GitHub repo</a>.</p>\n<h5>Using hosted services</h5>\n<p>Services like Auth0 and Amazon Cognito handle creating users, logging them in, and storing sessions. If your goal is to allow users to log in with their social accounts or their corporate SAML identities, this is especially useful.</p>\n<p>With Auth0, your app’s frontend gets a JS element via the Auth0 SDK that displays a nice-looking login window, as in <a href=\"https://github.com/serverless/examples/blob/master/aws-node-auth0-custom-authorizers-api/frontend/app.js\">the example here</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// https://github.com/serverless/examples/blob/master/aws-node-auth0-custom-authorizers-api/frontend/app.js</span>\n\n<span class=\"token keyword\">const</span> lock <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Auth0Lock</span><span class=\"token punctuation\">(</span><span class=\"token constant\">AUTH0_CLIENT_ID</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">AUTH0_DOMAIN</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  auth<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    params<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      scope<span class=\"token operator\">:</span> <span class=\"token string\">'openid email'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    responseType<span class=\"token operator\">:</span> <span class=\"token string\">'token id_token'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>And then your Authorizer function will check the user’s token using the Auth0 public key:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// https://github.com/serverless/examples/blob/master/aws-node-auth0-custom-authorizers-api/handler.js</span>\n<span class=\"token operator\">...</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    jwt<span class=\"token punctuation\">.</span><span class=\"token function\">verify</span><span class=\"token punctuation\">(</span>tokenValue<span class=\"token punctuation\">,</span> <span class=\"token constant\">AUTH0_CLIENT_PUBLIC_KEY</span><span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">verifyError<span class=\"token punctuation\">,</span> decoded</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>verifyError<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 401 Unauthorized</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Unauthorized'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token function\">generatePolicy</span><span class=\"token punctuation\">(</span>decoded<span class=\"token punctuation\">.</span>sub<span class=\"token punctuation\">,</span> <span class=\"token string\">'Allow'</span><span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">.</span>methodArn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">...</span></code></pre></div>\n<p>All without a need for you to maintain the Users database. Pretty slick.</p>\n<h4>Conclusion</h4>\n<p>We’re unfortunately still in the early stages of authentication for serverless.</p>\n<p>While API Gateway provides a convenient way to implement authorization for Lambda functions (with, logically, more Lambda functions), other serverless compute providers don’t offer ways to conveniently authenticate users.</p>\n<p>And even authorizer functions in Lambda have their issues, with fairly complex policies and caching limitations.</p>\n<p>We are eager to see what solutions for authentication the serverless compute providers offer going forward, and are always happy to hear from you about how you’re handling authentication. Feel free to drop a comment, post <a href=\"https://forum.serverless.com/\">in our forum</a>, or <a href=\"https://twitter.com/goserverless\">hit us up on Twitter</a>.</p>","frontmatter":{"title":"Strategies for implementing user authentication in serverless applications","date":"August 21, 2018","description":"Implementing user authentication in serverless applications: storing user info with sessions & JWT, token validity with Lambda Custom Authorizers, user management & more."}}},"pageContext":{"slug":"/posts/2018-08-21-strategies-implementing-user-authentication-serverless-applications/","previous":{"fields":{"slug":"/posts/2018-08-16-host-your-own-cncf-cloudevents-compatible-event-gateway-kubernetes/"},"frontmatter":{"title":"Host your own CNCF CloudEvents compatible Event Gateway on Kubernetes, point to any FaaS"}},"next":{"fields":{"slug":"/posts/2018-08-28-things-consider-building-serverless-data-warehouse/"},"frontmatter":{"title":"Things to consider before building a serverless data warehouse"}}}}}