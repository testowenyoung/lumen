{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/2018-04-18-manage-canary-deployments-lambda-functions-serverless-framework/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"273da0b0-34e3-5138-8208-aecc27f666e0","excerpt":"When we update Lambda functions in serverless applications, we take a lot of precautions. We build tests to be confident that we are not introducing bugs or…","html":"<p>When we update Lambda functions in serverless applications, we take a lot of precautions.</p>\n<p>We build tests to be confident that we are not introducing bugs or breaking anything. We publish the update in different stages to check how it behaves in the cloud.</p>\n<p>And still, a tingling runs down our spines every time we release to production. We are never 100% sure that we won’t bump into an integration error, or that we didn’t overlook any edge cases.</p>\n<p>If that sounds like you, then fear no more! The <a href=\"https://github.com/davidgf/serverless-plugin-canary-deployments\">Canary Deployments Plugin</a> is your safety net.</p>\n<p>I built this plugin for the Serverless Framework to let you manage canary deployments with ease. Below, I’ll dive into how the plugin works and show you an example of the Canary Deployments Plugin in action.</p>\n<p>Ready? Awesome.</p>\n<h2>Background: Lambda Weighted Aliases + CodeDeploy = Peace of mind</h2>\n<p>The AWS team recently introduced <a href=\"https://docs.aws.amazon.com/lambda/latest/dg/lambda-traffic-shifting-using-aliases.html\">traffic shifting for Lambda function aliases</a>, which basically means that we can now split the traffic of our functions between two different versions. We just have to specify the percentage of incoming traffic we want to direct to the new release, and Lambda will automatically load balance requests between versions when we invoke the alias.</p>\n<p>So, instead of completely replacing our function for another version, we could take a more conservative approach making the new code coexist with the old stable one and checking how it performs.</p>\n<p>All this sounds great, but let’s be honest, changing aliases weights and checking how new functions behave by ourselves is not going to make our lives easier. Fortunately, AWS has the service we need: CodeDeploy.</p>\n<p><a href=\"https://docs.aws.amazon.com/codedeploy/latest/userguide/welcome.html\">CodeDeploy</a> is capable of automatically updating our functions’ aliases weights according to our preferences. Even better, it will also roll back automatically if it notices that something goes wrong.</p>\n<p>Basically, our Lambda function deployments will be on autopilot.</p>\n<h3>Canary deployments: before and after</h3>\n<p>Now let’s say we wanted to implement all this Weighted Alias + CodeDeploy stuff into our serverless application. To do this, we’d need to create some AWS resources.</p>\n<p>We’d need to first create a CodeDeploy application, a DeploymentGroup and an Alias for each function, plus some new permissions here and there, then replace all the event sources to trigger the aliases instead of <code class=\"language-text\">$Latest</code>…—yeah. Not actually that straightforward.</p>\n<p>But that was then, and this is now.</p>\n<p>Now, the <a href=\"https://github.com/davidgf/serverless-plugin-canary-deployments\">Canary Deployments Plugin</a> takes care of all those things for you! It makes gradual deployments simply a matter of configuration.</p>\n<h2>Integrating canary deployments into your serverless app</h2>\n<p>In the next sections, we’ll walk through the different options we can configure with the Canary Deployments Plugin.</p>\n<h3>Setting up the environment</h3>\n<p>We’ll create a simple Serverless service with one function exposed through API Gateway, making sure that we install the plugin.</p>\n<p>Our <code class=\"language-text\">serverless.yml</code> should look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> sls<span class=\"token punctuation\">-</span>canary<span class=\"token punctuation\">-</span>example\n\n<span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token key atrule\">runtime</span><span class=\"token punctuation\">:</span> nodejs6.10\n\n<span class=\"token key atrule\">plugins</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> serverless<span class=\"token punctuation\">-</span>plugin<span class=\"token punctuation\">-</span>canary<span class=\"token punctuation\">-</span>deployments\n\n<span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">hello</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.hello\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span> get hello</code></pre></div>\n<p>Our function will simply return a message:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">hello</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    statusCode<span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n    body<span class=\"token operator\">:</span> <span class=\"token string\">'Go Serverless v1.0! Your function executed successfully!'</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Which we should get by calling the endpoint after deploying our service:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">curl</span> https://your-api-gateway-endpoint.com/dev/hello\nGo Serverless v1.0<span class=\"token operator\">!</span> Your <span class=\"token keyword\">function</span> executed successfully<span class=\"token operator\">!</span></code></pre></div>\n<h3>Deploying the function gradually</h3>\n<p>This is where the fun starts. We’ll tell the plugin to split the traffic between the last two versions of our function during the next deploy, and gradually shift more traffic to the new one until it receives all the load.</p>\n<p>There are three different fashions of gradual deployments:</p>\n<ul>\n<li><strong>Canary</strong>: a specific amount of traffic is shifted to the new version during a certain period of time. When that time elapses, all the traffic goes to the new version.</li>\n<li><strong>Linear</strong>: traffic is shifted to the new version incrementally in intervals until it gets all of it.</li>\n<li><strong>All-at-once</strong>: the least gradual of all of them, all the traffic is shifted to the new version straight away.</li>\n</ul>\n<p>All we need now is to specify the parameters and type of deployment, by choosing any of the <a href=\"https://docs.aws.amazon.com/lambda/latest/dg/automating-updates-to-serverless-apps.html\">CodeDeploy’s deployment preference presets</a>: <code class=\"language-text\">Canary10Percent30Minutes</code>, <code class=\"language-text\">Canary10Percent5Minutes</code>, <code class=\"language-text\">Canary10Percent10Minutes</code>, <code class=\"language-text\">Canary10Percent15Minutes</code>, <code class=\"language-text\">Linear10PercentEvery10Minutes</code>, <code class=\"language-text\">Linear10PercentEvery1Minute</code>, <code class=\"language-text\">Linear10PercentEvery2Minutes</code>, <code class=\"language-text\">Linear10PercentEvery3Minutes</code> or <code class=\"language-text\">AllAtOnce</code>.</p>\n<p>We’ll pick <code class=\"language-text\">Linear10PercentEvery1Minute</code>, so that the new version of our function gets is incremented by 10% every minute, until it reaches 100%. For that, we only have to set <code class=\"language-text\">type</code> and <code class=\"language-text\">alias</code> (the name of the alias we want to create) under <code class=\"language-text\">deploymentSettings</code> in our function:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> sls<span class=\"token punctuation\">-</span>canary<span class=\"token punctuation\">-</span>example\n\n<span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token key atrule\">runtime</span><span class=\"token punctuation\">:</span> nodejs6.10\n\n<span class=\"token key atrule\">plugins</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> serverless<span class=\"token punctuation\">-</span>plugin<span class=\"token punctuation\">-</span>canary<span class=\"token punctuation\">-</span>deployments\n\n<span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">hello</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.hello\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span> get hello\n    <span class=\"token key atrule\">deploymentSettings</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> Linear10PercentEvery1Minute\n      <span class=\"token key atrule\">alias</span><span class=\"token punctuation\">:</span> Live</code></pre></div>\n<p>If we now update and deploy the function:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">hello</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    statusCode<span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n    body<span class=\"token operator\">:</span> <span class=\"token string\">'Wait, it is Serverless v1.26.11!'</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>We’ll notice that the requests are being load balanced between the two latest versions:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">curl</span> https://your-api-gateway-endpoint.com/dev/hello\nGo Serverless v1.0<span class=\"token operator\">!</span> Your <span class=\"token keyword\">function</span> executed successfully<span class=\"token operator\">!</span>\n$ <span class=\"token function\">curl</span> https://your-api-gateway-endpoint.com/dev/hello\nWait, it is Serverless v1.26.11<span class=\"token operator\">!</span></code></pre></div>\n<h3>Making sure you don’t break anything</h3>\n<p>Now our function is not deployed in a single flip, woohoo!</p>\n<p><em>But</em>, if we have to ensure that the whole system is behaving correctly by ourselves, we didn’t really achieve anything impressive, did we? We can add another AWS service to the mix to avoid this: CloudWatch Alarms</p>\n<p><strong>Note:</strong> read more on this in our <a href=\"https://serverless.com/blog/serverless-ops-metrics/\">CloudWatch alarms post</a>.</p>\n<p>We can provide CodeDeploy with a list of alarms to track during the deployment process, then cancel it and shift all the traffic to the old version if any of them turns into the <code class=\"language-text\">ALARM</code> state.</p>\n<p>In this example, we’ll monitor that our function doesn’t have any invocation error. We’ll be using <a href=\"https://github.com/ACloudGuru/serverless-plugin-aws-alerts\">A Cloud Guru’s Alerts Plugin</a> for this:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> sls<span class=\"token punctuation\">-</span>canary<span class=\"token punctuation\">-</span>example\n\n<span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token key atrule\">runtime</span><span class=\"token punctuation\">:</span> nodejs6.10\n\n<span class=\"token key atrule\">plugins</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> serverless<span class=\"token punctuation\">-</span>plugin<span class=\"token punctuation\">-</span>aws<span class=\"token punctuation\">-</span>alerts\n  <span class=\"token punctuation\">-</span> serverless<span class=\"token punctuation\">-</span>plugin<span class=\"token punctuation\">-</span>canary<span class=\"token punctuation\">-</span>deployments\n\n<span class=\"token key atrule\">custom</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">alerts</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">dashboards</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n\n<span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">hello</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.hello\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span> get hello\n    <span class=\"token key atrule\">alarms</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> foo\n        <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'AWS/Lambda'</span>\n        <span class=\"token key atrule\">metric</span><span class=\"token punctuation\">:</span> Errors\n        <span class=\"token key atrule\">threshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n        <span class=\"token key atrule\">statistic</span><span class=\"token punctuation\">:</span> Minimum\n        <span class=\"token key atrule\">period</span><span class=\"token punctuation\">:</span> <span class=\"token number\">60</span>\n        <span class=\"token key atrule\">evaluationPeriods</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n        <span class=\"token key atrule\">comparisonOperator</span><span class=\"token punctuation\">:</span> GreaterThanOrEqualToThreshold\n    <span class=\"token key atrule\">deploymentSettings</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> Linear10PercentEvery1Minute\n      <span class=\"token key atrule\">alias</span><span class=\"token punctuation\">:</span> Live\n      <span class=\"token key atrule\">alarms</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> HelloFooAlarm</code></pre></div>\n<p>The Canary Deployments plugin expects the logical ID of the CloudWatch alarms, which the Alerts plugin builds by concatenating the function name, the alarm name and the string “Alarm” in Pascal case.</p>\n<h3>End-to-end testing</h3>\n<p>By gradually deploying our function and being able to track CloudWatch metrics, we have all the tools we need to minimize the impact of a potential bug in our code. However, we could even avoid invoking a function version with errors by running CodeDeploy Hooks first.</p>\n<p>Hooks are simply Lambda functions triggered by CodeDeploy before and after traffic shifting takes place. It expects to get notified about the success or failure of the hook, only continuing to the next step if it succeeded. They are perfect for running end-to-end or integration tests and checking that all the pieces fit together in the cloud, since it’ll automatically roll back upon failure.</p>\n<p>This is how we can configure hooks:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> sls<span class=\"token punctuation\">-</span>canary<span class=\"token punctuation\">-</span>example\n\n<span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token key atrule\">runtime</span><span class=\"token punctuation\">:</span> nodejs6.10\n  <span class=\"token key atrule\">iamRoleStatements</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">Effect</span><span class=\"token punctuation\">:</span> Allow\n      <span class=\"token key atrule\">Action</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> codedeploy<span class=\"token punctuation\">:</span>*\n      <span class=\"token key atrule\">Resource</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token string\">\"*\"</span>\n\n<span class=\"token key atrule\">plugins</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> serverless<span class=\"token punctuation\">-</span>plugin<span class=\"token punctuation\">-</span>aws<span class=\"token punctuation\">-</span>alerts\n  <span class=\"token punctuation\">-</span> serverless<span class=\"token punctuation\">-</span>plugin<span class=\"token punctuation\">-</span>canary<span class=\"token punctuation\">-</span>deployments\n\n<span class=\"token key atrule\">custom</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">alerts</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">dashboards</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n\n<span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">hello</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.hello\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span> get hello\n    <span class=\"token key atrule\">alarms</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> foo\n        <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'AWS/Lambda'</span>\n        <span class=\"token key atrule\">metric</span><span class=\"token punctuation\">:</span> Errors\n        <span class=\"token key atrule\">threshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n        <span class=\"token key atrule\">statistic</span><span class=\"token punctuation\">:</span> Minimum\n        <span class=\"token key atrule\">period</span><span class=\"token punctuation\">:</span> <span class=\"token number\">60</span>\n        <span class=\"token key atrule\">evaluationPeriods</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n        <span class=\"token key atrule\">comparisonOperator</span><span class=\"token punctuation\">:</span> GreaterThanOrEqualToThreshold\n    <span class=\"token key atrule\">deploymentSettings</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> Linear10PercentEvery1Minute\n      <span class=\"token key atrule\">alias</span><span class=\"token punctuation\">:</span> Live\n      <span class=\"token key atrule\">preTrafficHook</span><span class=\"token punctuation\">:</span> preHook\n      <span class=\"token key atrule\">postTrafficHook</span><span class=\"token punctuation\">:</span> postHook\n      <span class=\"token key atrule\">alarms</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> HelloFooAlarm\n  <span class=\"token key atrule\">preHook</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> hooks.pre\n  <span class=\"token key atrule\">postHook</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> hooks.post</code></pre></div>\n<p>Notice that we need to grant our functions access to CodeDeploy, so that we can use <a href=\"https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/CodeDeploy.html\">its SDK</a> in the hooks.</p>\n<p>It should look something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> aws <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'aws-sdk'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> codedeploy <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">aws<span class=\"token punctuation\">.</span>CodeDeploy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>apiVersion<span class=\"token operator\">:</span> <span class=\"token string\">'2014-10-06'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">pre</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> deploymentId <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>DeploymentId<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> lifecycleEventHookExecutionId <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>LifecycleEventHookExecutionId<span class=\"token punctuation\">;</span>\n\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'We are running some integration tests before we start shifting traffic...'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">var</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      deploymentId<span class=\"token operator\">:</span> deploymentId<span class=\"token punctuation\">,</span>\n      lifecycleEventHookExecutionId<span class=\"token operator\">:</span> lifecycleEventHookExecutionId<span class=\"token punctuation\">,</span>\n      status<span class=\"token operator\">:</span> <span class=\"token string\">'Succeeded'</span> <span class=\"token comment\">// status can be 'Succeeded' or 'Failed'</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> codedeploy<span class=\"token punctuation\">.</span><span class=\"token function\">putLifecycleEventHookExecutionStatus</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span> <span class=\"token operator\">=></span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Validation test succeeded'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Validation test failed'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">post</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> deploymentId <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>DeploymentId<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> lifecycleEventHookExecutionId <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>LifecycleEventHookExecutionId<span class=\"token punctuation\">;</span>\n\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Check some stuff after traffic has been shifted...'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">var</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      deploymentId<span class=\"token operator\">:</span> deploymentId<span class=\"token punctuation\">,</span>\n      lifecycleEventHookExecutionId<span class=\"token operator\">:</span> lifecycleEventHookExecutionId<span class=\"token punctuation\">,</span>\n      status<span class=\"token operator\">:</span> <span class=\"token string\">'Succeeded'</span> <span class=\"token comment\">// status can be 'Succeeded' or 'Failed'</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> codedeploy<span class=\"token punctuation\">.</span><span class=\"token function\">putLifecycleEventHookExecutionStatus</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span> <span class=\"token operator\">=></span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Validation test succeeded'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Validation test failed'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Hooks are well-suited for running tests, but we could actually execute whatever else we need to happen before or after our function deployment too. We only have to keep in mind that we must notify CodeDeploy about the result of the hook; otherwise, it’ll assume that it failed if it doesn’t get any response within one hour.</p>\n<p><strong>Protip:</strong> we don’t really need to notify CodeDeploy in the Lambda function hook. We could trigger a background job that runs anywhere else and report the result from there.</p>\n<h2>Conclusion</h2>\n<p>CodeDeploy and Lambda Weighted Aliases take the deployment process of our Serverless functions to the next level.</p>\n<p>They significantly reduce the chances of releasing buggy code, and react automatically if anything goes wrong. Instead of publishing a new function version that gets all the invokations straight away, the deployment goes through different stages:</p>\n<ol>\n<li>The before traffic hook is executed.</li>\n<li>Traffic is shifted gradually to the new version and the provided CloudWatch alarms are monitored, canceling and rolling back if any of them is triggered.</li>\n<li>The after hook is executed.</li>\n</ol>\n<p>All those stages are executed in order. If any of them fails, the deployment will be considered as failed and the whole system will roll back to the previous state.</p>\n<p>You can get the code in the above example <a href=\"https://github.com/davidgf/sls-canary-example\">here</a>, and if you’re interested in the details of the underliying technology, check out <a href=\"https://hackernoon.com/canary-deployments-in-serverless-applications-b0f47fa9b409\">this post</a>.</p>\n<p>Happy safe deployments!</p>","frontmatter":{"title":"How to manage canary deployments on Lambda via the Serverless Framework","date":"April 18, 2018","description":"Never again fear breaking your Serverless application due to integration issues."}}},"pageContext":{"slug":"/posts/2018-04-18-manage-canary-deployments-lambda-functions-serverless-framework/","previous":{"fields":{"slug":"/posts/2018-04-16-how-to-create-a-rest-api-in-java-using-dynamodb-and-serverless/"},"frontmatter":{"title":"How to create a REST API in Java using DynamoDB and Serverless"}},"next":{"fields":{"slug":"/posts/2018-04-25-what-are-serverless-components-how-use/"},"frontmatter":{"title":"What are Serverless Components, and how do I use them?"}}}}}