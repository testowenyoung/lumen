{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/2019-05-30-serverless-local-development/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"7fcf47bd-6bc1-5015-9704-a0684d37c2e3","excerpt":"Developing Serverless applications is a very different way of building applications we’ve been building for decades now. We’ve gotten used to having awesome…","html":"<p>Developing Serverless applications is a very different way of building applications we’ve been building for decades now. We’ve gotten used to having awesome local tooling for us to essentially run our entire application on our local machine. Boy does this make development easier if you can just play around with the app as you build it without even requiring access to the Internet.</p>\n<p>Then microservices came along and things have dramatically changed. Serverless arrived to help ease that infrastructure burden that building an application consisting of many small services adds. But it still means we need to figure out what the new dev workflow looks like in a Serverless microservice world.</p>\n<p>So lets set some goals. By the end of this post we should understand how we can reclaim to a large degree the ability we have always had to develop our applications on our local machines but still set us up for integrating our services into a larger team.</p>\n<p>Oh, and one small caveat. With Serverless as a development methodology still in its infancy, the ideas expressed here are my own opinion born out of experience building multiple Serverless projects solo and with teams. There will be others with other ideas about how to accomplish the same thing. It doesn’t make any one right or wrong; we are all still working out the best ways to accomplish our goals.</p>\n<h3>Goals</h3>\n<p>What is it we want to accomplish in this article? Lets start with a list of items that we should hopefully have some answers for.</p>\n<ul>\n<li>The ability to execute and debug code locally in a repeatable way.</li>\n<li>Handling API calls to cloud vendor services locally.</li>\n<li>Unit testing.</li>\n</ul>\n<p>With that basic outline out of the way, lets get stuck in…</p>\n<h4>Local development</h4>\n<p>Because we are building microservices, we need to get used to the idea that we should not expect to run the entire application on our development machines. Having every service running constantly on your machine just so you can open up a web browser to “play” with the application offline doesn’t make much sense; especially if your application is going to consist of 10’s or even 100’s or 1000’s of seperate services.</p>\n<p>What we need to focus on then is getting each service running in some fashion locally so that we can easily execute the code we write; our handlers that will eventually be our Lambda functions that execute our business logic.</p>\n<p>To that end, I have, put together a Serverless bootstrap as I like to call it. It is publicly available as a <a href=\"https://gitlab.com/garethm/serverless-nodejs-template\">Gitlab Project</a> and is incredibly easy to use to get started. So lets get it cloned and go through some of the details.</p>\n<p><code class=\"language-text\">git clone https://gitlab.com/garethm/serverless-nodejs-template.git</code></p>\n<h5>Getting started</h5>\n<p>Once you have cloned the template, run <code class=\"language-text\">rm -rf .git</code> to get rid of the current .git folder so that it is ready for you to use for your own project. You will also notice some folders:</p>\n<ul>\n<li>src: This is where we will store our handler function code as well as our unit tests and any entities, classes or any other code we write.</li>\n<li>templates: This contains the base templates used by one of our plugins to generate new functions and tests.</li>\n</ul>\n<p>The <code class=\"language-text\">src/functions</code> and <code class=\"language-text\">src/test/functions</code> both already contain some example files for us to look at. Lets take a quick look at the <code class=\"language-text\">src/functions/exampleFunction.js</code> file:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token string\">'use strict'</span>\n\nmodule<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exampleFunction</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event<span class=\"token punctuation\">,</span> context</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    statusCode<span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n    body<span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      message<span class=\"token operator\">:</span> <span class=\"token string\">'Success!'</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>As you can see, this is a very simple function. Its only purpose is as a way for us to see that our local development environment is configured correctly. The other part of that is the test file; <code class=\"language-text\">src/test/functions/exampleFunctionTest.js</code></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/* eslint-env mocha */</span>\n<span class=\"token string\">'use strict'</span>\n\n<span class=\"token comment\">// tests for exampleFunction</span>\n<span class=\"token comment\">// Generated by serverless-mocha-plugin</span>\n\n<span class=\"token keyword\">const</span> mochaPlugin <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'serverless-mocha-plugin'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> dirtyChai <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dirty-chai'</span><span class=\"token punctuation\">)</span>\nmochaPlugin<span class=\"token punctuation\">.</span>chai<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>dirtyChai<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> expect <span class=\"token operator\">=</span> mochaPlugin<span class=\"token punctuation\">.</span>chai<span class=\"token punctuation\">.</span>expect\n<span class=\"token keyword\">let</span> wrapped <span class=\"token operator\">=</span> mochaPlugin<span class=\"token punctuation\">.</span><span class=\"token function\">getWrapper</span><span class=\"token punctuation\">(</span><span class=\"token string\">'exampleFunction'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'../../../src/functions/exampleFunction.js'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'exampleFunction'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'exampleFunction'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">before</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">done</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'implement tests here'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> wrapped<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>not<span class=\"token punctuation\">.</span>be<span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>It is this test file that really contains the brunt of our local development functionality. What do I mean? Well, if we want to actually execute the code in our function, we run this test. On the line <code class=\"language-text\">return wrapped.run({}).then((response) =&gt; {</code>, the run function contains whatever event object we want, in this case nothing. But it could be an API Gateway event object, SNS, S3, SQS, or any other possible event object a Lambda function could receive.</p>\n<h5>Running code locally</h5>\n<p>By default, the example function and test are linked together, so lets just execute the code in our function to see how it all works. Make sure you have the <code class=\"language-text\">mocha</code> plugin installed globally (<code class=\"language-text\">npm install -g mocha</code>) and then run the test from the root of the service:</p>\n<p><code class=\"language-text\">mocha src/test/functions/exampleFunctionTest.js</code></p>\n<p>What you should see are some successful results:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">exampleFunction\n    ✓ implement tests here\n\n\n  1 passing (8ms)</code></pre></div>\n<p>Lets make a small edit. On the line <code class=\"language-text\">return wrapped.run({}).then((response) =&gt; {</code> change it to: </p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">return</span> wrapped<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  body<span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    parameter<span class=\"token operator\">:</span> <span class=\"token string\">'value'</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></code></pre></div>\n<p>Then lets edit the function itself at <code class=\"language-text\">src/functions/exampleFunction.js</code> to look like:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token string\">'use strict'</span>\n\nmodule<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exampleFunction</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event<span class=\"token punctuation\">,</span> context</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> bodyObj <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">)</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>bodyObj<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    statusCode<span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n    body<span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      message<span class=\"token operator\">:</span> bodyObj<span class=\"token punctuation\">.</span>parameter\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>When you run <code class=\"language-text\">mocha src/test/functions/exampleFunctionTest.js</code> again you should now see our <code class=\"language-text\">console.log</code> included in the response. </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">exampleFunction\n{ parameter: &#39;value&#39; }\n    ✓ implement tests here\n\n\n  1 passing (9ms)</code></pre></div>\n<p>Thats it. We now have local execution working. You could use this very easily to setup mocha integration with your IDE of choice and even setup debugging so you can step through your code, line by line, inspecting variables and everything else that comes with a local debugger.</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/ServerlessLocalDevelopment/DebugLocalIDE.gif\" alt=\"VSCode Mocha Plugin\"></p>\n<p>One step in the right direction! But we don’t want to have to copy and paste the contents of this test file and its handler function everytime we want to create a new function!</p>\n<p>Well, we don’t have to. Because of the awesome <code class=\"language-text\">serverless-mocha-plugin</code> that has been responsible for making our lives easier so far, we can also use a CLI command that will create a function, a linked test file as well as an eventless entry into our serverless.yml for us. The command looks something like this:</p>\n<p><code class=\"language-text\">sls create function -f functioname --handler src/functions/fileName.handlerName --path src/test/functions/ --stage local</code></p>\n<p>For more details about this awesome plugin, check out the <a href=\"https://github.com/nordcloud/serverless-mocha-plugin\">Github page</a>.</p>\n<h5>AWS Services locally</h5>\n<p>One of the benefits of Serverless (especially in the AWS ecosystem) is that we have access to an incredible array of managed services that take away a large amount of the drudgery from building complex web applications. However, when you need to test code locally that tries to communicate to services such as S3, DynamoDB, SNS, SQS amongst others, it becomes tricky. There are many different ways people try to solve this problem but my favourite is a technique called mocking.</p>\n<p>By making use of another NPM module, <code class=\"language-text\">aws-sdk-mock</code>, we can capture requests that would normally go to an AWS service and then return … whatever we want. We can return a successful response or we can even simulate an AWS service error if we wish to test how we manage failures.</p>\n<p>To try this out, lets go back to our <code class=\"language-text\">src/test/functions/exampleFunctionTest.js</code> file and edit the test section to look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'implement tests here'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token constant\">AWS</span><span class=\"token punctuation\">.</span><span class=\"token function\">mock</span><span class=\"token punctuation\">(</span><span class=\"token string\">'S3'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'putObject'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">params</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> wrapped<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      body<span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        parameter<span class=\"token operator\">:</span> <span class=\"token string\">'value'</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>not<span class=\"token punctuation\">.</span>be<span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>All that we have done here is add a mock in to catch any call to S3’s <code class=\"language-text\">putObject</code> API call when we run our tests. In this case we are just responding with a success and an empty object. If we had returned with a <code class=\"language-text\">reject(new Error(&#39;Some error here!&#39;))</code>, our function would need to catch that error and deal with it; just like in the real world.</p>\n<p>The <code class=\"language-text\">aws-sdk-mock</code> module can do with this any SDK and API in the <code class=\"language-text\">aws-sdk</code> module and you should go <a href=\"https://www.npmjs.com/package/aws-sdk-mock\">check out more details here</a>.</p>\n<p>With the combination of those two plugins alone, we now have ways to run our functions locally, step through them with a debugger and even simulate success and failure response from the AWS services we will more than likely be using. The next step from here is to look at how we can incorporate this service we have been building in isolation into the rest of our application as a whole.</p>\n<p>If you have any comments to add, join us on the <a href=\"https://forum.serverless.com/\">Serverless Forum</a> or feel free to fork the project on Gitlab and make any merge requests to improve the bootstrap template.</p>","frontmatter":{"title":"Serverless Local Development","date":"May 30, 2019","description":"We're building serverless applications as collections of serverless microservices dependant on cloud infrastructure. So how do we develop locally?"}}},"pageContext":{"slug":"/posts/2019-05-30-serverless-local-development/","previous":{"fields":{"slug":"/posts/2019-05-29-serverless-microservice/"},"frontmatter":{"title":"Deploy a scalable API and Backend with Serverless, Express, and Node.js"}},"next":{"fields":{"slug":"/posts/2019-06-17-framework-release-v145/"},"frontmatter":{"title":"Serverless Framework v1.45.0 -  ALB event source, API Gateway Websocket logs, S3 hosted deployment packages, Custom configuration file names & More"}}}}}