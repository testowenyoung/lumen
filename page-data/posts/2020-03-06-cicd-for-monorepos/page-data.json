{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/2020-03-06-cicd-for-monorepos/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"8faca32f-945c-50b7-9bf7-8695016ef642","excerpt":"When building serverless applications as a collection of Serverless services, we need to decide whether we are going to push each service individually to our…","html":"<p>When building serverless applications as a collection of Serverless services, we need to decide whether we are going to push each service individually to our version control system, or bundle them all together as a single repo. This article is not going to go into the details about which is better or not, but all our posts so far seem to show examples of services all stored in individual repositories. </p>\n<p>What this article <strong>is</strong> going to demonstrate, however, is that deploying services from within a single monorepo is easily doable within Serverless Framework Pro’s CI/CD solution.</p>\n<h4>Getting started</h4>\n<p>It would be great if you could follow along, even if you do not have your very own monorepo to play with. So <a href=\"https://github.com/garethmcc/monrepotest\">here is one</a> you can use. It’s a little demonstration repo you can clone from Github and use in your own Serverless Framework Pro account, just change the <code class=\"language-text\">org</code> and <code class=\"language-text\">app</code> values in each of the four services to match one of your own.</p>\n<blockquote>\n<p><strong>NOTE:</strong> Serverless Framework Pro has a generous free tier so you don’t need to worry about not having a paid account just to try this feature out for yourself.</p>\n</blockquote>\n<p>Once you’ve cloned the repo, made the requisite <code class=\"language-text\">org</code> and <code class=\"language-text\">app</code> edit, you just need to push that back into a repo of your own for us to continue.</p>\n<p>The last step before we walk through setting up the monorepo deployment is to ensure that we have our connection to our AWS account all squared away, especially if you have a <a href=\"https://dashboard.serverless.com\">brand new dashboard account</a>. This is done by going to profiles on the top menu, selecting the profile we will be using and making sure an AWS account is connected.</p>\n<p>With that out of the way, lets get cracking!</p>\n<h4>Connecting to Github</h4>\n<p>Make sure you create the app within the org, using the same names you added to the services <code class=\"language-text\">serverless.yml</code> file as well; I have one I called <code class=\"language-text\">monorepotest</code> … super original I know. But once I have done that, I open the app and I should have a handy dandy <code class=\"language-text\">add service</code> button to click on. Doing that gives me two option. I want to choose <code class=\"language-text\">Deploy from Github</code>. You should then see a button to <code class=\"language-text\">connect to Github</code>. Click it and go through Github’s OAuth process to authorise Serverless Framework Pro to access the monorepo you are configuring. Once done and returned, you may or may not need to just refresh the page. When you see the image below we can move on:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/cicd-monorepo/DeployFromGithub.png\" alt=\"Deploy from github\"></p>\n<h4>Deploying our first service</h4>\n<p>Once we have that connection, we can use the <code class=\"language-text\">Select a repo</code> dropdown to choose our monorepo, and the <code class=\"language-text\">base directory</code> drop down now becomes available after a second or so. In this list we should see all the services we may want to deploy that are a part of this monorepo. If you are using the Github repo I linked to before, you can select <code class=\"language-text\">servicea</code>, and now we get even more options to choose from. </p>\n<p>We have covered preview deploys in <a href=\"https://serverless.com/blog/preview-deployments\">a previous blog post</a>, so I wont go into detail here on them; we are going to skip configuring that for now.</p>\n<p>Moving down to the branch deploys section, if you have not yet configured any kind of stage, you will be prompted to do that now. Just click through to create the stage and return to the deployment config when done.</p>\n<p>In <code class=\"language-text\">branch deploys</code>, we point our specific git branch to the stage we want to deploy to. If you only have a master branch and one stage this will automatically be selected and you just need to confirm. At this point you can just save the configuration and you are all set up. Merge into the master branch or deploy directly from the <code class=\"language-text\">deploy now</code> button and a deployment to your AWS account should begin! </p>\n<p>If you go ahead and do the same for all the other services in the monorepo, you will be fully setup with monorepo deployments to AWS; if code is pushed all services in the monorepo will redeploy. If you don’t want all of them to redeploy every time … read on.</p>\n<h4>More advanced configuration</h4>\n<h5>Selective deployments</h5>\n<p>By default, if you have multiple services of a monorepo configured and you merge a change anywhere in that repo, all services will redeploy, just in case. There’s no way for the system to know if there are any dependencies between the services so it cannot assume that only that one service that had a change should be redeployed.</p>\n<p>However, you can configure it differently.  If you open the CI/CD settings for one of the services and scroll down to expand the <code class=\"language-text\">advanced settings</code> section, you should see numerous options to help you maximise the efficiency of your CI/CD pipeline for a monorepo.</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/cicd-monorepo/advancedsettings.png\" alt=\"Advanced settings expanded\"></p>\n<p>By default, the <code class=\"language-text\">Always trigger a deployment</code> option is selected and means that this service will <strong>always</strong> be redeployed with any change to the git repository, even if there were no changes to the code of this service. If you only want this service redeployed when its own code is edited, uncheck the box and you should see something like:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/cicd-monorepo/TriggerDirectories.png\" alt=\"Trigger directories configuration\"></p>\n<p>Automatically, the directory of the current service is selected and you can just click <code class=\"language-text\">save settings</code>. From this point on, <code class=\"language-text\">servicea</code> will only be re-deployed when its own code is edited.</p>\n<h5>Dependency deployment</h5>\n<p>But what if you actually did have services that had dependencies on each other. So in the example with <code class=\"language-text\">servicea</code>, we could in fact link it to <code class=\"language-text\">serviceb</code> and configure it so that <code class=\"language-text\">servicea</code> will always be re-deployed when <code class=\"language-text\">serviceb</code> is also edited. Just by adding a reference to the correct service directory, I can ensure this will happen:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/cicd-monorepo/ServiceBAdded.png\" alt=\"Service B added\"></p>\n<p>I could of course do this for any number of services that <code class=\"language-text\">servicea</code> depends on and vice versa. But what if I have some kind of shared folder that <code class=\"language-text\">servicea</code> uses. Because we reference a directory structure in our configuration, you can point to any path in your monorepo to be watched for changes. In the example repo, we have a directory called <code class=\"language-text\">shared</code> that stores a number of classes and functions (or at least it could) that are re-used by multiple services. If I change anything in <code class=\"language-text\">shared</code>, multiple services need to redeploy.</p>\n<p>I can accomplish this just by adding the path to <code class=\"language-text\">shared</code>:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/cicd-monorepo/SharedAdded.png\" alt=\"Shared directory added\"></p>\n<p>In the image above, <code class=\"language-text\">servicea</code> will be deployed on merges to Github if changes are detected in directories <code class=\"language-text\">servicea</code>, <code class=\"language-text\">serviceb</code> or <code class=\"language-text\">shared</code>. And I can configure any service with any specific arrangement of dependencies I need, providing me a ton of great flexibility to deploy what I need under the right circumstances.</p>\n<p>Monorepo deployments are much simpler to manage using Serverless Framework Pro CI/CD. But if you do have any feedback for us or want to just share, please hop into our <a href=\"https://serverless.com/slack\">Slack channels</a> or <a href=\"https://forum.serverless.com\">Forums</a> and let us know. Or you can even <a href=\"https://twitter.com/garethmcc\">DM me on Twitter</a> if you have any questions.</p>","frontmatter":{"title":"CI/CD for monorepos","date":"March 06, 2020","description":"How do we deploy services all collected under a single monorepo in git?"}}},"pageContext":{"slug":"/posts/2020-03-06-cicd-for-monorepos/","previous":{"fields":{"slug":"/posts/2020-02-27-serverless-auth-with-aws-http-apis/"},"frontmatter":{"title":"Serverless Auth with AWS HTTP APIs"}},"next":{"fields":{"slug":"/posts/2020-03-10-lambda-destinations/"},"frontmatter":{"title":"AWS Lambda Destination Support"}}}}}