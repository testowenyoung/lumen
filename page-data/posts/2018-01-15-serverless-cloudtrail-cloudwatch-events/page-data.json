{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/2018-01-15-serverless-cloudtrail-cloudwatch-events/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"1ba956f9-59f7-5a27-afa5-5fcc5180de39","excerpt":"CloudTrail and CloudWatch Events are two powerful services from AWS that allow you to monitor and react to activity in your account—including changes in…","html":"<p>CloudTrail and CloudWatch Events are two powerful services from AWS that allow you to monitor and react to activity in your account—including changes in resources or attempted API calls.</p>\n<p>This can be useful for audit logging or real-time notifications of suspicious or undesirable activity.</p>\n<p>In this tutorial, we’ll set up two examples to work with CloudWatch Events and CloudTrail. The first will use standard CloudWatch Events to watch for changes in Parameter Store (SSM) and send notifications to a Slack channel. The second will use custom CloudWatch Events via CloudTrail to monitor for actions to create DynamoDB tables and send notifications.</p>\n<h2>Setting up</h2>\n<p>Before we begin, you’ll need the <a href=\"https://serverless.com/framework/docs/providers/aws/guide/quick-start/\">Serverless Framework installed</a> with an AWS account set up.</p>\n<p>The examples below will be in Python, but the logic is pretty straightforward. You can rewrite in any language you prefer.</p>\n<p>If you want to trigger on custom events using CloudTrail, you’ll need to set up a CloudTrail. In the AWS console, navigate to the <a href=\"https://console.aws.amazon.com/cloudtrail/home\">CloudTrail service</a>.</p>\n<p>Click “Create trail” and configure a trail for “write-only” management events:</p>\n<p><img src=\"https://user-images.githubusercontent.com/6509926/34655410-17f8ac5c-f3be-11e7-8d58-06ce4170b428.png\" alt=\"CloudTrail write-only events\"></p>\n<p>Have your trail write to a Cloudwatch Logs log group so you can subscribe to notifications:</p>\n<img width=\"987\" alt=\"CloudWatch Logs from CloudTrail\" src=\"https://user-images.githubusercontent.com/6509926/34655530-171b38a2-f3c0-11e7-8dbe-054b8df0418b.png\">\n<p>Both examples above post notifications to Slack via the Incoming Webhook app. You’ll need to set up an Incoming Webhook app if you want this to work.</p>\n<p>First, create or navigate to the Slack channel where you want to post messages. Click “Add an app”:</p>\n<img width=\"941\" alt=\"Slack - Add an app\" src=\"https://user-images.githubusercontent.com/6509926/34655579-c7901d10-f3c0-11e7-9a09-602a0fbe1c28.png\">\n<p>In the app search page, search for “Incoming Webhook” and choose to add one. Make sure it’s the room you want.</p>\n<p>After you click “Add Incoming Webhooks Integration”, it will show your Webhook URL. This is what you will use in your <code class=\"language-text\">serverless.yml</code> files for the <code class=\"language-text\">SLACK_URL</code> variable.</p>\n<p>If you want to, you can customize the name and icon of your webhook to make the messages look nicer. Below, I’ve used the “rotating-light” emoji and named my webhook “AWS Alerts”:</p>\n<img width=\"1008\" alt=\"Slack app customize name &amp; icon\" src=\"https://user-images.githubusercontent.com/6509926/34655596-135b1b78-f3c1-11e7-9ce3-5213e42330a3.png\">\n<p>With that all set up, let’s build our first integration!</p>\n<h2>Monitoring Parameter Store Changes</h2>\n<p>The first example we’ll do will post notifications of from AWS Parameter Store into our Slack channel. Big shout-out to <a href=\"https://twitter.com/esh\">Eric Hammond</a> for inspiring this idea; he’s an AWS expert and a great follow on Twitter:</p>\n<blockquote class=\"twitter-tweet\" data-lang=\"en\"><p lang=\"en\" dir=\"ltr\"><a href=\"https://twitter.com/hashtag/awswishlist?src=hash&amp;ref_src=twsrc%5Etfw\">#awswishlist</a> Ability to trigger AWS Lambda function when an SSM Parameter Store value changes.<br><br>That could then run CloudFormation update for stacks that use the parameter</p>&mdash; Eric Hammond (@esh) <a href=\"https://twitter.com/esh/status/946824737585373184?ref_src=twsrc%5Etfw\">December 29, 2017</a></blockquote>\n<script async src=\"https://platform.twitter.com/widgets.js\" charset=\"utf-8\"></script>\n<p>Parameter Store (also called SSM, for Simple Systems Manager) is a way to centrally store configuration, such as API keys, resource identifiers, or other config.</p>\n<p>(Check out our <a href=\"https://serverless.com/blog/serverless-secrets-api-keys/\">previous post</a> on using Parameter Store in your Serverless applications.)</p>\n<p>SSM integrates directly with CloudWatch Events to expose certain events when they occur. You can see the full list of CloudWatch Events <a href=\"https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/EventTypes.html\">here</a>. In this example, we are interested in the <code class=\"language-text\">SSM Parameter Store Change</code> event, which is fired whenever an SSM parameter is changed.</p>\n<p>CloudWatch Event subscriptions work by providing a filter pattern to match certain events. If the pattern matches, your subscription will send the matched event to your target.</p>\n<p>In this case, our target will be a Lambda function.</p>\n<p>Here’s an <a href=\"https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/EventTypes.html#SSM-Parameter-Store-event-types\">example SSM Parameter Store Event</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"6a7e4feb-b491-4cf7-a9f1-bf3703497718\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"detail-type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Parameter Store Change\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"source\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"aws.ssm\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"account\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"123456789012\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"time\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2017-05-22T16:43:48Z\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"region\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"us-east-1\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"resources\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"arn:aws:ssm:us-east-1:123456789012:parameter/foo\"</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"detail\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"operation\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Create\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"foo\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"String\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"description\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Sample Parameter\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We need to specify which elements of the Event are important to match for our subscription.</p>\n<p>There are two elements important here. First, we want the <code class=\"language-text\">source</code> to equal <code class=\"language-text\">aws.ssm</code>. Second, we want the <code class=\"language-text\">detail-type</code> to equal <code class=\"language-text\">Parameter Store Change</code>. This is narrow enough to exclude events we don’t care about, while still capturing all of the events by not specifying filters on the other fields.</p>\n<p>The Serverless Framework makes it really easy to <a href=\"https://serverless.com/framework/docs/providers/aws/events/cloudwatch-event/\">subscribe to CloudWatch Events</a>. For the function we want to trigger, we create a <code class=\"language-text\">cloudWatchEvent</code> event type with a mapping of our filter requirements.</p>\n<p>Here’s an example of our <code class=\"language-text\">serverless.yml</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> cloudwatch<span class=\"token punctuation\">-</span>ssm\n\n<span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token key atrule\">runtime</span><span class=\"token punctuation\">:</span> python3.6\n  <span class=\"token key atrule\">stage</span><span class=\"token punctuation\">:</span> dev\n  <span class=\"token key atrule\">region</span><span class=\"token punctuation\">:</span> us<span class=\"token punctuation\">-</span>east<span class=\"token punctuation\">-</span><span class=\"token number\">1</span>\n  <span class=\"token key atrule\">iamRoleStatements</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">Effect</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Allow\"</span>\n      <span class=\"token key atrule\">Action</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token string\">\"ssm:DescribeParameters\"</span>\n      <span class=\"token key atrule\">Resource</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"*\"</span>\n  <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">SLACK_URL</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'INSERT SLACK URL'</span>\n\n<span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">parameter</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.parameter\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">cloudwatchEvent</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">event</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">source</span><span class=\"token punctuation\">:</span>\n              <span class=\"token punctuation\">-</span> <span class=\"token string\">\"aws.ssm\"</span>\n            <span class=\"token key atrule\">detail-type</span><span class=\"token punctuation\">:</span>\n              <span class=\"token punctuation\">-</span> <span class=\"token string\">\"Parameter Store Change\"</span></code></pre></div>\n<p>Notice that the <code class=\"language-text\">functions</code> block includes our filter from above. There are two other items to note:</p>\n<ol>\n<li>We injected our Slack webhook URL into our environment as <code class=\"language-text\">SLACK_URL</code>. Make sure you update this with your actual webhook URL if you’re following along.</li>\n<li>We added an <a href=\"https://serverless.com/blog/abcs-of-iam-permissions/\">IAM statement</a> that gives us access to run the DescribeParameters command in SSM. This will let us enrich the changed parameter event by showing what version of the parameter we’re on and who changed it mostly recently. It <em>does not</em> provide permissions to read the parameter value, so it’s safe to give access to parameters with sensitive keys.</li>\n</ol>\n<p>Our <code class=\"language-text\">serverless.yml</code> says that our function is defined in a <code class=\"language-text\">handler.py</code> module with a function name of parameter. Let’s implement that now.</p>\n<p>Put this into your <code class=\"language-text\">handler.py</code> file:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># handler.py</span>\n\n<span class=\"token keyword\">import</span> json\n<span class=\"token keyword\">import</span> os\n\n<span class=\"token keyword\">from</span> botocore<span class=\"token punctuation\">.</span>vendored <span class=\"token keyword\">import</span> requests\n<span class=\"token keyword\">import</span> boto3\n\nSLACK_URL <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>environ<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'SLACK_URL'</span><span class=\"token punctuation\">)</span>\nCLIENT <span class=\"token operator\">=</span> boto3<span class=\"token punctuation\">.</span>client<span class=\"token punctuation\">(</span><span class=\"token string\">'ssm'</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">parameter</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    formatted <span class=\"token operator\">=</span> format_message<span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span>\n\n    send_to_slack<span class=\"token punctuation\">(</span>formatted<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">format_message</span><span class=\"token punctuation\">(</span>parameter_event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    name <span class=\"token operator\">=</span> parameter_event<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'detail'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">)</span>\n    operation <span class=\"token operator\">=</span> parameter_event<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'detail'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'operation'</span><span class=\"token punctuation\">)</span>\n    resp <span class=\"token operator\">=</span> CLIENT<span class=\"token punctuation\">.</span>describe_parameters<span class=\"token punctuation\">(</span>\n        Filters<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token string\">\"Key\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"Values\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n    last_modified_user <span class=\"token operator\">=</span> resp<span class=\"token punctuation\">[</span><span class=\"token string\">'Parameters'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'LastModifiedUser'</span><span class=\"token punctuation\">]</span>\n    version <span class=\"token operator\">=</span> resp<span class=\"token punctuation\">[</span><span class=\"token string\">'Parameters'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'Version'</span><span class=\"token punctuation\">]</span>\n\n    text <span class=\"token operator\">=</span> <span class=\"token string\">'\\n'</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"Paramater changed in SSM!\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"A *{}* operation was performed on parameter *{}*\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>operation<span class=\"token punctuation\">.</span>upper<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Change made by {}\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>last_modified_user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Parameter now on version {}\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>version<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"text\"</span><span class=\"token punctuation\">:</span> text\n    <span class=\"token punctuation\">}</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">send_to_slack</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">,</span> url<span class=\"token operator\">=</span>SLACK_URL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    resp <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> json<span class=\"token operator\">=</span>message<span class=\"token punctuation\">)</span>\n\n    resp<span class=\"token punctuation\">.</span>raise_for_status<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>This function takes the incoming event and assembles it into a format <a href=\"https://api.slack.com/docs/message-formatting\">expected by Slack</a> for its webhook. Then, it posts the message to Slack.</p>\n<p>Let’s deploy our service:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ sls deploy\nServerless: Packaging service<span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">..</span>. <span class=\"token operator\">&lt;</span>snip<span class=\"token operator\">></span> <span class=\"token punctuation\">..</span>.\nServerless: Stack update finished<span class=\"token punctuation\">..</span>.\nService Information\nservice: cloudwatch-ssm\nstage: dev\nregion: us-east-1\nstack: cloudwatch-ssm-dev\napi keys:\n  None\nendpoints:\n  None\nfunctions:\n  parameter: cloudwatch-ssm-dev-parameter</code></pre></div>\n<p>Then, let’s alter a parameter in SSM to trigger the event:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws ssm put-parameter <span class=\"token punctuation\">\\</span>\n  --name <span class=\"token string\">\"/Test/my-parameter\"</span> <span class=\"token punctuation\">\\</span>\n  --value <span class=\"token string\">\"Secret\"</span> <span class=\"token punctuation\">\\</span>\n  --type <span class=\"token string\">\"String\"</span></code></pre></div>\n<p><strong>Note:</strong> Make sure you’re running the <code class=\"language-text\">put-parameter</code> command in the same region that your service is deployed in.</p>\n<p>After a few minutes, you should get a notification in your Slack channel:</p>\n<p><img src=\"https://user-images.githubusercontent.com/6509926/34956556-41b964dc-f9ef-11e7-9015-adc119ca8c25.png\" alt=\"SSM Create Slack alert\"></p>\n<p>💥 Awesome!</p>\n<h2>Monitoring new DynamoDB tables with CloudTrail</h2>\n<p>In the previous example, we subscribed to SSM Parameter Store events. These events are already provided directly by CloudWatch Events.</p>\n<p>However, not all AWS API events are provided by CloudWatch Events. To get access to a broader range of AWS events, we can use <a href=\"https://aws.amazon.com/cloudtrail/\">CloudTrail</a>.</p>\n<p>Before you can use CloudTrail events in CloudWatch Event subscriptions, you’ll need to set up CloudTrail to write a CloudWatch log group. If you need help with this, it’s covered above in the <a href=\"#setting-up\">setting up</a> section.</p>\n<p>Once you’re set up, you can see the <a href=\"https://docs.aws.amazon.com/awscloudtrail/latest/userguide/view-cloudtrail-events-supported-services.html\">huge list of events</a> supported by CloudTrail event history.</p>\n<p>Generally, an event will be supported if it meets both of the following requirements:</p>\n<ol>\n<li>It is a <em>state-changing</em> event, rather than a read-only event. Think <code class=\"language-text\">CreateTable</code> or <code class=\"language-text\">DeleteTable</code> for DynamoDB, but not <code class=\"language-text\">DescribeTable</code>.</li>\n<li>It is a <em>management-level</em> event, rather than a data-level event. For S3, this means <code class=\"language-text\">CreateBucket</code> or <code class=\"language-text\">PutBucketPolicy</code> but not <code class=\"language-text\">PutObject</code> or <code class=\"language-text\">DeleteObject</code>.</li>\n</ol>\n<p><strong>Note:</strong> You can enable data-level events for S3 and Lambda in your CloudTrail configuration if desired. This will trigger many more events, so use carefully.</p>\n<p>When configuring a CloudWatch Events subscription for an AWS API call, your pattern will always look something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\">      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">cloudwatchEvent</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">event</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">source</span><span class=\"token punctuation\">:</span>\n              <span class=\"token punctuation\">-</span> <span class=\"token string\">\"aws.dynamodb\"</span>\n            <span class=\"token key atrule\">detail-type</span><span class=\"token punctuation\">:</span>\n              <span class=\"token punctuation\">-</span> <span class=\"token string\">\"AWS API Call via CloudTrail\"</span>\n            <span class=\"token key atrule\">detail</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">eventName</span><span class=\"token punctuation\">:</span>\n                <span class=\"token punctuation\">-</span> <span class=\"token string\">\"CreateTable\"</span></code></pre></div>\n<p>There will be a <code class=\"language-text\">source</code> key that will match the particular AWS service you’re tracking. The <code class=\"language-text\">detail-type</code> will be <code class=\"language-text\">AWS API Call via CloudTrail</code>. Finally, there will be an array of <code class=\"language-text\">eventName</code> in the <code class=\"language-text\">detail</code> key that lists 1 or more event names you want to match.</p>\n<p>Pro-tip: Use the <a href=\"https://console.aws.amazon.com/cloudwatch/home#rules:action=create\">CloudWatch Rules console</a> to help configure your items the first few times. You can point and click different options and it will show the subscription pattern:</p>\n<img width=\"774\" alt=\"CloudWatch Events console\" src=\"https://user-images.githubusercontent.com/6509926/34832861-a40942fe-f6b3-11e7-8d7a-04ebcbb433d2.png\">\n<p>Let’s insert our DynamoDB CreateTable pattern into our <code class=\"language-text\">serverless.yml</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token comment\"># serverless.yml</span>\n\n<span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> cloudtrail<span class=\"token punctuation\">-</span>dynamodb\n\n<span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token key atrule\">runtime</span><span class=\"token punctuation\">:</span> python3.6\n  <span class=\"token key atrule\">stage</span><span class=\"token punctuation\">:</span> dev\n  <span class=\"token key atrule\">region</span><span class=\"token punctuation\">:</span> us<span class=\"token punctuation\">-</span>east<span class=\"token punctuation\">-</span><span class=\"token number\">1</span>\n  <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">SLACK_URL</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'INSERT SLACK URL'</span>\n\n<span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">createTable</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.create_table\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">cloudwatchEvent</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">event</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">source</span><span class=\"token punctuation\">:</span>\n              <span class=\"token punctuation\">-</span> <span class=\"token string\">\"aws.dynamodb\"</span>\n            <span class=\"token key atrule\">detail-type</span><span class=\"token punctuation\">:</span>\n              <span class=\"token punctuation\">-</span> <span class=\"token string\">\"AWS API Call via CloudTrail\"</span>\n            <span class=\"token key atrule\">detail</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">eventName</span><span class=\"token punctuation\">:</span>\n                <span class=\"token punctuation\">-</span> <span class=\"token string\">\"CreateTable\"</span></code></pre></div>\n<p>Very similar to the previous example—we’re setting up our CloudWatch Event subscription and passing in our Slack webhook URL to be used by our function.</p>\n<p>Then, implement our function logic in <code class=\"language-text\">handler.py</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># handler.py</span>\n\n<span class=\"token keyword\">import</span> json\n<span class=\"token keyword\">import</span> os\n\n<span class=\"token keyword\">from</span> botocore<span class=\"token punctuation\">.</span>vendored <span class=\"token keyword\">import</span> requests\n\nSLACK_URL <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>environ<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'SLACK_URL'</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">create_table</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    formatted <span class=\"token operator\">=</span> format_message<span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span>\n\n    send_to_slack<span class=\"token punctuation\">(</span>formatted<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">format_message</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    detail <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'detail'</span><span class=\"token punctuation\">)</span>\n    parameters <span class=\"token operator\">=</span> detail<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'requestParameters'</span><span class=\"token punctuation\">)</span>\n    identity <span class=\"token operator\">=</span> detail<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'userIdentity'</span><span class=\"token punctuation\">)</span>\n\n    table_name <span class=\"token operator\">=</span> parameters<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'tableName'</span><span class=\"token punctuation\">)</span>\n    region <span class=\"token operator\">=</span> detail<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'awsRegion'</span><span class=\"token punctuation\">)</span>\n    username <span class=\"token operator\">=</span> identity<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'userName'</span><span class=\"token punctuation\">)</span>\n    user_type <span class=\"token operator\">=</span> identity<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'type'</span><span class=\"token punctuation\">)</span>\n\n\n    text <span class=\"token operator\">=</span> <span class=\"token string\">'\\n'</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"New DynamoDB table created!\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Table *{}* created in region *{}*\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>table_name<span class=\"token punctuation\">,</span> region<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Request made by username *{}*, a *{}*.\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>username<span class=\"token punctuation\">,</span> user_type<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"text\"</span><span class=\"token punctuation\">:</span> text\n    <span class=\"token punctuation\">}</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">send_to_slack</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">,</span> url<span class=\"token operator\">=</span>SLACK_URL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    resp <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> json<span class=\"token operator\">=</span>message<span class=\"token punctuation\">)</span>\n\n    resp<span class=\"token punctuation\">.</span>raise_for_status<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Again, pretty similar to the last example—we’re taking the event, assembling it into a format for Slack messages, then posting to Slack.</p>\n<p>Let’s deploy this one:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ sls deploy</code></pre></div>\n<p>And then trigger an event by creating a DynamoDB table via the AWS CLI:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws dynamodb create-table <span class=\"token punctuation\">\\</span>\n  --table-name TestTable <span class=\"token punctuation\">\\</span>\n  --attribute-definitions <span class=\"token string\">'[\n    {\n        \"AttributeName\": \"key\",\n        \"AttributeType\": \"S\"\n    }\n  ]'</span> <span class=\"token punctuation\">\\</span>\n  --key-schema <span class=\"token string\">'[\n    {\n        \"AttributeName\": \"key\",\n        \"KeyType\": \"HASH\"\n    }\n  ]'</span> <span class=\"token punctuation\">\\</span>\n  --provisioned-throughput <span class=\"token string\">'{\n    \"ReadCapacityUnits\": 1,\n    \"WriteCapacityUnits\": 1\n  }'</span></code></pre></div>\n<p>Wait a few moments, and you should get a notification in Slack:</p>\n<p><img src=\"https://user-images.githubusercontent.com/6509926/34838059-5222f41c-f6c2-11e7-9693-6db8dc866f05.png\" alt=\"Slack DynamoDB CreateTable alert\"></p>\n<p>Aw yeah.</p>\n<p>You could implement some really cool functionality around this, including calculating and displaying the monthly price of the table based on the provisioned throughput, or making sure all infrastructure provisioning is handled through a particular IAM user (e.g. the credentials used with your CI/CD workflows).</p>\n<p>Also, make sure you delete the table so you don’t get charged for it:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ aws dynamodb delete-table <span class=\"token punctuation\">\\</span>\n    --table-name TestTable</code></pre></div>\n<h2>Conclusion</h2>\n<p>There’s a ton of potential for CloudWatch Events, from triggering notifications on suspicious events to performing maintenance work when a new resource is created.</p>\n<p>In a future post, I’d like to explore saving all of this CloudTrail events to S3 to allow for efficient querying on historical data—“Who spun up EC2 instance i-afkj49812jfk?” or “Who allowed 0.0.0.0/0 ingress in our database security group?”</p>\n<p>If you use this tutorial to do something cool, drop it in the comments!</p>","frontmatter":{"title":"How to monitor AWS account activity with Cloudtrail, Cloudwatch Events and Serverless","date":"January 15, 2018","description":"Level up your AWS automation by reacting to events from AWS services."}}},"pageContext":{"slug":"/posts/2018-01-15-serverless-cloudtrail-cloudwatch-events/","previous":{"fields":{"slug":"/posts/2018-01-11-serverless-application-for-long-running-process-fargate-lambda/"},"frontmatter":{"title":"How to use AWS Fargate and Lambda for long-running processes in a Serverless app"}},"next":{"fields":{"slug":"/posts/2018-01-16-cors-api-gateway-survival-guide/"},"frontmatter":{"title":"Your CORS and API Gateway survival guide"}}}}}