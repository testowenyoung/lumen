{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/2019-08-02-aws-secrets-management/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"f9517e26-046d-5b35-9973-ce1784251ccd","excerpt":"Question: What’s the right way to manage secrets in serverless applications? The crowd answers:\nSecrets belong in environment variables! \nSecrets don’t belong…","html":"<p>Question: What’s the right way to manage secrets in serverless applications?</p>\n<p>The crowd answers:\nSecrets belong in environment variables!\nSecrets don’t belong in environment variables!\nSecrets belong in parameter stores!\nThat’s not what parameter stores are for!\nVault! AWS KMS! SSM!</p>\n<p>Storing application secrets in serverless applications is a hot topic that provokes many (often contradictory) opinions on how to manage them right. By “secrets management” we mean the entire secrets lifecycle: from configuring, storing and accessing them to rotating them and enforcing secrets policies. Typical ways to configure secrets include hard-coding them in your application (not recommended!), using dedicated secrets files, storing them in environment variables, and using secrets stores like HashiCorp’s <a href=\"https://www.vaultproject.io/\">Vault</a>.</p>\n<p>If you’re running Serverless applications, most likely you are already using secrets to store data like database connection strings and API tokens for third party services, or you will start needing to use them soon. We want to help you make an informed choice about how to store and access your secrets with the Serverless Framework.</p>\n<p>In this article we explore three approaches to secrets management for Serverless applications: using environment variables, using the AWS SSM parameter store, and using the Serverless Framework’s secrets management features, and we discuss the benefits and drawbacks of each option. Using code, we show you in detail what each approach looks like, allowing you to choose your favourite way to manage Serverless secrets.</p>\n<p>Let’s dive right in.</p>\n<h4>Three ways to manage secrets for Serverless Framework applications</h4>\n<p>To illustrate each approach to secrets management in Serverless applications, we’re using <a href=\"https://github.com/chief-wizard/serverless-secrets-management-weather-apis\">this sample</a> <a href=\"https://github.com/chief-wizard/serverless-secrets-management-weather-apis\">weather forecast</a> <a href=\"https://github.com/chief-wizard/serverless-secrets-management-weather-apis\">API</a> <a href=\"https://github.com/chief-wizard/serverless-secrets-management-weather-apis\">on GitHub</a>. It’s a simple Serverless API that gets a weather forecast for a given location from three different weather service providers:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">    https://{our-endpoint-url}/{weather-provider-name}/{latitude}/{longitude}</code></pre></div>\n<p>We used <a href=\"https://darksky.net/dev\">Dark</a> <a href=\"https://darksky.net/dev\"></a><a href=\"https://darksky.net/dev\">Sky</a>, <a href=\"https://openweathermap.org/\">OpenWeatherMap</a>, and the <a href=\"https://developer.here.com/documentation/weather/common/request-cit-environment-rest.html\">HERE Destination Weather API</a>.\nFor each provider we’ve chosen a different way to store API secrets. Of course, you would rarely need to do anything like this in a real-life project, but this is a convenient way to illustrate the differences between the secrets management approaches.</p>\n<p>To set the stage, let’s take a look at the overall structure of the project, and then we’ll dive into the implementation for each provider.</p>\n<h4>Overall structure of the project</h4>\n<p>We begin our <a href=\"https://github.com/chief-wizard/serverless-secrets-management-weather-apis\">w</a><a href=\"https://github.com/chief-wizard/serverless-secrets-management-weather-apis\">eather API example</a> with a service definition in the <a href=\"https://github.com/chief-wizard/serverless-secrets-management-weather-apis/blob/master/serverless.yml\">serverless.yml</a> file. In the <code class=\"language-text\">provider</code> section, we specify that we want to use AWS in the <code class=\"language-text\">us-east-1</code> region, that our environment is Node.js, and that we require the Serverless Framework version to be newer than <code class=\"language-text\">1.43.0</code> (we cover the version part later).</p>\n<p>We used the <code class=\"language-text\">serverless-offline</code> plugin for local testing, but this is optional.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\">    <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> weather<span class=\"token punctuation\">-</span>forecast\n    \n    <span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n      <span class=\"token key atrule\">runtime</span><span class=\"token punctuation\">:</span> nodejs8.10\n      <span class=\"token key atrule\">region</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'us-east-1'</span>\n      <span class=\"token key atrule\">frameworkVersion</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\">=1.43.0\"</span>\n    \n    <span class=\"token key atrule\">plugins</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> serverless<span class=\"token punctuation\">-</span>offline</code></pre></div>\n<p>The most interesting part of <code class=\"language-text\">serverless.yml</code> is the <a href=\"https://github.com/chief-wizard/serverless-secrets-management-weather-apis/blob/master/serverless.yml#L17-L48\">functions section</a> where we define our API handlers. We define one handler per provider, define the HTTP route for each handler, and add any secrets needed to get that provider working.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\">    <span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">darksky</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.darksky\n        <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span> \n          <span class=\"token key atrule\">DARKSKY_URL</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'https://api.darksky.net/forecast'</span>\n          <span class=\"token key atrule\">DARKSKY_APIKEY</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>ssm<span class=\"token punctuation\">:</span>/darksky<span class=\"token punctuation\">-</span>api<span class=\"token punctuation\">-</span>key~true<span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /darksky/<span class=\"token punctuation\">{</span>latitude<span class=\"token punctuation\">}</span>/<span class=\"token punctuation\">{</span>longitude<span class=\"token punctuation\">}</span>\n              <span class=\"token key atrule\">method</span><span class=\"token punctuation\">:</span> get\n    <span class=\"token punctuation\">...</span></code></pre></div>\n<p>We go into more detail on each specific provider later in this article.\nFor more info on the <code class=\"language-text\">serverless.yml</code> format, please see the relevant <a href=\"https://serverless.com/framework/docs/providers/aws/guide/intro/\">Serverless documentation</a>.</p>\n<p>Our <code class=\"language-text\">handler.js</code> <a href=\"https://github.com/chief-wizard/serverless-secrets-management-weather-apis/blob/master/handler.js\">file</a> is quite simple, making reference to individual provider files:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">    exports<span class=\"token punctuation\">.</span>darksky <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./external-api/darksky\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>darksky<span class=\"token punctuation\">;</span>\n    exports<span class=\"token punctuation\">.</span>openweathermap <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./external-api/openweathermap\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>openweathermap<span class=\"token punctuation\">;</span>\n    exports<span class=\"token punctuation\">.</span>dest <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./external-api/dest\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>dest<span class=\"token punctuation\">;</span></code></pre></div>\n<p>The individual provider code is in the <a href=\"https://github.com/chief-wizard/serverless-secrets-management-weather-apis/tree/master/external-api\">external-api subdirectory</a>.</p>\n<p>Now that the structure is covered, let’s take a look at how we can implement secrets access for each of the weather API providers.</p>\n<h4>Approach #1: AWS SSM parameters</h4>\n<p><a href=\"https://aws.amazon.com/systems-manager/\">AWS Systems Manager</a> is a simple configuration management solution that integrates with many AWS services. Parameter Store is the part of this solution most relevant here. It allows us to store plain-text and encrypted string parameters that can be accessed easily during run time.</p>\n<p>Serverless Framework provides easy-to-use <a href=\"https://serverless.com/framework/docs/providers/aws/guide/variables/#reference-variables-using-the-ssm-parameter-store\">integration</a> with AWS SSM Parameter Store. We used this approach with the Dark Sky weather API.</p>\n<p>To add a new secret in the AWS Systems Manager user interface, we specify the Secure String type and use the default KMS key to encrypt it.</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/secrets-management/s_468DC5A00535E640D1CD6F860B59D7ED1FD419F7F68475C6951254F0A0DFD405_1563915821845_20190723172855mbk6sxe5l8.png\"></p>\n<p>In our <code class=\"language-text\">serverless.yml</code> we <a href=\"https://github.com/chief-wizard/serverless-secrets-management-weather-apis/blob/master/serverless.yml#L23\">reference</a> our DarkSky API key via the <code class=\"language-text\">ssm:/</code> notation. Now that our key is encrypted in the Parameter Store, we add <code class=\"language-text\">~true</code> to the end of the key reference. This way, the Serverless Framework fetches the parameter from SSM, decrypts it, and places the decrypted value into an environment variable for us to use:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\">    <span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">darksky</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.darksky\n        <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span> \n          <span class=\"token key atrule\">DARKSKY_URL</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'https://api.darksky.net/forecast'</span>\n          <span class=\"token key atrule\">DARKSKY_APIKEY</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>ssm<span class=\"token punctuation\">:</span>/darksky<span class=\"token punctuation\">-</span>api<span class=\"token punctuation\">-</span>key~true<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The provider code reads the API key from the environment variable and uses it directly; in a deployed function it will contain the decrypted value of the API key:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">    <span class=\"token keyword\">var</span> apiUrl <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">DARKSKY_URL</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">var</span> apiKey <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">DARKSKY_APIKEY</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>We then use the token to fetch the weather data from the provider:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">    <span class=\"token keyword\">var</span> <span class=\"token function-variable function\">callExternalApi</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">latitude<span class=\"token punctuation\">,</span> longitude</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">var</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>apiUrl<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>apiKey<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>latitude<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">,</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>longitude<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">var</span> json <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n            <span class=\"token keyword\">var</span> body <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> temperature<span class=\"token operator\">:</span> json<span class=\"token punctuation\">.</span>currently<span class=\"token punctuation\">.</span>temperature <span class=\"token punctuation\">}</span>\n    \n            <span class=\"token keyword\">var</span> response <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n                statusCode<span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n                headers<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token string\">\"Content-Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"application/json\"</span>\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                body<span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>The main benefits of this approach are that it’s secure but simple to implement, with built-in syntax for decryption in <code class=\"language-text\">serverless.yml</code>.</p>\n<p>As far as downsides go, when using this option your team needs to have their AWS credentials handy and configured on their local machine whenever they deploy the Serverless function. You can lessen the negative impact of this by issuing your team members with AWS accounts whose permissions are configured to only give them access to the resources they need when deploying a new function.</p>\n<p>Another downside here is that configuring encryption keys for your secrets separately from the secrets themselves can be error-prone if more than one encryption key is involved.</p>\n<h4>Approach #2: AWS Secrets Manager</h4>\n<p>For our second provider, we use <a href=\"https://aws.amazon.com/secrets-manager/\">AWS Secrets Manager</a> to store the <a href=\"https://openweathermap.org/\">OpenWeatherMap</a> credentials. AWS Secrets Manager offers functionality that is more secrets-specific, such as audit logs and automated key rotation under certain conditions.</p>\n<p>To add a new secret in AWS Secrets Manager we click the “Store New Secret” button in the Secrets Manager UI and set the secret type to “Other”. Make sure you’re adding an encrypted secret rather than a plain-text field.</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/secrets-management/s_468DC5A00535E640D1CD6F860B59D7ED1FD419F7F68475C6951254F0A0DFD405_1563915841147_20190723222746ja8eypdldo.png\"></p>\n<p>The AWS SSM system we covered in approach #1 would also allow us to access AWS Secrets Manager secrets <a href=\"https://serverless.com/framework/docs/providers/aws/guide/variables#reference-variables-using-aws-secrets-manager\">via the same SSM syntax</a>. While this would be convenient, it has the same drawback as the previous solution: you need to redeploy the function for a change in secrets to take effect.</p>\n<p>Instead of using the SSM syntax, this time we fetch the secret directly using the AWS API. This way, if we decide to change the secret’s value in AWS Secrets Manager, we won’t need to redeploy the function, and the function will read the updated value next time it is invoked. Let’s take a look at how this is implemented.</p>\n<p>The function definition in the <code class=\"language-text\">serverless.yml</code> file is very similar to the previous solution, except for the environment variables:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\">      <span class=\"token key atrule\">openweathermap</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.openweathermap\n        <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span> \n          <span class=\"token key atrule\">OPENWEATHERMAP_URL</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'https://samples.openweathermap.org/data/2.5/weather'</span>\n          <span class=\"token key atrule\">OPENWEATHERMAP_APPID</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'openweathermap-appid'</span></code></pre></div>\n<p>The OpenWeatherMap handler looks slightly more complicated than the previous solution, mostly because now we’re fetching the secrets via the AWS SDK. We start by defining all the variables we will need:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">    <span class=\"token keyword\">var</span> <span class=\"token constant\">AWS</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'aws-sdk'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        region <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">AWS_REGION_ENV</span><span class=\"token punctuation\">,</span>\n        secretName <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OPENWEATHERMAP_APPID_LOCATION</span><span class=\"token punctuation\">,</span>\n        accessKeyId <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">ACCESS_KEY_ID</span><span class=\"token punctuation\">,</span>\n        secretAccessKey <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SECRET_ACCESS_KEY</span><span class=\"token punctuation\">,</span>\n        decodedBinarySecret<span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">var</span> client <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AWS<span class=\"token punctuation\">.</span>SecretsManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        region<span class=\"token punctuation\">,</span>\n        accessKeyId<span class=\"token punctuation\">,</span>\n        secretAccessKey\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The <code class=\"language-text\">decodedBinarySecret</code> variable will contain the decrypted secret in the next section, where we fetch the secret’s value via the AWS SDK:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">    exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">openweathermap</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            client<span class=\"token punctuation\">.</span><span class=\"token function\">getSecretValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> SecretId<span class=\"token operator\">:</span> secretName <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span>\n                <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'SecretString'</span> <span class=\"token keyword\">in</span> data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        decodedBinarySecret <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>SecretString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>secretName<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token keyword\">let</span> buff <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Buffer</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>SecretBinary<span class=\"token punctuation\">,</span> <span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        decodedBinarySecret <span class=\"token operator\">=</span> buff<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ascii'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n                    <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">callExternalApi</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>pathParameters<span class=\"token punctuation\">.</span>latitude<span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">.</span>pathParameters<span class=\"token punctuation\">.</span>longitude<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>Finally, we use the decoded secret to make an API call to the weather provider:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">    <span class=\"token keyword\">var</span> <span class=\"token function-variable function\">callExternalApi</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">latitude<span class=\"token punctuation\">,</span> longitude</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">var</span> apiUrl <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OPENWEATHERMAP_URL</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">var</span> appid <span class=\"token operator\">=</span> decodedBinarySecret\n    \n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">var</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>apiUrl<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/?lat=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>latitude<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&amp;lon=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>longitude<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&amp;appid=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>appid<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">var</span> json <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n            <span class=\"token keyword\">var</span> body <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> temperature<span class=\"token operator\">:</span> json<span class=\"token punctuation\">.</span>main<span class=\"token punctuation\">.</span>temp <span class=\"token punctuation\">}</span>\n    \n            <span class=\"token keyword\">var</span> response <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n                statusCode<span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n                headers<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token string\">\"Content-Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"application/json\"</span>\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                body<span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> response\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>The main benefit of this approach is that the secrets are fetched dynamically. The fact that we are using the Secrets Manager directly also means that we can take advantage of features like automated key rotation.</p>\n<p>On the other hand, this means more code on the application side for making calls to the Secrets Manager. In addition, now that we are fetching the secret dynamically, we need to perform an API call each time the function is invoked. This adds to the function run time and to the cost — AWS charges us for each secret that we store as well as for each API call to retrieve it in the function. If we are talking about tens of thousands of function calls per day, the cost can add up quickly.</p>\n<p>Another downside to this option is that your team still need access to production AWS credentials in order to deploy the function.</p>\n<h4>Approach #3: Serverless Framework secrets</h4>\n<p>An alternative to the AWS SSM and Secrets Manager is the recently announced <a href=\"https://serverless.com/blog/serverless-now-full-lifecycle/\">secrets functionality</a> in the Serverless Framework. For API provider number three, the HERE Destination Weather API, we chose this approach.</p>\n<p>After logging into the <a href=\"https://dashboard.serverless.com/\">Serverless Dashboard</a>, we add the secret we want to store under the Secrets tab in the Profile section. (You’ll need to create a new profile if you don’t have one yet.)</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/secrets-management/s_468DC5A00535E640D1CD6F860B59D7ED1FD419F7F68475C6951254F0A0DFD405_1563915863024_2019072322322346rlfjtpe3.png\"></p>\n<p>Next, we add a new secret and save it. Once we add the secrets in the Serverless Dashboard, they become available to functions we deploy from any machine where we’re logged into our Serverless account using the <code class=\"language-text\">sls login</code> command. The secrets are decrypted at deploy time.</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/secrets-management/s_468DC5A00535E640D1CD6F860B59D7ED1FD419F7F68475C6951254F0A0DFD405_1563915896609_20190723223247lvbtyh3g7d.png\"></p>\n<p>In the <code class=\"language-text\">serverless.yml</code> file we reference the secret stored in the Serverless Dashboard using the <code class=\"language-text\">${secrets:&lt;secret-name&gt;}</code> syntax:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\">      <span class=\"token key atrule\">dest</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.dest\n        <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span> \n          <span class=\"token key atrule\">DEST_URL</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'https://weather.cit.api.here.com/weather/1.0/report.json'</span>\n          <span class=\"token key atrule\">DEST_APP_ID</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>file(./secrets.json)<span class=\"token punctuation\">:</span>DestApiId<span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">DEST_APP_CODE</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>secrets<span class=\"token punctuation\">:</span>dest<span class=\"token punctuation\">-</span>app<span class=\"token punctuation\">-</span>code<span class=\"token punctuation\">}</span></code></pre></div>\n<p><a href=\"https://serverless.com/framework/docs/dashboard/secrets/\">The Serverless Framework docs</a> offer more details about this syntax.</p>\n<p>This solution’s handler is very simple, as the Serverless Framework takes care of fetching the secret and decrypting it for us:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">    <span class=\"token keyword\">const</span> fetch <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"node-fetch\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">dest</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">callExternalApi</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>pathParameters<span class=\"token punctuation\">.</span>latitude<span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">.</span>pathParameters<span class=\"token punctuation\">.</span>longitude<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">var</span> <span class=\"token function-variable function\">callExternalApi</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">latitude<span class=\"token punctuation\">,</span> longitude</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">var</span> appCode <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">DEST_APP_CODE</span>\n        <span class=\"token keyword\">var</span> apiUrl <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">DEST_URL</span>\n        <span class=\"token keyword\">var</span> apiId <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">DEST_APP_ID</span>\n    \n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">var</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>apiUrl<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">?product=observation&amp;latitude=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>latitude<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&amp;longitude=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>longitude<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&amp;app_id=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>apiId<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&amp;app_code=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>appCode<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">var</span> json <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n            <span class=\"token keyword\">var</span> body <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> temperature<span class=\"token operator\">:</span> json<span class=\"token punctuation\">.</span>observations<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>observation<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>temperature <span class=\"token punctuation\">}</span>\n    \n            <span class=\"token keyword\">var</span> response <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n                statusCode<span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n                headers<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token string\">\"Content-Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"application/json\"</span>\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                body<span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>The framework obviates any code required to use the AWS SDK, and there’s no need to configure granular AWS permissions or manage API keys. Serverless Framework will generate a pair of single-use credentials for each deploy to AWS, so your teammates won’t need direct AWS API access in order to deploy. The simplicity of these access controls and of the secrets system itself is the biggest benefit of this option.</p>\n<p>However, if you want to store secrets that are not simple strings, or if you are looking to encrypt entire files, please note that Serverless Framework has not yet implemented that functionality for secrets.</p>\n<h4>Three tips for secrets management with Serverless</h4>\n<p>Regardless of the toolset you choose to manage secrets with Serverless applications, here are three principles that will help you keep your secrets safe.</p>\n<h5>Always use encryption</h5>\n<p>Make sure that your secrets are stored encrypted. Only decrypt the secrets where you need to use them, and don’t store the secret values in plain text, even on ephemeral machines or containers. While AWS services do allow you to store secrets in plain text, we strongly encourage you always to use encrypted options. Serverless Framework’s own secrets functionality allows only encrypted secrets.</p>\n<h5>Restrict access to secrets, but don’t inconvenience developers</h5>\n<p>We believe it’s important to keep the number of people who have direct access to your production secrets as small as possible. But sometimes companies go overboard creating security hurdles that end up impeding developers while they try to debug a production issue or address a security incident. We recommend striking a healthy balance between secure access settings and developer convenience — for example, by having one or two people on each team with access to production secrets and by creating team-specific namespaces in your secrets stores so that everyone has access only to the secrets they need.</p>\n<h5>Rotate secrets often</h5>\n<p>Regular secrets rotation is important for two reasons. First, it limits the exposure of a given leaked secret, as it will become invalid as soon as a new secret is in place. Second, it forces you to update your secrets management tooling to enable regular secrets rotation. </p>\n<p>Manual redeployment of all services will no longer cut it when you need to do it all over again every month. We recommend setting up a consistent secrets rotation plan and automating it as much as possible.</p>\n<h5>Summary</h5>\n<p>In this article, we walked through three secure and easy ways of implementing secrets access and management for Serverless applications. All three ways have benefits and drawbacks, and we encourage you to evaluate all the ways we’ve suggested. Pick the solution that’s right for your team.</p>\n<p>You can find the example project we use in <a href=\"https://github.com/chief-wizard/serverless-secrets-management-weather-apis\">this article</a>: please open an issue in the repository (or submit a pull request) if you have any suggestions on how to make the example better.</p>\n<p>You can find the docs for the solutions we used here:</p>\n<ul>\n<li>AWS SSM Parameter Store - <a href=\"https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html\">AWS docs</a>, <a href=\"https://serverless.com/framework/docs/providers/aws/guide/variables#reference-variables-using-the-ssm-parameter-store\">Serverless docs</a>.</li>\n<li>AWS Secrets Manager - <a href=\"https://docs.aws.amazon.com/secretsmanager/latest/userguide/intro.html\">AWS docs</a>, <a href=\"https://serverless.com/framework/docs/providers/aws/guide/variables#reference-variables-using-aws-secrets-manager\">Serverless docs</a>.</li>\n<li>Serverless Framework secrets - <a href=\"https://serverless.com/framework/docs/dashboard/secrets/\">Serverless docs</a>.</li>\n</ul>\n<p>If you’d like to give Serverless Framework a try, have a look at the <a href=\"https://serverless.com/framework/docs/getting-started/\">getting started guide</a>.</p>","frontmatter":{"title":"Secrets Management for AWS Powered Serverless Applications","date":"August 02, 2019","description":"Storing application secrets in serverless applications is a hot topic that provokes many (often contradictory) opinions on how to manage them right."}}},"pageContext":{"slug":"/posts/2019-08-02-aws-secrets-management/","previous":{"fields":{"slug":"/posts/2019-08-01-serverless-components-beta/"},"frontmatter":{"title":"Serverless Components Beta"}},"next":{"fields":{"slug":"/posts/2019-08-05-leverage-existing-s3-cognito-sources/"},"frontmatter":{"title":"Leveraging existing event sources (S3 and CognitoUserPools)"}}}}}