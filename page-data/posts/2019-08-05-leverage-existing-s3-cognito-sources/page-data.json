{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/2019-08-05-leverage-existing-s3-cognito-sources/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"da155ad7-fb77-55aa-86f3-b4bbb82311b9","excerpt":"Cloud computing introduced a drastic shift when it was first introduced in the early 2000s. Providers such as Amazon Web Services (AWS) finally made it possible…","html":"<p>Cloud computing introduced a drastic shift when it was first introduced in the early 2000s. Providers such as Amazon Web Services (AWS) finally made it possible to rent compute, storage and other web related services on a monthly or yearly subscription basis. Getting projects into production was a matter of a credit card swipe and a deployment. Contrasting this with the usual, months long capacity planning and procurement processes shows why cloud computing was such a game changer in the tech industry.</p>\n<p>As a result more and more developers and companies adopted cloud computing as their go-to solution to host their applications in an easy, future proof and cost effective way.</p>\n<p>Given that AWS started in the early 2000s it’s easy to imagine how applications grew within the AWS ecosystem and how much data such applications generated, processed and accumulated. The big data trend turned the attention to the value in the data. One of AWS reactions to this trend was the introduction of the Lambda compute service back in 2014.</p>\n<p>The very first event sources AWS introduced for Lambda was support for events generated by S3 buckets. To this day the infamous „Image resizer“ demo where an image is uploaded to an S3 bucket and automatically resized by a Lambda function is still the most prominent „Hello World“ application to showcase the power of serverless architectures.</p>\n<h4>Existing event sources</h4>\n<p>Our dive into the AWS history and Serverless computing above showed us that AWS Lambda was initially built around the idea of working with data from existing infrastructure components such as storage buckets.</p>\n<p>Once API Gateway support as a Lambda event source was announced it was clear that the serverless paradigm will be huge. The JAWS CLI tool (The Serverless Framework precursor) was born in 2015 out of the necessity to provide an easy way to leverage the power serverless unleashes by making it as simple as possible to author serverless applications.</p>\n<p>In 2016, the Serverless team sat down and worked together with the community to define the integral parts for our upcoming Serverless Framework v1 release. One main takeaway during this exercise was that we should support CloudFormation which is the de-facto standard to define and deploy infrastructure on AWS in a declarative way.</p>\n<p>While CloudFormation gives us a lot of upsides, mainly in the form of a battle-tested and well-known platform to perform resilient infrastructure changes, it not short of downsides as well. One such downside is the focus on infrastructure creation and teardown which means that CloudFormation was never designed to deal with resources which were not part of the initial creation phase.</p>\n<p>It’s clear that this restriction prevents CloudFormation users from introducing existing infrastructure components such as S3 buckets or Cognito User Pools into their current setup. This problem trickles down to the Serverless Framework which utilizes CloudFormation under the hood.</p>\n<p>Introducing event support for existing S3 buckets or Cognito User Pools turned into a problem only <a href=\"https://serverless.com/plugins/\">Serverless Plugins</a> were able to solve. Such plugins relied on raw AWS SDK calls, and their usage introduced a second method to allow the management of application infrastructure.</p>\n<p>Within recent versions of the Serverless Framework, we finally found a way to support existing resources via CloudFormation which means that we still get all the benefits CloudFormation has to offer while making it possible to introduce existing, potentially legacy infrastructure components, into the application stack.</p>\n<h4>S3</h4>\n<p>We already read above that S3 is one of the first and most widely used AWS services. Given that S3 has been around for such a long time, it’s easy to imagine that a lot of data was accumulated in S3 buckets throughout the years. S3 buckets are often used as the central object store to save and retrieve files such as images, personal documents or log files.</p>\n<p>S3 buckets can emit a variety of <a href=\"https://docs.aws.amazon.com/AmazonS3/latest/dev/NotificationHowTo.html\">different event notifications</a> such as <code class=\"language-text\">s3:ObjectCreated:*</code> which can be used to get notifications when a new object is uploaded to the bucket or <code class=\"language-text\">s3:ObjectRemoved:*</code> which will send a notification when an object was deleted from the bucket. Different <code class=\"language-text\">prefix</code> and <code class=\"language-text\">suffix</code> configurations make it possible to further filter down when such events should be emitted.</p>\n<p>The Serverless Framework comes with native support for the <code class=\"language-text\">s3</code> event source. Let’s take a look at an example where we want our <code class=\"language-text\">notify</code> function to be called whenever a new <code class=\"language-text\">.pdf</code> file is created in the <code class=\"language-text\">documents</code> directory of our <code class=\"language-text\">acme-cloud-storage</code> bucket:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> acme<span class=\"token punctuation\">-</span>cloud\n\n<span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token key atrule\">runtime</span><span class=\"token punctuation\">:</span> nodejs10.x\n\n<span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">notify</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.hello\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">s3</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">bucket</span><span class=\"token punctuation\">:</span> acme<span class=\"token punctuation\">-</span>cloud<span class=\"token punctuation\">-</span>storage\n          <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span> s3<span class=\"token punctuation\">:</span>ObjectCreated<span class=\"token punctuation\">:</span>*\n          <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">suffix</span><span class=\"token punctuation\">:</span> .pdf\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">prefix</span><span class=\"token punctuation\">:</span> documents</code></pre></div>\n<p>Deploying this service with the Serverless Framework will create the <code class=\"language-text\">acme-cloud-storage</code> bucket and sets up the bucket configuration to call the <code class=\"language-text\">notify</code> function accordingly.</p>\n<p>What if our <code class=\"language-text\">acme-cloud-storage</code> bucket is already in production and we want to setup our <code class=\"language-text\">notify</code> Lambda function after the fact?</p>\n<p>Thanks to our recent changes this can be achieved via the <code class=\"language-text\">existing: true</code> flag:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> acme<span class=\"token punctuation\">-</span>cloud\n\n<span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token key atrule\">runtime</span><span class=\"token punctuation\">:</span> nodejs10.x\n\n<span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">notify</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.hello\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">s3</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">bucket</span><span class=\"token punctuation\">:</span> acme<span class=\"token punctuation\">-</span>cloud<span class=\"token punctuation\">-</span>storage\n          <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span> s3<span class=\"token punctuation\">:</span>ObjectCreated<span class=\"token punctuation\">:</span>*\n          <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">suffix</span><span class=\"token punctuation\">:</span> .pdf\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">prefix</span><span class=\"token punctuation\">:</span> documents\n          <span class=\"token key atrule\">existing</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></code></pre></div>\n<p>The Serverless Framework will automatically detect that the <code class=\"language-text\">acme-cloud-storage</code> bucket was already created previously and will just setup the configuration on the bucket. Once deployed our <code class=\"language-text\">notify</code> function will be called whenever files that match our rules are uploaded to the existing bucket.</p>\n<h4>Cognito User Pools</h4>\n<p>Sometimes it’s useful to react to specific user behavior within your application. A typical user-related use case is the sending of “Welcome” or “Getting started” emails whenever a user decides to sign up for your service.</p>\n<p><a href=\"https://aws.amazon.com/cognito/\">Cognito</a> and especially <a href=\"https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-identity-pools.html\">Cognito User Pools</a> are a widely used service to safely integrate and manage user accounts within web-facing applications.</p>\n<p>Cognito User Pools offer an easy way to create <a href=\"https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-identity-pools-working-with-aws-lambda-triggers.html\">customized workflows via Triggers</a> which can be setup on User Pools. Triggers include <code class=\"language-text\">PreSignUp</code>, <code class=\"language-text\">PostAuthentication</code>, <code class=\"language-text\">CustomMessage</code> and more.</p>\n<p>The Serverless Framework supports Cognito User Pools natively. Let’s create a service in which a <code class=\"language-text\">greeter</code> Lambda function is invoked whenever a new user signup is registered in our <code class=\"language-text\">AcmeUsers</code> User Pool:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> acme<span class=\"token punctuation\">-</span>user<span class=\"token punctuation\">-</span>mgmt\n\n<span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token key atrule\">runtime</span><span class=\"token punctuation\">:</span> nodejs10.x\n\n<span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">greeter</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> users.handler\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">cognitoUserPool</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">pool</span><span class=\"token punctuation\">:</span> AcmeUsers\n          <span class=\"token key atrule\">trigger</span><span class=\"token punctuation\">:</span> PreSignUp</code></pre></div>\n<p>Deploying this service will create the <code class=\"language-text\">AcmeUsers</code> Cognito User Pool and sets up the configuration so that the <code class=\"language-text\">greeter</code> function is called whenever a new user signs up for our application.</p>\n<p>Given that the service definition above will always attempt to create a new Cognito User Pool it seems to be hard to just setup the trigger configuration without interfering the production system.</p>\n<p>Thanks to the recent changes we made it’s dead simple to setup trigger configurations on existing Cognito User Pools. The only configuration which needs to be added is the <code class=\"language-text\">existing: true</code> flag. This flag tells the Serverless Framework to skip the Cognito User Pool creation phase and instead configure the triggers on the existing one:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> acme<span class=\"token punctuation\">-</span>user<span class=\"token punctuation\">-</span>mgmt\n\n<span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token key atrule\">runtime</span><span class=\"token punctuation\">:</span> nodejs10.x\n\n<span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">greeter</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> users.handler\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">cognitoUserPool</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">pool</span><span class=\"token punctuation\">:</span> AcmeUsers\n          <span class=\"token key atrule\">trigger</span><span class=\"token punctuation\">:</span> PreSignUp\n          <span class=\"token key atrule\">existing</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></code></pre></div>\n<p>Using this service setup makes it possible to introduce a previously created Cognito User Pool (possibly running in production for a while) into our current serverless setup.</p>\n<h4>Conclusion</h4>\n<p>Using event-driven application patterns with existing infrastructure components such as S3 buckets or Cognito Users Pools is not a rare circumstance.</p>\n<p>Given that the Serverless Framework is built on top of CloudFormation to provide production-grade reliability and resilience it was only possible to introduce external event sources via <a href=\"https://serverless.com/plugins/\">Serverless Plugins</a>. We thought hard about potential solutions to mitigate this shortcoming. While working on the solution one of our main goals was to not give up the benefits CloudFormation provides us.</p>\n<p>Recently we finally found a way to integrate support for existing infrastructure components into core. The first event sources for which we added this support include S3 buckets and Cognito User Pools. Setting them up requires just one line of code:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">existing</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></code></pre></div>\n<p>You can read more about the <code class=\"language-text\">existing: true</code> flag in the <a href=\"https://serverless.com/framework/docs/providers/aws/events/s3/\">S3</a> and <a href=\"https://serverless.com/framework/docs/providers/aws/events/cognito-user-pool/\">Cognito User Pools</a> docs.</p>\n<p>How are you using this new feature with the Serverless Framework? Share your thoughts and ideas in the comments below or tweet us <a href=\"https://twitter.com/goserverless\">@goserverless</a>.</p>","frontmatter":{"title":"Leveraging existing event sources (S3 and CognitoUserPools)","date":"August 05, 2019","description":"Its very likely your organisation has had an S3 bucket or Cognito User Pool in use for a while. Now you can just include them in your Serverless service."}}},"pageContext":{"slug":"/posts/2019-08-05-leverage-existing-s3-cognito-sources/","previous":{"fields":{"slug":"/posts/2019-08-02-aws-secrets-management/"},"frontmatter":{"title":"Secrets Management for AWS Powered Serverless Applications"}},"next":{"fields":{"slug":"/posts/2019-08-12-10-tips-creating-robust-serverless-components/"},"frontmatter":{"title":"10 Tips for Creating Robust Serverless Components"}}}}}