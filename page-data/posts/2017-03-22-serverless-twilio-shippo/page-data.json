{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/2017-03-22-serverless-twilio-shippo/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"af145eb4-ee32-5847-8f48-05d8875b06aa","excerpt":"In this project, we’re going to receive a notification from a webhook about an a physical shipment in transit and trigger an SMS with the updated tracking…","html":"<p>In this project, we’re going to receive a notification from a webhook about an a physical shipment in transit and trigger an SMS with the updated tracking information.  We’ll build an AWS Lambda function that will trigger whenever Shippo pushes an update about a shipment to our AWS API Gateway Endpoint. Inside of the Lambda function, we’re going to call Twilio to send an SMS update with our tracking info provided by Shippo’s webhook.</p>\n<p>Now, I know what you’re thinking, this sounds pretty complicated and requires a lot of manual set up and repeated uploading of JavaScript files to AWS, but you’d be wrong. We’re going to use Serverless to do a lot of the heavy lifting on this for us, because I’m all about writing less code to do more.</p>\n<p>You can find the full project repo at <a href=\"https://github.com/shipping-api/serverless-twilio-shippo\">https://github.com/shipping-api/serverless-twilio-shippo</a></p>\n<p>Things you’ll want before getting started with this tutorial:</p>\n<ul>\n<li><a href=\"https://www.twilio.com/try-twilio\">Twilio Account</a></li>\n</ul>\n<blockquote>\n<p>You’ll need your Account SID and Auth Token from this (you can find these both in your dash after signing up)</p>\n</blockquote>\n<ul>\n<li><a href=\"https://goshippo.com/register\">Shippo Account</a></li>\n</ul>\n<blockquote>\n<p>You just need to plug in your API endpoint URL to the <a href=\"https://goshippo.com/docs/webhooks\">webhooks</a> area to have it work.</p>\n</blockquote>\n<p>You can get Serverless by installing it globally on your machine using:</p>\n<p><code class=\"language-text\">npm install -g serverless</code></p>\n<p>Serverless provides a way to easily create a new service by just using their CLI as follows (you can omit the path if you don’t want it to create a directory for you):</p>\n<p><code class=\"language-text\">serverless create --template aws-nodejs --path twilio-shippo</code></p>\n<p>Before you dig into creating your Lambda function, you’ll want to setup a User in your AWS account for Serverless to have access for creating everything. They have a useful guide <a href=\"https://serverless.com/framework/docs/providers/aws/guide/credentials/\">here</a> that can walk you through getting your credentials setup.</p>\n<p>It’s as simple as adding a user <code class=\"language-text\">serverless-admin</code> with <code class=\"language-text\">AdministratorAccess</code> and using the credentials with the following command:</p>\n<p><code class=\"language-text\">serverless config credentials --provider aws --key ACCESS_KEY_ID --secret SECRET_ACCESS_KEY</code></p>\n<p>Once you have the credentials setup you can start adding function dependencies at the top of the <code class=\"language-text\">handler.js</code> file that Serverless created:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> twilio <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'twilio'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token string\">'TWILIO_ACCOUNT_SID'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'TWILIO_AUTH_TOKEN'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>From here, we want to create the endpoint that we’ll be putting into <a href=\"https://goshippo.com/docs/webhooks\">Shippo’s webhook</a> interface for capturing all of our tracking updates. Every time Shippo detects a new update to the status of a tracking number that we have POSTed to them, Shippo will send out updates to our API endpoint that we give to them.</p>\n<p>By default, Serverless will create an exported function named <code class=\"language-text\">hello</code>, but we’re going replace that with our own called <code class=\"language-text\">smsUpdates</code> (its also probably good to add a log so we can see this show up in CloudWatch):</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// Reminder: This should be appended below the code found above</span>\nmodule<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">smsUpdates</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// Don't worry, we'll be adding more here down below</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We are creating a POST endpoint, since Shippo will be POSTing the tracking updates to us. We’ll then parse the data to relay over to Twilio to send out our SMS messages.</p>\n<p>First, let’s parse the body of the message that Shippo has sent to us. We’ll set up a few variable to prevent repeating ourselves, and we’ll add some logic in there to handle if there is no location provided with our tracking update.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">smsUpdates</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> body <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">,</span>\n      trackingStatus <span class=\"token operator\">=</span> body<span class=\"token punctuation\">.</span>tracking_status<span class=\"token punctuation\">,</span>\n      trackingLocation <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>trackingStatus<span class=\"token punctuation\">.</span>location <span class=\"token operator\">&amp;&amp;</span> trackingStatus<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>city<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      trackingLocation <span class=\"token operator\">=</span> trackingStatus<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>city <span class=\"token operator\">+</span> <span class=\"token string\">', '</span>\n      <span class=\"token operator\">+</span> trackingStatus<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>state\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    trackingLocation <span class=\"token operator\">=</span> <span class=\"token string\">'UNKNOWN'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now that we have our logic built for handling the body of the response and safely handle when we don’t get a location with our tracking status, we can dig into sending a formatted SMS using Twilio.</p>\n<p>The basic format for sending Twilio messages requires that we have a destination number (for sending our SMS to), our Twilio number that we’re sending from, and a message to send (duh!).</p>\n<p>Here is what it looks like once we add sending our message:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">smsUpdates</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> body <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">,</span>\n      trackingStatus <span class=\"token operator\">=</span> body<span class=\"token punctuation\">.</span>tracking_status<span class=\"token punctuation\">,</span>\n      trackingLocation <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>trackingStatus<span class=\"token punctuation\">.</span>location <span class=\"token operator\">&amp;&amp;</span> trackingStatus<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>city<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      trackingLocation <span class=\"token operator\">=</span> trackingStatus<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>city <span class=\"token operator\">+</span> <span class=\"token string\">', '</span>\n      <span class=\"token operator\">+</span> trackingStatus<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>state\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    trackingLocation <span class=\"token operator\">=</span> <span class=\"token string\">'UNKNOWN'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      statusCode<span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n      body<span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        input<span class=\"token operator\">:</span> event<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">const</span> destinationNumber <span class=\"token operator\">=</span> <span class=\"token string\">'+12025550119'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Replace with your own number</span>\n\t<span class=\"token keyword\">const</span> twilioNumber <span class=\"token operator\">=</span> <span class=\"token string\">'+12025550118'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Replace with your Twilio number</span>\n\n  twilio<span class=\"token punctuation\">.</span><span class=\"token function\">sendMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    to<span class=\"token operator\">:</span> destinationNumber<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">from</span><span class=\"token operator\">:</span> twilioNumber<span class=\"token punctuation\">,</span>\n    body<span class=\"token operator\">:</span> <span class=\"token string\">'Tracking #: '</span> <span class=\"token operator\">+</span> body<span class=\"token punctuation\">.</span>tracking_number <span class=\"token operator\">+</span>\n          <span class=\"token string\">'\\nStatus: '</span> <span class=\"token operator\">+</span> trackingStatus<span class=\"token punctuation\">.</span>status <span class=\"token operator\">+</span>\n          <span class=\"token string\">'\\nLocation: '</span> <span class=\"token operator\">+</span> trackingLocation\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">success</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>success<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>You’ll also notice that we create a <code class=\"language-text\">response</code> object for sending a 200 response back, since Shippo expects a 200 response when there is a successful receipt of a webhook post.</p>\n<p>We’re also using <code class=\"language-text\">console.log()</code> to log all messages to CloudWatch, which is really helpful in debugging or seeing the history of webhook events.</p>\n<p>Now is a good time for us to tackle fixing up the serverless.yml file that will tell serverless how we want our lambda function configured and what AWS services it would use.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> serverless<span class=\"token punctuation\">-</span>tracking\n\n<span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token key atrule\">runtime</span><span class=\"token punctuation\">:</span> nodejs4.3\n  <span class=\"token key atrule\">stage</span><span class=\"token punctuation\">:</span> dev\n  <span class=\"token key atrule\">region</span><span class=\"token punctuation\">:</span> us<span class=\"token punctuation\">-</span>west<span class=\"token punctuation\">-</span><span class=\"token number\">2</span>\n  <span class=\"token key atrule\">memorySize</span><span class=\"token punctuation\">:</span> <span class=\"token number\">128</span>\n\n<span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">smsUpdates</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.smsUpdates\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> smsupdates\n          <span class=\"token key atrule\">method</span><span class=\"token punctuation\">:</span> post\n          <span class=\"token key atrule\">integration</span><span class=\"token punctuation\">:</span> lambda\n          <span class=\"token key atrule\">cors</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></code></pre></div>\n<p>The above should get our function linked up to trigger when an AWS API Gateway endpoint <code class=\"language-text\">smsupdates</code> receives a POST. That should send off our tracking update to Twilio. If you want more details on configuring your Serverless service, checkout their docs <a href=\"https://serverless.com/framework/docs/providers/aws/guide/services/\">here</a>.</p>\n<p>Once you have your <code class=\"language-text\">serverless.yml</code> file setup, you can just use</p>\n<p><code class=\"language-text\">serverless deploy</code></p>\n<p>And your function should be uploaded to AWS with details about it logged out to the console.</p>\n<p>Next, navigate to <a href=\"https://app.goshippo.com/api\">https://app.goshippo.com/api</a> and scroll down to Webhooks to click <strong>+ Add Webhook</strong>. Since we had our route go to <code class=\"language-text\">smsupdates</code> we’ll want to append that to our url so that the updates post to the right place.</p>\n<p>Look for these lines:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">endpoints:\n  POST - https://YOUR_UNIQUE_ID.execute-api.us-west-2.amazonaws.com/dev/smsupdates</code></pre></div>\n<p>After pasting this into the URL field in Shippo, make sure that the dropdown under Event Type is set to tracking and click the green checkbox to save it. Now we can test the function by clicking on test on the far right. If everything goes well, you should receive an SMS with tracking information at the number you had in the <code class=\"language-text\">to</code> field of your Twilio sendMessage object.</p>\n<p>Now you can get SMS updates for all numbers that you post to Shippo automatically without having to provision any servers, and you only pay when you are receiving updates using Lambda and API Gateway with AWS. You could even take it a step further and include phone numbers for SMS updates in the <code class=\"language-text\">metadata</code> field when POSTing to Shippo and parse that out to dynamically send SMS updates to customers.</p>\n<p>You can find more information about Shippo and how to use their <a href=\"https://goshippo.com/docs\">shipping API</a> to improve your shipping experience at <a href=\"https://goshippo.com\">goshippo.com</a>.</p>","frontmatter":{"title":"How To Use AWS Lambda & API Gateway to Send Shipment Tracking Updates via SMS with Shippo & Twilio","date":"March 22, 2017","description":"A guide on using Serverless to create an AWS Lambda function that triggers on updates sent to AWS API Gateway to send SMS updates via Twilio for shipments you're tracking using Shippo"}}},"pageContext":{"slug":"/posts/2017-03-22-serverless-twilio-shippo/","previous":{"fields":{"slug":"/posts/2017-03-21-updated-openwhisk-plugin/"},"frontmatter":{"title":"New Event Sources and Other Updates in v0.5.0 of the OpenWhisk Plugin for the Serverless Framework"}},"next":{"fields":{"slug":"/posts/2017-03-29-serverless-v1.10.0/"},"frontmatter":{"title":"Faster Deployment for Large Services, Support for Node.js 6.10 Runtime with Serverless v1.10"}}}}}