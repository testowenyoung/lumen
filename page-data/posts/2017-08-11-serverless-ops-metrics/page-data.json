{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/2017-08-11-serverless-ops-metrics/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"9273a1c6-3934-5d46-99c1-2cb73a9bee8c","excerpt":"For many users, the biggest benefit of serverless is how managed it is — developers and designers don’t need to waste their time updating system packages or…","html":"<p>For many users, the biggest benefit of serverless is how <em>managed</em> it is — developers and designers don’t need to waste their time updating system packages or monitoring CPU usage. They can work on what they do best while the cloud provider handles most of the operations work.</p>\n<p>You can’t avoid operations entirely though. In this post, we’ll talk about the basics of monitoring your Lambda functions with CloudWatch metrics. This is the first post in a series of the basics of serverless operations.</p>\n<h1>Basic CloudWatch metrics</h1>\n<p>CloudWatch helps you by monitoring certain metrics for all of your Lambda functions automatically. These metrics include:</p>\n<ul>\n<li><strong>Invocations:</strong> The number of times your function is invoked;</li>\n<li><strong>Errors:</strong> The number of times your function fails with an error, due to timeouts, memory issues, unhandled exceptions, or other issues;</li>\n<li><strong>Throttles:</strong> The number of times your function is throttled. AWS <a href=\"http://docs.aws.amazon.com/lambda/latest/dg/concurrent-executions.html\">limits the concurrent number of executions</a> across all your functions. If you exceed that, your function will be throttled and won’t be allowed to run.</li>\n<li><strong>Duration:</strong> How long your function runs.</li>\n</ul>\n<p>For every serverless service I run, I care about Errors and Throttles. I want to know if my code is failing for any reason, whether errors in my code or too many concurrent Lambda invocations in my account.</p>\n<p>To monitor Errors and Throttles, I use the <a href=\"https://github.com/ACloudGuru/serverless-plugin-aws-alerts\">serverless-plugin-aws-alerts</a> plugin from the folks at A Cloud Guru. It makes it easy to set up alerts for your services.</p>\n<p>To use it in your Serverless service, first install the plugin in your Serverless service:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">npm</span> <span class=\"token function\">install</span> serverless-plugin-aws-alerts --save-dev</code></pre></div>\n<p>Then add it to your <code class=\"language-text\">serverless.yml</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># serverless.yml</span>\n\n<span class=\"token key atrule\">plugins</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> serverless<span class=\"token punctuation\">-</span>plugin<span class=\"token punctuation\">-</span>aws<span class=\"token punctuation\">-</span>alerts\n\n<span class=\"token key atrule\">custom</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">alerts</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">stages</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> production\n    <span class=\"token key atrule\">topics</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">alarm</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">topic</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>self<span class=\"token punctuation\">:</span>service<span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">{</span>opt<span class=\"token punctuation\">:</span>stage<span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>alerts<span class=\"token punctuation\">-</span>alarm\n        <span class=\"token key atrule\">notifications</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> email\n            <span class=\"token key atrule\">endpoint</span><span class=\"token punctuation\">:</span> name@domain.com <span class=\"token comment\"># Change this to your email address</span>\n    <span class=\"token key atrule\">alarms</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> functionErrors\n      <span class=\"token punctuation\">-</span> functionThrottles</code></pre></div>\n<p>This setup adds alerts to all of our functions in our service when deployed to the <code class=\"language-text\">production</code> stage. For every one minute period where I have 1+ errors or throttles, I’ll get at email to <code class=\"language-text\">name@domain.com</code>. (Make sure to change the email to your email.)</p>\n<h1>Advanced Usage: Custom CloudWatch Metrics</h1>\n<p>In addition to Lambda’s out-of-the-box CloudWatch metrics, you can also create your own custom metrics.</p>\n<p>Imagine you have a Lambda function that is processing records from a Kinesis stream. Your Lambda function will receive a batch of multiple records. Because of this batch, your visibility into what is happening is limited in a few ways:</p>\n<ol>\n<li>You can’t tell by the Invocations metric how many records were processed; and</li>\n<li>If there’s a record with unexpected input, you may want to know about it without throwing a hard error. Throwing an exception in a batch of Kinesis records will end up retrying the entire batch of records.</li>\n</ol>\n<p>We can handle both of these problems with CloudWatch custom metrics. Using the AWS SDK, you can make a <code class=\"language-text\">put_metric_data()</code> call with a CloudWatch client.</p>\n<p>The example below is in Python, but the APIs are similar for other languages:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># handler.py</span>\n\n<span class=\"token keyword\">import</span> datetime\n\n<span class=\"token keyword\">import</span> boto3\n\n<span class=\"token comment\"># initialize our Cloudwatch client</span>\nCLOUDWATCH <span class=\"token operator\">=</span> boto3<span class=\"token punctuation\">.</span>client<span class=\"token punctuation\">(</span><span class=\"token string\">'cloudwatch'</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">for</span> record <span class=\"token keyword\">in</span> event<span class=\"token punctuation\">[</span><span class=\"token string\">'Records'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># Processing logic here</span>\n        process_record<span class=\"token punctuation\">(</span>record<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># After we've processed the records, emit metric</span>\n    <span class=\"token comment\"># for the number of records we've seen.</span>\n    CLOUDWATCH<span class=\"token punctuation\">.</span>put_metric_data<span class=\"token punctuation\">(</span>\n        Namespace<span class=\"token operator\">=</span><span class=\"token string\">'AWS/Lambda'</span><span class=\"token punctuation\">,</span>\n        MetricData<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token string\">'MetricName'</span><span class=\"token punctuation\">:</span>  <span class=\"token string\">'KinesisRecordsSeen'</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">'Dimensions'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n                    <span class=\"token punctuation\">{</span>\n                        <span class=\"token string\">'Name'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'FunctionName'</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string\">'Value'</span><span class=\"token punctuation\">:</span> context<span class=\"token punctuation\">.</span>function_name\n                    <span class=\"token punctuation\">{</span>\n                <span class=\"token punctuation\">]</span>\n                <span class=\"token string\">'Timestamp'</span><span class=\"token punctuation\">:</span> datetime<span class=\"token punctuation\">.</span>datetime<span class=\"token punctuation\">.</span>now<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">'Value'</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">[</span><span class=\"token string\">'Records'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span></code></pre></div>\n<p>In this example, we’re storing a metric named <code class=\"language-text\">KinesisRecordsSeen</code> that stores the number of Kinesis records in each Lambda invocation batch. We’re storing the metric in the <code class=\"language-text\">AWS/Lambda</code> namespace with a <code class=\"language-text\">FunctionName</code> dimension to segregate metrics from one another, so I could have a <code class=\"language-text\">KinesisRecordsSeen</code> metric for each of my different functions.</p>\n<p>I can easily set up alerts on my custom metrics as well. Let’s say I want an email alert whenever I see more than 1000 Kinesis records in 5 minutes:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># serverless.yml</span>\n\n<span class=\"token key atrule\">plugins</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> serverless<span class=\"token punctuation\">-</span>plugin<span class=\"token punctuation\">-</span>aws<span class=\"token punctuation\">-</span>alerts\n\n<span class=\"token key atrule\">custom</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">alerts</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">stages</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> producton\n    <span class=\"token key atrule\">topics</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">alarm</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">topic</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>self<span class=\"token punctuation\">:</span>service<span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">{</span>opt<span class=\"token punctuation\">:</span>stage<span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>alerts<span class=\"token punctuation\">-</span>alarm\n        <span class=\"token key atrule\">notifications</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> email\n            <span class=\"token key atrule\">endpoint</span><span class=\"token punctuation\">:</span> name@domain.com\n    <span class=\"token key atrule\">definitions</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">tooManyRecordsAlarm</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">description</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Record overflow'</span>\n        <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'AWS/Lambda'</span>\n        <span class=\"token key atrule\">metric</span><span class=\"token punctuation\">:</span> KinesisRecordsSeen\n        <span class=\"token key atrule\">threshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1000</span>\n        <span class=\"token key atrule\">statistic</span><span class=\"token punctuation\">:</span> Sum\n        <span class=\"token key atrule\">period</span><span class=\"token punctuation\">:</span> <span class=\"token number\">600</span>\n        <span class=\"token key atrule\">evaluationPeriods</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n        <span class=\"token key atrule\">comparisonOperator</span><span class=\"token punctuation\">:</span> GreaterThanOrEqualToThreshold\n    <span class=\"token key atrule\">alarms</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> tooManyRecordsAlarm</code></pre></div>\n<p>A caveat here is that this will add latency to your overall Lambda execution as you will be waiting on the API call to CloudWatch. If you’d like, you could avoid this by using CloudWatch log Metric Filters to create metrics from your logs instead — more detail <a href=\"http://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/MonitoringLogData.html\">here</a>.</p>\n<p>As your Serverless application gets more serious, you will want to track metrics more closely using a tool like DataDog, IOPipe, or Honeycomb. But for quick and easy monitoring, it’s hard to go wrong with CloudWatch and the <a href=\"https://github.com/ACloudGuru/serverless-plugin-aws-alerts\">serverless-plugin-aws-alerts</a> plugin.</p>\n<h2>Next post in the Serverless Ops series:</h2>\n<ul>\n<li><a href=\"https://serverless.com/blog/serverless-ops-logs/\">Serverless Ops 102: CloudWatch Logs and Centralized Logging with AWS Lambda</a></li>\n</ul>","frontmatter":{"title":"Serverless Ops 101 - Using CloudWatch Metrics & Alarms with Serverless Functions","date":"August 11, 2017","description":"Level up your serverless ops game with a walkthrough on CloudWatch metrics and alarms"}}},"pageContext":{"slug":"/posts/2017-08-11-serverless-ops-metrics/","previous":{"fields":{"slug":"/posts/2017-08-10-event-driven-influencers-accenture/"},"frontmatter":{"title":"Event-driven Influencers - Accenture"}},"next":{"fields":{"slug":"/posts/2017-08-14-aws-resources-to-master-cloud/"},"frontmatter":{"title":"Use These 5 AWS Learning Resources to Master the Cloud"}}}}}