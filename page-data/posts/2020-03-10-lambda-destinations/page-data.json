{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/2020-03-10-lambda-destinations/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"0cb366d6-654b-540f-839d-b47b95cdf081","excerpt":"What Are Lambda Destinations? We first wrote about Lambda Destinations when AWS announced support for them right before re:Invent 2019. Essentially…","html":"<h1>What Are Lambda Destinations?</h1>\n<p>We first <a href=\"https://serverless.com/blog/november-2019-lambda-releases/\">wrote about</a> Lambda Destinations when AWS announced support for them right before re:Invent 2019.</p>\n<p>Essentially, destinations are the ability for asynchronous Lambda invocations to have their execution results sent to other AWS services without needing to wait for the Lambda execution to finish. Previously, you would have to wait for a Lambda success or failure or need to leverage something like Step Functions. Now, you can invoke functions asynchronously, and send the results of the invocations to different places depending on success or failure.</p>\n<p>Today, we’re excited to announce support for Lambda Destinations in the Serverless Framework! Make sure you’ve <a href=\"https://serverless.com/framework/docs/getting-started/\">upgraded to</a> <code class=\"language-text\">v1.66.0</code> or higher and let’s look at how to add them.</p>\n<p>You can watch the video below for an abbreviated version or work through the entire guide!</p>\n<div class=\"gatsby-resp-iframe-wrapper\" style=\"padding-bottom: 56.25%; position: relative; height: 0; overflow: hidden; margin-bottom: 1.0725rem\" > <iframe src=\"https://www.youtube.com/embed/8KBLzRi76Tc\" frameborder=\"0\" allow=\"accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen style=\" position: absolute; top: 0; left: 0; width: 100%; height: 100%; \"></iframe> </div>\n<h1>Adding Lambda Destinations</h1>\n<p>The first step to adding Lambda destinations is to decide what resources you would like to use as a destination on a success or failure. Currently, event destinations can be configured as another Lambda function, an SNS topic, SQS queue, or Amazon EventBridge. You can either create these resources in your <code class=\"language-text\">serverless.yml</code> file or you can reference already-existing resource ARNs. </p>\n<p>Inside of <code class=\"language-text\">serverless.yml</code>, you’ll add a <code class=\"language-text\">destinations</code> section to a function that you want to configure Event destinations with:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">helloStarting</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.starting\n    <span class=\"token key atrule\">destinations</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">onSuccess</span><span class=\"token punctuation\">:</span> someOtherFunction\n      <span class=\"token key atrule\">onFailure</span><span class=\"token punctuation\">:</span> arn<span class=\"token punctuation\">:</span>of<span class=\"token punctuation\">:</span>some<span class=\"token punctuation\">:</span>existing<span class=\"token punctuation\">:</span>resource</code></pre></div>\n<p>Inside of the <code class=\"language-text\">destinations</code> configuration you can add either an <code class=\"language-text\">onSuccess</code> or <code class=\"language-text\">onFailure</code> or both. The value for those bits of configuration can either be another function defined in the same <code class=\"language-text\">serverless.yml</code> file or an ARN of the destination resource.</p>\n<p>Now let’s look at a few configuration examples. You can find full-fledged example services of the below snippets on <a href=\"https://github.com/fernando-mc/serverless-event-destinations\">GitHub here</a>.</p>\n<h2>Function Event Destinations from the Same Service</h2>\n<p>One of the easiest ways to configure event destinations with your Lambda functions is to refer to other Lambda functions that you’re already creating in your service in the same <code class=\"language-text\">serverless.yml</code> file. For example, in the below snippet, the functions section creates a <code class=\"language-text\">helloStarting</code> function that then uses the <code class=\"language-text\">helloSuccess</code> and <code class=\"language-text\">helloFailure</code> functions as destinations:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">helloStarting</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.starting\n    <span class=\"token key atrule\">destinations</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">onSuccess</span><span class=\"token punctuation\">:</span> helloSuccess\n      <span class=\"token key atrule\">onFailure</span><span class=\"token punctuation\">:</span> helloFailure\n  <span class=\"token key atrule\">helloSuccess</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> success.handler\n  <span class=\"token key atrule\">helloFailure</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> failure.handler</code></pre></div>\n<p>This configuration has the benefit of creating a per-stage destination automatically as you deploy your service across stages like <code class=\"language-text\">dev</code> and <code class=\"language-text\">prod</code>. </p>\n<h2>ARN-based Destinations</h2>\n<p>If you already have existing resources for your event destinations, you can also reference them using the ARN value of those destinations. For example:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">helloStarting</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.starting\n    <span class=\"token key atrule\">destinations</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">onSuccess</span><span class=\"token punctuation\">:</span> arn<span class=\"token punctuation\">:</span>aws<span class=\"token punctuation\">:</span>sqs<span class=\"token punctuation\">:</span>us<span class=\"token punctuation\">-</span>east<span class=\"token punctuation\">-</span>1<span class=\"token punctuation\">:</span>444455556666<span class=\"token punctuation\">:</span>successQueue\n      <span class=\"token key atrule\">onFailure</span><span class=\"token punctuation\">:</span> arn<span class=\"token punctuation\">:</span>aws<span class=\"token punctuation\">:</span>lambda<span class=\"token punctuation\">:</span>us<span class=\"token punctuation\">-</span>east<span class=\"token punctuation\">-</span>1<span class=\"token punctuation\">:</span>444455556666<span class=\"token punctuation\">:</span>function<span class=\"token punctuation\">:</span>failureFunction</code></pre></div>\n<p>In the above example, we’ve already created an SQS queue called <code class=\"language-text\">successQueue</code> and a Lambda Function called <code class=\"language-text\">failureFunction</code> and we’ve configured our function to deliver success and failure event to each of them, respectively. </p>\n<p>There is one potential issue with this sort of configuration though. You may not want to send success and failure notifications for every application stage to the same place. Let’s take a look at at least one way of fixing this.</p>\n<h2>Stage-based Destinations</h2>\n<p>If you want separate destinations depending on the stage of your service you can use a few different methods to accomplish this. </p>\n<h3>Framework Pro Parameters</h3>\n<p>One of the simplest ways to accomplish this would be to leverage <a href=\"https://serverless.com/framework/docs/dashboard/parameters/\">Framework Pro Parameters</a> and load them in at deployment time:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">org</span><span class=\"token punctuation\">:</span> fernando\n<span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> destinations\n<span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> stage<span class=\"token punctuation\">-</span>based<span class=\"token punctuation\">-</span>destinations<span class=\"token punctuation\">-</span>framework<span class=\"token punctuation\">-</span>pro\n\n<span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token key atrule\">runtime</span><span class=\"token punctuation\">:</span> python3.8\n\n<span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">helloStarting</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.starting\n    <span class=\"token key atrule\">destinations</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">onSuccess</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>params<span class=\"token punctuation\">:</span>SUCCESS_ARN<span class=\"token punctuation\">}</span>\n      <span class=\"token key atrule\">onFailure</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>params<span class=\"token punctuation\">:</span>FAILURE_ARN<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This way, the framework will load the relevant parameter at deployment time from <a href=\"https://dashboard.serverless.com/\">Framework Pro</a>.</p>\n<h3>Stage Variables in Event Destinations</h3>\n<p>You can also forego Framework Pro and create destinations resources with the stage as part of their name. For example, a destination queue for success messages in the <code class=\"language-text\">dev</code> stage might become <code class=\"language-text\">successQueue-dev</code> and in prod <code class=\"language-text\">successQueue-prod</code>. Then, you can create the final ARN at deployment time based on the stage:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token key atrule\">runtime</span><span class=\"token punctuation\">:</span> python3.8\n  <span class=\"token key atrule\">stage</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>opt<span class=\"token punctuation\">:</span>stage<span class=\"token punctuation\">,</span> <span class=\"token string\">'dev'</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">helloStarting</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.starting\n    <span class=\"token key atrule\">destinations</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">onSuccess</span><span class=\"token punctuation\">:</span> arn<span class=\"token punctuation\">:</span>aws<span class=\"token punctuation\">:</span>sqs<span class=\"token punctuation\">:</span>us<span class=\"token punctuation\">-</span>east<span class=\"token punctuation\">-</span>1<span class=\"token punctuation\">:</span>444455556666<span class=\"token punctuation\">:</span>successQueue<span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">{</span>self<span class=\"token punctuation\">:</span>provider.stage<span class=\"token punctuation\">}</span>\n      <span class=\"token key atrule\">onFailure</span><span class=\"token punctuation\">:</span> arn<span class=\"token punctuation\">:</span>aws<span class=\"token punctuation\">:</span>sns<span class=\"token punctuation\">:</span>us<span class=\"token punctuation\">-</span>east<span class=\"token punctuation\">-</span>1<span class=\"token punctuation\">:</span>444455556666<span class=\"token punctuation\">:</span>failureTopic<span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">{</span>self<span class=\"token punctuation\">:</span>provider.stage<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This sort of configuration assumes you’ve already created all the resources required to configure with the destinations.</p>\n<h2>Testing the Destinations</h2>\n<p>So how would we test one of these examples? </p>\n<p>First, clone the examples repo from GitHub <a href=\"https://github.com/fernando-mc/serverless-event-destinations\">here</a>. There are several examples in that repo, but change directories into the <code class=\"language-text\">arn-based-event-destinations</code> and we’ll go from there.</p>\n<p>First, we can create a single SQS queue for failure and success events to end up in.</p>\n<ol>\n<li>Run <code class=\"language-text\">aws sqs create-queue --queue-name destinationQueue</code> to create a queue</li>\n<li>\n<p>Then, copy the output queue url into the following command to get the QueueArn:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">aws sqs get-queue-attributes \\\n--queue-url &lt;the-queue-url&gt; \\\n--attribute-names QueueArn```</code></pre></div>\n</li>\n</ol>\n<p>Now that we have the ARN value, replace the existing <code class=\"language-text\">onSuccess</code> and <code class=\"language-text\">onFailure</code> ARNs inside of the <code class=\"language-text\">serverless.yml</code> file. You should end up with something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> arn<span class=\"token punctuation\">-</span>based<span class=\"token punctuation\">-</span>destinations\n\n<span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token key atrule\">runtime</span><span class=\"token punctuation\">:</span> python3.8\n\n<span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">helloStarting</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.starting\n    <span class=\"token key atrule\">destinations</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">onSuccess</span><span class=\"token punctuation\">:</span> arn<span class=\"token punctuation\">:</span>aws<span class=\"token punctuation\">:</span>sqs<span class=\"token punctuation\">:</span>us<span class=\"token punctuation\">-</span>east<span class=\"token punctuation\">-</span>1<span class=\"token punctuation\">:</span>123456777888<span class=\"token punctuation\">:</span>successQueueDemo\n      <span class=\"token key atrule\">onFailure</span><span class=\"token punctuation\">:</span> arn<span class=\"token punctuation\">:</span>aws<span class=\"token punctuation\">:</span>sqs<span class=\"token punctuation\">:</span>us<span class=\"token punctuation\">-</span>east<span class=\"token punctuation\">-</span>1<span class=\"token punctuation\">:</span>123456777888<span class=\"token punctuation\">:</span>successQueueDemo</code></pre></div>\n<p>From here, we can run <code class=\"language-text\">serverless deploy</code> to set everything up. When the deployment is finished, we can invoke our function with events that will cause the function to succeed and fail and then review the results in the SQS queue.</p>\n<p>Run this a few times to create a few successful events:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws lambda invoke --function-name arn-based-destinations-dev-helloStarting --invocation-type Event --payload <span class=\"token string\">'{ \"Success\": true }'</span> response.json</code></pre></div>\n<p>Then, you can run this one a few times to cause some failures:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws lambda invoke --function-name arn-based-destinations-dev-helloStarting --invocation-type Event --payload <span class=\"token string\">'{ \"Success\": false }'</span> response.json</code></pre></div>\n<p>If you’ve changed the service or the function name before you deployed you’ll need to make sure to update the <code class=\"language-text\">--function-name</code> value in the commands.</p>\n<p>When you’re done, you can review the results in the queue you created.You’ll need to replace <code class=\"language-text\">&lt;queueUrl&gt;</code> with your queue URL in the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws sqs receive-message --queue-url <span class=\"token operator\">&lt;</span>queueUrl<span class=\"token operator\">></span> --attribute-names All --message-attribute-names All --max-number-of-messages <span class=\"token number\">10</span></code></pre></div>\n<p>If you need the url, you can always run the <code class=\"language-text\">aws sqs list-queues</code> command.\nIt might take a moment for the messages to make their way to the SQS queue, but when they are there you should see something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n    &quot;Messages&quot;: [\n        {\n            &quot;MessageId&quot;: &quot;169e1a5a-7200-4df9-9cf2-46fbde04af79&quot;,\n            &quot;ReceiptHandle&quot;: &quot;AQEBFnz9cRqIrl2XGFilWVyBXSUlA3mHYvwzsk5Yi1781G9txOpxLTpadribqYKs3DBi0DBL3skv5wRfVJKCQxVCoZ6Lh7Bd/qBBjyg359qc5910HPy07wbWhAYbaE6S2ZhHAsIjmiBf9cfk7/yu8IhFvstVlycYCZ0BM7Ca6DN29O0mN5PHBSdEsA4dLZ172irtzAM9jOc8n9vS3lBfvfCbRjpMJylPTMoMdlE/uvB8RpJC4FkXtLwxHRP+d0WvbO0VsMt+z/dgJk5z0ORfmZlu94RpIHZ4+PoyLja35e43eAGGjHyqRQCpCIROrI2c3tvjRkUknFHTFtYqvGFs4Jj7OVHJ2D9riDHDLBhVjvGDCzMbSHWdnyOqVeojIyarh6nFKJb/iXE6hrTX3zNslE/kDQ==&quot;,\n            &quot;MD5OfBody&quot;: &quot;332ed48526ab22a68a161b100f83a4bc&quot;,\n            &quot;Body&quot;: &quot;{\\&quot;version\\&quot;:\\&quot;1.0\\&quot;,\\&quot;timestamp\\&quot;:\\&quot;2020-03-09T22:01:53.075Z\\&quot;,\\&quot;requestContext\\&quot;:{\\&quot;requestId\\&quot;:\\&quot;cabbfbd0-e266-42a9-a52e-6e96eb16c695\\&quot;,\\&quot;functionArn\\&quot;:\\&quot;arn:aws:lambda:us-east-1:757370802528:function:arn-based-destinations-dev-helloStarting:$LATEST\\&quot;,\\&quot;condition\\&quot;:\\&quot;RetriesExhausted\\&quot;,\\&quot;approximateInvokeCount\\&quot;:3},\\&quot;requestPayload\\&quot;:{ \\&quot;Success\\&quot;: true },\\&quot;responseContext\\&quot;:{\\&quot;statusCode\\&quot;:200,\\&quot;executedVersion\\&quot;:\\&quot;$LATEST\\&quot;,\\&quot;functionError\\&quot;:\\&quot;Unhandled\\&quot;},\\&quot;responsePayload\\&quot;:{\\&quot;errorMessage\\&quot;: \\&quot;name &#39;body&#39; is not defined\\&quot;, \\&quot;errorType\\&quot;: \\&quot;NameError\\&quot;, \\&quot;stackTrace\\&quot;: [\\&quot;  File \\\\\\&quot;/var/task/handler.py\\\\\\&quot;, line 8, in starting\\\\n    \\\\\\&quot;body\\\\\\&quot;: json.dumps(body)\\\\n\\&quot;]}}&quot;,\n            &quot;Attributes&quot;: {\n                &quot;SenderId&quot;: &quot;AROA3AVWRKFQPTOBYHBI4:awslambda_212_20200309184354940&quot;,\n                &quot;ApproximateFirstReceiveTimestamp&quot;: &quot;1583791332207&quot;,\n                &quot;ApproximateReceiveCount&quot;: &quot;1&quot;,\n                &quot;SentTimestamp&quot;: &quot;1583791313178&quot;\n            }\n        }\n    ]\n}</code></pre></div>\n<p>And that’s it! You’ve successfully configured and tested your Event Destinations.</p>\n<h2>Now What?</h2>\n<p>Now that you’ve configured your first event destination you can use them to save yourself from architectures that have to wait for Lambda Functions to finish their invocation and then return a response. This means you can avoid situations where one function is doing nothing, and waiting for the service or function it called to respond. Instead, you can use Event Destinations to process any successes or failures appropriately once the Lambda Function has done it’s job.</p>\n<p>If you didn’t have enough fun with the example above, or the <a href=\"https://github.com/fernando-mc/serverless-event-destinations\">other examples in GitHub</a>, there are also plenty of other ways to configure Event Destination resources! You can:</p>\n<ol>\n<li>Store ARN values in SSM and pull them in with the SSM variable syntax: <code class=\"language-text\">${ssm:paramName}</code></li>\n<li>Reference ARN outputs from other services with <a href=\"https://serverless.com/framework/docs/dashboard/output-variables/\">Framework Pro Outputs</a> and the outputs variable syntax: <code class=\"language-text\">${output:my-service.myOutputKey}</code></li>\n</ol>\n<p>We hope this helps you get started with Event Destinations in the Serverless Framework! Have questions about Event Destinations? <a href=\"https://twitter.com/fmc_sea\">Get in touch</a> or leave a comment below!</p>","frontmatter":{"title":"AWS Lambda Destination Support","date":"March 10, 2020","description":"The Serverless Framework now supports the recently released Lambda Event Destinations."}}},"pageContext":{"slug":"/posts/2020-03-10-lambda-destinations/","previous":{"fields":{"slug":"/posts/2020-03-06-cicd-for-monorepos/"},"frontmatter":{"title":"CI/CD for monorepos"}},"next":{"fields":{"slug":"/posts/2020-03-13-official-guide-aws-http-apis/"},"frontmatter":{"title":"The Official Guide to AWS HTTP APIs"}}}}}