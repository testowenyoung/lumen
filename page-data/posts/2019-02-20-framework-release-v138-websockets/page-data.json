{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/2019-02-20-framework-release-v138-websockets/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"bedfd078-03f1-5318-bdf2-f12143e66bd5","excerpt":"As many of you likely remember, AWS finally added support for WebSockets in API Gateway & Lambda at last year’s re:Invent. While we were all waiting for…","html":"<p>As many of you likely remember, <a href=\"https://serverless.com/blog/reinvent-2018-serverless-announcements#websocket-support-for-aws-lambda\">AWS finally added support for WebSockets in API Gateway &#x26; Lambda</a> at last year’s re:Invent. While we were all waiting for CloudFormation support, we created an <a href=\"https://github.com/serverless/serverless-websockets-plugin\">official Serverless Framework plugin</a> to support WebSockets in the Framework right away.</p>\n<p>This was only a temporary measure until CloudFormation support was added. And now, it has been! So we are incredibly excited to announce that the <a href=\"https://serverless.com/framework/\">Serverless Framework</a> v1.38 now has support for WebSockets integrated into Framework core. No plugin required.</p>\n<p><strong>Note:</strong> This means that the <a href=\"https://github.com/serverless/serverless-websockets-plugin\">serverless-websockets-plugin</a> is officially deprecated. We will no longer maintain it.</p>\n<h4>Get Started with WebSockets on the Serverless Framework</h4>\n<p>To start using WebSockets in your serverless projects, subscribe your functions to the new <code class=\"language-text\">websocket</code> event by specifying the desired routes that would invoke your function: </p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">default</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.default\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">websocket</span><span class=\"token punctuation\">:</span> $default</code></pre></div>\n<p>This will create a <code class=\"language-text\">$default</code> route that will forward all WebSocket events (including <code class=\"language-text\">$connect</code> and <code class=\"language-text\">$disconnect</code>) to your <code class=\"language-text\">default</code> function.</p>\n<p>You can also specify your event as an object and add more routes:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">connect</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.connect\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">websocket</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">route</span><span class=\"token punctuation\">:</span> $connect\n  <span class=\"token key atrule\">disconnect</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.disconnect\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">websocket</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">route</span><span class=\"token punctuation\">:</span> $disconnect\n  <span class=\"token key atrule\">default</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.default\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">websocket</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">route</span><span class=\"token punctuation\">:</span> $default\n  <span class=\"token key atrule\">echo</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.echo\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">websocket</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">route</span><span class=\"token punctuation\">:</span> $echo</code></pre></div>\n<p>The object notation will be useful when you want to add more configuration to your WebSocket events. For example, when we add support for authorizers in an upcoming release.</p>\n<p>Once you deploy this service, you’ll see the endpoint of your WebSocket backend in your terminal. Using this endpoint, you can connect to your WebSocket backend using any WebSocket client.</p>\n<p>You could also have another function with <code class=\"language-text\">http</code> event, so your service would expose two endpoints: one for websockets, the other for http.</p>\n<h5>Specifying Route Selection Expression</h5>\n<p>By default, the route selection expression is set to <code class=\"language-text\">$request.body.action</code>. This property tells API Gateway how to parse the data coming into your WebSocket endpoint.</p>\n<p>So with this default behavior and using the service above, you can invoke the <code class=\"language-text\">echo</code> function by using the following JSON object as your websocket event body: </p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"action\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"echo\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"data\"</span><span class=\"token operator\">:</span>  <span class=\"token string\">\"hello\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>You can overwrite the route expression by specifying the <code class=\"language-text\">websocketsApiRouteSelectionExpression</code> key in the <code class=\"language-text\">provider</code> object:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token key atrule\">runtime</span><span class=\"token punctuation\">:</span> nodejs8.10\n  <span class=\"token key atrule\">websocketsApiRouteSelectionExpression</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$request.body.route\"</span></code></pre></div>\n<p>In that case, your WebSocket body should be:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"route\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"echo\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"data\"</span><span class=\"token operator\">:</span>  <span class=\"token string\">\"hello\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Remember that any other body/data coming to your WebSocket backend would invoke the default function.</p>\n<h5>Communicating with clients</h5>\n<p>The Framework also takes care of setting the permissions required for your Lambda function to communicate to the connected clients. This means you’ll be able to send data to any client right away by using the new <code class=\"language-text\">ApiGatewayManagementApi</code> Service, without having to worry about IAM policies:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  <span class=\"token keyword\">const</span> client <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AWS<span class=\"token punctuation\">.</span>ApiGatewayManagementApi</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    apiVersion<span class=\"token operator\">:</span> <span class=\"token string\">'2018-11-29'</span><span class=\"token punctuation\">,</span>\n    endpoint<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">https://</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>event<span class=\"token punctuation\">.</span>requestContext<span class=\"token punctuation\">.</span>domainName<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>event<span class=\"token punctuation\">.</span>requestContext<span class=\"token punctuation\">.</span>stage<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">await</span> client\n    <span class=\"token punctuation\">.</span><span class=\"token function\">postToConnection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      ConnectionId<span class=\"token operator\">:</span> event<span class=\"token punctuation\">.</span>requestContext<span class=\"token punctuation\">.</span>connectionId<span class=\"token punctuation\">,</span>\n      Data<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">echo route received: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>event<span class=\"token punctuation\">.</span>body<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong>Note:</strong> At the time of writing, the Lambda runtime does not include the latest version of the AWS SDK that contains this new <code class=\"language-text\">ApiGatewayManagementApi</code> service. So you’ll have to deploy your own by adding it to your <code class=\"language-text\">package.json</code>.</p>\n<p>And that’s pretty much all you need to do to get started with WebSockets events! For more information, <a href=\"https://serverless.com/framework/docs/providers/aws/events/websocket/\">please check out our docs</a>.</p>\n<h3>Changelog</h3>\n<p>Other than WebSockets support, we added a lot of enhancements and bug fixes in this release. Here’s our changelog, with some links to the corresponding PRs.</p>\n<ul>\n<li><a href=\"https://github.com/serverless/serverless/pull/5796\">Set timeout &#x26; others on context in python invoke local</a></li>\n<li><a href=\"https://github.com/serverless/serverless/pull/5799\">Append in Custom Syntax</a></li>\n<li><a href=\"https://github.com/serverless/serverless/pull/5798\">Don’t load config for <code class=\"language-text\">config</code></a></li>\n<li><a href=\"https://github.com/serverless/serverless/pull/5791\">Replace blocking fs.readFileSync with non blocking fs.readFile in checkForChanges.js</a></li>\n<li><a href=\"https://github.com/serverless/serverless/pull/5787\">Added layer option for deploy function update-config</a></li>\n<li><a href=\"https://github.com/serverless/serverless/pull/5809\">fix makeDeepVariable replacement</a></li>\n<li><a href=\"https://github.com/serverless/serverless/pull/5718\">Make local ruby pry work</a></li>\n<li><a href=\"https://github.com/serverless/serverless/pull/5808\">Replace \\ with / in paths on windows before passing to nanomatch</a></li>\n<li><a href=\"https://github.com/serverless/serverless/pull/5813\">Support deploying GoLang to AWS from Windows!</a></li>\n<li><a href=\"https://github.com/serverless/serverless/pull/5816\">Fix windows go rework</a></li>\n<li><a href=\"https://github.com/serverless/serverless/pull/5826\">Make use of join operator first argument in sns docs</a></li>\n<li><a href=\"https://github.com/serverless/serverless/pull/5821\">add support for command type=‘container’</a></li>\n<li><a href=\"https://github.com/serverless/serverless/pull/5819\">Add Google Python function template</a></li>\n<li><a href=\"https://github.com/serverless/serverless/pull/5827\">Update config-credentials.md</a></li>\n<li><a href=\"https://github.com/serverless/serverless/pull/5800\">Update bucket conf to default AES256 encryption.</a></li>\n<li><a href=\"https://github.com/serverless/serverless/pull/5825\">Fix: override wildcard glob pattern (**) in resolveFilePathsFromPatterns</a></li>\n<li><a href=\"https://github.com/serverless/serverless/pull/5832\">Indicate unused context in aws-nodejs-typescipt</a></li>\n<li><a href=\"https://github.com/serverless/serverless/pull/5835\">Add stack trace to aws/invokeLocal errors</a></li>\n<li><a href=\"https://github.com/serverless/serverless/pull/5836\">Missing underscore</a></li>\n<li><a href=\"https://github.com/serverless/serverless/pull/5690\">Updating cloudformation resource reference url</a></li>\n<li><a href=\"https://github.com/serverless/serverless/pull/5843\">Docs: Replacing “runtimes” with “templates”</a></li>\n<li><a href=\"https://github.com/serverless/serverless/pull/5824\">Add support for websockets event</a></li>\n<li><a href=\"https://github.com/serverless/serverless/pull/5842\">AWS: ${ssm} resolve vairbale as JSON if it is stored as JSON in Secrets Manager</a></li>\n<li><a href=\"https://github.com/serverless/serverless/pull/5839\">Fix service name in template install message</a></li>\n</ul>\n<h4>Roadmap and focus</h4>\n<p>Over the next few releases, we’ll be enhancing WebSockets support with more features, like authorizers and request responses. We’re also focusing on improving the local development experience. Keep an eye on the upcoming milestones to stay up to date with what’s coming:</p>\n<ul>\n<li><a href=\"https://github.com/serverless/serverless/milestone/61\">v1.39.0 Milestone</a></li>\n<li><a href=\"https://github.com/serverless/serverless/milestone/62\">v1.40.0 Milestone</a></li>\n</ul>\n<h4>Contributor thanks</h4>\n<p>We had more than 20 contributors have their work go into this release and we can’t thank each of them enough. You all make the community special.</p>\n<p>Want to have your github avatar and name in the next release post? Check out these <a href=\"https://github.com/serverless/serverless/issues?q=is%3Aopen+is%3Aissue+label%3A%22help+wanted%22\">issues we are looking for help on</a>!</p>","frontmatter":{"title":"Serverless Framework v1.38 - Introducing Websockets Support","date":"February 21, 2019","description":"The latest Serverless Framework v1.38 release includes WebSockets support!"}}},"pageContext":{"slug":"/posts/2019-02-20-framework-release-v138-websockets/","previous":{"fields":{"slug":"/posts/2019-02-11-serverless-top-three/"},"frontmatter":{"title":"Serverless named EMA Top 3 for serverless technologies!"}},"next":{"fields":{"slug":"/posts/2019-02-26-shamrock-transacts-billions/"},"frontmatter":{"title":"How Shamrock transacts billions of dollars with Serverless Framework Enterprise"}}}}}