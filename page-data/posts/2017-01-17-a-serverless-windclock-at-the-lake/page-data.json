{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/2017-01-17-a-serverless-windclock-at-the-lake/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"ff7dca4b-9bbc-5a11-8cba-8f215ac342b1","excerpt":"Hi, I’m Douwe Homans. I’m a trained medical doctor, software engineer and entrepreneur in the Netherlands. I recently decided to turn an old weatherclock into…","html":"<p>Hi, I’m <a href=\"https://www.douwehomans.com/\">Douwe Homans</a>. I’m a trained medical doctor, software engineer and entrepreneur in the Netherlands. I recently decided to turn an old weatherclock into an IoT project using a Particle Photon and the Serverless Framework. In this post I’ll share how I did it.</p>\n<h2>Background</h2>\n<p>In the 80’s, my grandparents received a homemade weatherclock as a gift from a friend. The device had a clock-like display that indicated the current wind direction near their home. The sensor part was an actual mechanical wind vane that used a magnet and reed switches to determine the wind direction.</p>\n<p>They placed it several meters from their house on a high pole. It was connected with a multicore cable (a core for every wind direction) to the display inside. The display consisted of 8 LEDs mounted in a black acrylic plate. The plate was framed in a circular piece of wood.</p>\n<p align=\"center\">\n  <img width=\"400\" src=\"https://cloud.githubusercontent.com/assets/20538501/22045501/41045826-dce0-11e6-8203-48d5bf6e5c08.jpg\">\n</p>\n<p>After my grandparents moved to an apartment, we never found the space to put up the sensor. The clock hadn’t been working since.</p>\n<h2>Now</h2>\n<p>A lot has changed since then. Now we have the Internet! I thought it would be nice to hook up the clock to the Internet so we could get the current wind direction (and speed) from the web. This would allow me to get rid of the mechanical wind vane, and I could also add wind<em>speed</em> to the display in addition to the direction.</p>\n<p align=\"center\">\n  <img src=\"https://cloud.githubusercontent.com/assets/20538501/22045403/b1c3444c-dcdf-11e6-8876-3c3491d056c1.gif\">\n</p>\n<h2>Getting Started</h2>\n<p>It came down to 2 steps:</p>\n<ol>\n<li>Connect the clock to the Internet</li>\n<li>Get the data to the clock</li>\n</ol>\n<h3>Connect the clock to the Internet</h3>\n<p>I decided to work with a Photon made by <a href=\"https://www.particle.io/\">Particle.io</a>. It’s a microprocessor that automatically connects to the Particle Cloud once set up. The device can be programmed in C.</p>\n<p align=\"center\">\n  <img width=\"400\" src=\"https://cloud.githubusercontent.com/assets/20538501/22045527/70b1499e-dce0-11e6-864d-15f33feb8511.jpg\">\n</p>\n<p>I connected each LED, using a current limiting resistor, to a separate pin of the Photon.</p>\n<p align=\"center\">\n  <img width=\"400\" src=\"https://cloud.githubusercontent.com/assets/20538501/22045561/93b6b99c-dce0-11e6-8084-088a2f2b7d3c.jpg\">\n</p>\n<p>The cool thing about the Photon is that you can program it over the air from your browser. In your code you can define <a href=\"https://docs.particle.io/reference/firmware/photon/#particle-function-\">remote functions</a> which you’ll be able to call over the Internet once the code has been deployed to the device. (<a href=\"https://docs.particle.io/reference/api/#call-a-function\">Particle Documentation</a>).</p>\n<p>I exposed two of those functions: <code class=\"language-text\">setWindSpeed</code> and <code class=\"language-text\">setWindDir</code>. The first one takes the windspeed in Beaufort (a commonly used scale in the Netherlands), the second one the windDirection.</p>\n<p>The code on the Photon simply runs an infinite loop, similar to this:</p>\n<div class=\"gatsby-highlight\" data-language=\"pseudo\"><pre class=\"language-pseudo\"><code class=\"language-pseudo\">if ( THERE_IS_NO_WIFI ) {\n    blink_leds_fast_to_indicate_no_wifi();\n} else if ( I_GOT_NO_WEATHER_UPDATE_FOR_A_LOOOOONG_TIME ) {\n    blink_leds_slow_to_indicate_no_updates();\n} else {\n    // I HAVE INTERNET AND DATA!\n    animate_all_leds_in_circle();\n    turn_on_led_for_corresponding_wind_direction(); // which has been set by externally calling setWindDir\n    animate_all_leds_in_circle();\n    turn_on_number_of_leds_to_indicate_windspeed(); // which has been set by externally calling setWindSpeed\n}</code></pre></div>\n<p>You can see actual code <a href=\"https://github.com/douweh/windclock_photon\">on GitHub</a>.</p>\n<p>The clock is pretty ‘dumb’. It’s not reaching out to the Internet to find, parse, and display data. It just displays the values for the windSpeed and windDir and those values get set by calling <code class=\"language-text\">setWindSpeed</code> and <code class=\"language-text\">setWindDir</code>. This helps to keep the code in the clock really simple and focused on one job.</p>\n<p>Gathering weather data and getting it to the clock is not the concern of the clock itself.</p>\n<div class=\"gatsby-resp-iframe-wrapper\" style=\"padding-bottom: 56.25%; position: relative; height: 0; overflow: hidden; margin-bottom: 1.0725rem\" > <iframe src=\"https://www.youtube.com/embed/CS6aQ6hjeuU\" frameborder=\"0\" allowfullscreen style=\" position: absolute; top: 0; left: 0; width: 100%; height: 100%; \"></iframe> </div>\n<h3>So how do we get the data to the clock?</h3>\n<p>Once the clock is connected to the Particle Cloud you can (with the right credentials) connect to it through the Particle Cloud and call the functions you exposed in the code (<code class=\"language-text\">setWindSpeed</code> and <code class=\"language-text\">setWindDir</code>). I can login to the Particle Cloud, find out the ID of our wind-clock, and just use the <code class=\"language-text\">particle</code> command line tool.</p>\n<p><code class=\"language-text\">$ particle call ID_FROM_OUR_CLOCK setWindDir &quot;NNE&quot;</code></p>\n<p>And that makes my clock’s <code class=\"language-text\">N</code> and <code class=\"language-text\">NE</code> LED’s light up indicating the wind is blowing from North-North-East.</p>\n<p>This shows me that the hardware is working, but of course I want the <em>current</em> wind direction for my favorite spot, pushed automically (and periodically) to the clock.</p>\n<p>So basically I need to run the following steps periodically.</p>\n<ul>\n<li>Get data from the web</li>\n<li>Push data to particle-cloud</li>\n</ul>\n<h3>Serverless</h3>\n<p>When I thought about how I wanted to run the code to update my clock I came to the following conclusion:</p>\n<p>I really don’t care that much where my code runs. As long as I know it <em>does</em> AND I can <em>tune in</em> to see it <em>still does</em> :).</p>\n<p>I could spin up a server myself, I could use an EC2 instance, or Heroku, or a virtual server from a different vendor, or…\nI don’t want to spend time figuring out what is the best option.</p>\n<p>This is where Serverless made sense to me. I just write my code and configure which events triggers my code to run.</p>\n<p>The complete code is <a href=\"https://github.com/douweh/windclock_serverless\">on GitHub</a>. But it boils down to the following:</p>\n<p>A <code class=\"language-text\">handler.js</code> which exposes an <code class=\"language-text\">update</code> function which:</p>\n<ol>\n<li>Gets Weather data (from Dutch Weather Institute)</li>\n<li>Converts M/S to Beaufort</li>\n<li>Connects and pushes data to the Particle Cloud</li>\n</ol>\n<p>A <code class=\"language-text\">serverless.yml</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> windclock\n<span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token key atrule\">runtime</span><span class=\"token punctuation\">:</span> nodejs4.3\n  <span class=\"token key atrule\">region</span><span class=\"token punctuation\">:</span> eu<span class=\"token punctuation\">-</span>central<span class=\"token punctuation\">-</span><span class=\"token number\">1</span>\n\n<span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">update</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.update\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">schedule</span><span class=\"token punctuation\">:</span> rate(15 minutes)</code></pre></div>\n<p>That’s it!\nI can run a <code class=\"language-text\">$ serverless deploy</code> to deploy my code and know that it runs every 15 minutes. If I want to <em>tune in</em> I simply run <code class=\"language-text\">$ serverless logs -f update</code>.</p>\n<p>And just like that I can tell whether it’s time to head out with my kiteboard.</p>","frontmatter":{"title":"A Serverless Weatherclock To Monitor My Favorite Kiteboarding Spot At The Lake","date":"January 17, 2017","description":"This post illustrates how I use Serverless to update a `windclock` that shows me the wind speed and direction at my favorite kiteboarding spot."}}},"pageContext":{"slug":"/posts/2017-01-17-a-serverless-windclock-at-the-lake/","previous":{"fields":{"slug":"/posts/2017-01-12-serverless-cloud-academy-webinar/"},"frontmatter":{"title":"Talking Serverless Framework Features & How To Use Them in a Webinar with Cloud Academy"}},"next":{"fields":{"slug":"/posts/2017-01-30-serverless-v1.6.0/"},"frontmatter":{"title":"Introducing OpenWhisk support, Python for invoke local in Serverless Framework v1.6"}}}}}