{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/2017-09-12-event-driven-serverless-app-local-dev-exp/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"bdd66ef3-8291-5353-9923-12a38da40296","excerpt":"In my previous post on Anatomy of a Serverless Application, I lay the foundation for building a very simple application with an email service using the…","html":"<p>In my previous post on <a href=\"https://serverless.com/blog/anatomy-of-a-serverless-app/\">Anatomy of a Serverless Application</a>, I lay the foundation for building a very simple application with an email service using the Serverless Framework, deployed to AWS Lambda. </p>\n<p>In this post, we will build <code class=\"language-text\">mailman</code>, an event-driven serverless application. The application has a simple frontend using <code class=\"language-text\">curl</code> that calls into a couple of backend services: a users service and an email service. The post will highlight event-driven application development with focus on full local development experience. We will look at services emitting, subscribing and reacting to events in a seamless manner using the Serverless Application Platform.</p>\n<p>You will learn how to:</p>\n<ul>\n<li>Setup the development environment</li>\n<li>Create an application project</li>\n<li>Create a users service</li>\n<li>Create an email service</li>\n<li>Write an event-driven application</li>\n<li>Run the serverless services locally</li>\n<li>Run the full application locally</li>\n</ul>\n<h2>Getting Started</h2>\n<p>We will look at an important aspect of writing serverless applications, i.e. local development support. We touched upon the fact that <a href=\"https://serverless.com/framework/\">Serverless Framework</a> helps with local testing of a serverless service by using <code class=\"language-text\">sls invoke</code>. But, the real productivity gain is the ability to write a serverless, event-driven application with full local development support, with provider emulation and running it without the need to deploy it to a cloud provider.</p>\n<p>My choices:</p>\n<ul>\n<li><strong>Programming language</strong>: <a href=\"https://nodejs.org/en/\">NodeJS</a></li>\n<li>\n<p><strong>The Serverless Application Platform</strong>: It consists of</p>\n<ul>\n<li><a href=\"https://serverless.com/framework/\">Serverless Framework</a> (<strong>v1.20.0 or higher</strong>)</li>\n<li><a href=\"https://serverless.com/event-gateway/\">Serverless Event Gateway</a>, the central hub of event communication</li>\n<li><a href=\"https://github.com/serverless/emulator\">Serverless Emulator</a>, the local serverless provider emulator</li>\n<li><a href=\"https://github.com/serverless/fdk\">Serverless Functions Development Kit (FDK)</a>, to enhance developer experience for writing severless applications </li>\n</ul>\n</li>\n</ul>\n<h2>Setup</h2>\n<p>Let’s install and setup the toolsets required for development.</p>\n<ol>\n<li>Install NodeJS (<strong>v6.10.3</strong>): <a href=\"https://nodejs.org/en/download/\">download</a> or <a href=\"https://nodejs.org/en/download/package-manager/#osx\">using package manager</a></li>\n<li>Install the Serverless Framework (<strong>v1.20.0 or higher</strong>): <code class=\"language-text\">npm install -g serverless</code></li>\n<li><strong>No need</strong> for setting up any cloud provider account. YEAH! </li>\n</ol>\n<blockquote>\n<p>Without the step (read hurdle) of setting up a cloud provider account you have already saved so much time and hassle.</p>\n</blockquote>\n<p><strong>Note</strong>: You might wonder what happened to the <strong>Event Gateway</strong> and the <strong>Emulator</strong> setup. That’s where the Serverless Framework makes it all come together. Keep reading.</p>\n<p>With Serverless Framework already installed, we will see how to use the Event Gateway and the Emulator in order to provide a centralized event hub and a much needed local development environment. The newly added <code class=\"language-text\">serverless run</code> command downloads and runs the necessary components. </p>\n<p>Before we use the <code class=\"language-text\">serverless run</code> command, we need to first login to the Serverless Application Platform using the <code class=\"language-text\">serverless login</code> command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ sls login\n\nServerless: The Serverless login will <span class=\"token function\">open</span> <span class=\"token keyword\">in</span> your default browser<span class=\"token punctuation\">..</span>.\nServerless: Opening browser<span class=\"token punctuation\">..</span>.\nPlease enter the verification code here: xxxxxxxxxxxxx\nServerless: You are now logged <span class=\"token keyword\">in</span></code></pre></div>\n<h2>Event-driven Serverless Application</h2>\n<p>Let’s look at three core capabilities that we need to write, test and run a serverless event-driven application: an event-driven workflow, programmatic access, and full local development experience.</p>\n<h3>Event-driven Workflow</h3>\n<p>The tenet of an event-driven application is that the components interact with each other asynchronously via events. The components are not aware of each other and rely on a central event communication hub for relaying events across the application.  </p>\n<p>The Event Gateway serves as the central event communication fabric for serverless applications. It acts as the broker for all event communication and allows services to publish and subscribe to events. Additionally, it acts as an API Gateway for all HTTP communication. </p>\n<p>The Event Gateway uses a special <code class=\"language-text\">http</code> event-type to recognize standard HTTP requests. It standardizes both pub/sub and HTTP communication to be represented as events, combining them into a single experience. Services can send custom events and the Event Gateway wraps them up in a standard event envelope passing the payload along as-is. Events from well-known SaaS providers will be recognized as first-class event-types in the near future. <strong>“Everything as events” is the mantra.</strong></p>\n<blockquote>\n<p>Read <a href=\"https://serverless.com/blog/introducing-serverless-event-gateway\">Event Gateway - The Missing Piece of Serverless Architectures</a> for more details.</p>\n</blockquote>\n<h3>Programmatic Access</h3>\n<p>To write event-driven serverless applications, its individual services need to programmatically take advantage of all the goodness of the Event Gateway features. The Serverless SDK hands that capability to the developers. The developers have access to the Event Gateway API via code for registering &#x26; invoking functions, subscribing to and emitting events, and configuration.</p>\n<blockquote>\n<p>Checkout the <a href=\"https://github.com/serverless/fdk\">SDK source</a> for more details.</p>\n</blockquote>\n<h3>Local Development Support</h3>\n<p>One of the biggest challenges with developing serverless applications is to run and test the application locally. Since serverless applications are hosted on the cloud, it makes it very tedious to debug, test and develop code in an iterative manner. Although all cloud providers and the Serverless Framework allows invoking one function at a time locally, the developer wishes to run the full application locally on their machine.</p>\n<p>The Serverless Emulator emulates different cloud provider FaaS offerings (currently AWS Lambda or Google Cloud Functions) on your local machine in an offline-focused manner. It provides that missing piece of tooling that makes application development with serverless so productive and exciting. It enables deploying and invoking serverless functions without the requirement of setting up and deploying your serverless application to the cloud provider.</p>\n<blockquote>\n<p>Check out the <a href=\"https://github.com/serverless/emulator\">Emulator source</a> for more details. </p>\n</blockquote>\n<h3>Seamless Developer Experience</h3>\n<p>To empower the developer with a great development experience, the Serverless Framework brings it all together in a very simple and intuitive interface: the <code class=\"language-text\">serverless run</code> command.</p>\n<p>The <code class=\"language-text\">serverless run</code> command detects and installs or spins up the latest version of the Event Gateway and the Emulator. It provides a unified visual interface for the event-driven workflow for the application as they happen. It provides an intuitive and decoupled interface for the services of an application to communicate with.</p>\n<p>In the sections that follow, we will use the example application to demonstrate these killer features.</p>\n<h2>Creating the Application</h2>\n<p>A basic project structure shown below will work:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">|</span>-- mailman\n  <span class=\"token operator\">|</span>-- README.md\n  <span class=\"token operator\">|</span>-- frontend\n  `-- services</code></pre></div>\n<p>where,</p>\n<ul>\n<li><code class=\"language-text\">frontend</code> folder holds the frontend</li>\n<li><code class=\"language-text\">services</code> folder holds the serverless service(s)</li>\n</ul>\n<blockquote>\n<p>With <code class=\"language-text\">sls invoke</code> you could test one single function at a time. But with the Serverless Application Platform, you can run the full event-driven serverless application, with events interacting across the application, locally on your machine, without signup up for any cloud provider. YEAH!</p>\n</blockquote>\n<p>Let’s create a couple of the backend services and then we will explore the local experience when we run the application. The way the non-serverless frontend portion of the application is written is totally your choice. In this post, I will primarily focus on the serverless portion of the application inside the <code class=\"language-text\">services</code> folder, and use a basic <code class=\"language-text\">curl</code> script to simulate the frontend.</p>\n<h3>Goals</h3>\n<p>The application has a few business goals:</p>\n<ul>\n<li>register a user via an HTTP POST API call from the frontend</li>\n<li>on registration, send a welcome email to the user</li>\n</ul>\n<p>The application has a few technical goals as well:</p>\n<ul>\n<li>run and test the application locally without deploying to the cloud</li>\n<li>have loosely-coupled services interact with the application</li>\n<li>visualize the event-driven workflow as it happens</li>\n</ul>\n<h2>Building the Services</h2>\n<p>We will not get into the details of creating the services, but we will explore the code and dig deep into the functionality that is offered. Also, the guts of the services are mocked up, but the intention of the example is to showcase the event-driven nature of the services, so we will just focus on that.</p>\n<h3>Building the Users Service</h3>\n<p>The workflow of the <code class=\"language-text\">users</code> service is:</p>\n<ul>\n<li>expose an HTTP endpoint for user registration,</li>\n<li>register a user, and finally</li>\n<li><strong>emit</strong> an event <code class=\"language-text\">user.registered</code></li>\n</ul>\n<p>Let’s look at the functions section of the <code class=\"language-text\">serverless.yml</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># users-api crud service</span>\n\n<span class=\"token punctuation\">...</span>\n<span class=\"token punctuation\">...</span>\n<span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">register</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.register\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /users\n          <span class=\"token key atrule\">method</span><span class=\"token punctuation\">:</span> POST\n<span class=\"token punctuation\">...</span>\n<span class=\"token punctuation\">...</span>          </code></pre></div>\n<p>Nothing different than what you are used to. </p>\n<blockquote>\n<p>The important aspect to note is that the Serverless Application Platform with all its new products and enhancements is still compatible with existing serverless applications that you have built. </p>\n</blockquote>\n<p><strong>Behind the scenes</strong></p>\n<p>Actually, there are a couple of things that the Serverless Application Platform does behind the scenes. The <code class=\"language-text\">serverless.yml</code> is parsed, and the <code class=\"language-text\">register</code> function from the <code class=\"language-text\">users</code> service is registered with the Event Gateway. Next, a subscription is created for the <code class=\"language-text\">http</code> event and the <code class=\"language-text\">register</code> function.</p>\n<p>We will visualize this when we run the service and talk about it in the next section.</p>\n<p>Now, let’s look at the handler code:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token string\">'use strict'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> fdk <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@serverless/fdk'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> users <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./lib/users.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// set event gateway urls</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">EVENT_GATEWAY_URL</span> <span class=\"token operator\">=</span> <span class=\"token string\">'http://localhost:4000'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">EVENT_GATEWAY_CONFIG_URL</span> <span class=\"token operator\">=</span> <span class=\"token string\">'http://localhost:4001'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// initialize event gateway</span>\n<span class=\"token keyword\">const</span> eventGateway <span class=\"token operator\">=</span> fdk<span class=\"token punctuation\">.</span><span class=\"token function\">eventGateway</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  url<span class=\"token operator\">:</span> <span class=\"token constant\">EVENT_GATEWAY_URL</span><span class=\"token punctuation\">,</span>\n  configurationUrl<span class=\"token operator\">:</span> <span class=\"token constant\">EVENT_GATEWAY_CONFIG_URL</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>In this portion of the code, we use the Serverless FDK to initialize the Event Gateway.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// register function</span>\nmodule<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">register</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token comment\">// Validation</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>event<span class=\"token punctuation\">.</span>data <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>event<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>body <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>event<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      statusCode<span class=\"token operator\">:</span> <span class=\"token number\">400</span><span class=\"token punctuation\">,</span>\n      body<span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>message<span class=\"token operator\">:</span> <span class=\"token string\">'Email is required'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// Register user</span>\n  users<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    email<span class=\"token operator\">:</span> event<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">,</span>\n    name<span class=\"token operator\">:</span> event<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>name\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">// Emit event</span>\n    eventGateway\n      <span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        event<span class=\"token operator\">:</span> <span class=\"token string\">'user.registered'</span><span class=\"token punctuation\">,</span>\n        data<span class=\"token operator\">:</span> data\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> error<span class=\"token operator\">:</span> err <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>This portion shows the <code class=\"language-text\">register</code> function, that first checks if an email was passed in the event body, and then registers the user. Next, on successful registration of the user, it <strong>emits</strong> an event <code class=\"language-text\">user.registered</code> using the FDK, passing in the user data.</p>\n<h3>Building the Email Service</h3>\n<p>The workflow of the <code class=\"language-text\">email</code> service is:</p>\n<ul>\n<li>send a welcome email to the registered user, and</li>\n<li><strong>emit</strong> an event <code class=\"language-text\">email.sent</code></li>\n</ul>\n<p>Let’s look at the functions section of the <code class=\"language-text\">serverless.yml</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">...</span>\n<span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">sendWelcomeEmail</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> handler.sendWelcomeEmail\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> user.registered</code></pre></div>\n<p><strong>Behind the scenes</strong></p>\n<p>There are a couple of things that the Serverless Application Platform does behind the scenes. The <code class=\"language-text\">serverless.yml</code> is parsed, and the <code class=\"language-text\">sendWelcomeEmail</code> function from the <code class=\"language-text\">email</code> service is registered with the Event Gateway. Next, a subscription is created for the <code class=\"language-text\">user.registered</code> event and the <code class=\"language-text\">sendWelcomeEmail</code> function.</p>\n<p>We will visualize this when we run the service and talk about it in the next section.</p>\n<p>Now, let’s look at the handler code, specifically the <code class=\"language-text\">sendWelcomeEmail</code> function:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token operator\">...</span>\n<span class=\"token operator\">...</span>\nmodule<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">sendWelcomeEmail</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token comment\">// TODO: Send email here...</span>\n\n  <span class=\"token comment\">// Emit event 'email.sent'</span>\n  eventGateway\n    <span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      event<span class=\"token operator\">:</span> <span class=\"token string\">'email.sent'</span><span class=\"token punctuation\">,</span>\n      data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"id\"</span><span class=\"token operator\">:</span> event<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"name\"</span><span class=\"token operator\">:</span> event<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"email\"</span><span class=\"token operator\">:</span> event<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>email\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n        statusCode<span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n        body<span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>message<span class=\"token operator\">:</span> <span class=\"token string\">'Email sent.'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> error<span class=\"token operator\">:</span> err <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>This portion shows the <code class=\"language-text\">sendWelcomeEmail</code> function, that would send out a welcome email to the user that is passed in via the event data. Next, it <strong>emits</strong> an event <code class=\"language-text\">email.sent</code> using the FDK, passing in the event data.</p>\n<h2>Running the Application</h2>\n<p>Now that we understand what the application is meant to do, and having looked at the code, let’s run the application. Everything will run locally on our machine. We will <a href=\"https://github.com/serverless/serverless/pull/4034\">run</a> one service at a time, <a href=\"https://github.com/serverless/serverless/pull/4038\">emit</a> and respond to events, visualize the workflow and then call the services via <code class=\"language-text\">curl</code> simulating an application user interface.</p>\n<blockquote>\n<p>Two new awesome commands: <code class=\"language-text\">serverless run</code> and <code class=\"language-text\">serverless emit</code> implemented as core plugins to the Serverless Framework were <a href=\"https://github.com/serverless/serverless/blob/master/CHANGELOG.md#1200-16082017\">released</a> recently.</p>\n</blockquote>\n<h3>The Local Development Experience</h3>\n<p>The first time you <strong>run</strong> any service using <code class=\"language-text\">serverless run</code>, you will get a slightly different experience. Let’s run the users service, and look at the visualization on the terminal:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"> $ <span class=\"token builtin class-name\">cd</span> mailman/services/users\n $ sls run\n Serverless     Installing Event Gateway\n Serverless     Emulator initializing<span class=\"token punctuation\">..</span>.\n Serverless     Emulator listening on: http://localhost:4002\n <span class=\"token punctuation\">..</span>.\n Serverless     Event Gateway initializing<span class=\"token punctuation\">..</span>.\n Event Gateway  Event API listening on: http://localhost:4000\n Event Gateway  Config API listening on: http://localhost:4001\n Serverless     Event Gateway initialized\n <span class=\"token punctuation\">..</span>.</code></pre></div>\n<p>The required components of the Serverless Application Platform, namely the Event Gateway and the Emulator, are downloaded and installed locally on your machine unless already installed. Also, note that the individual components advertise their API endpoints. Then, these components stay in the background listening for events and ready for action.</p>\n<p>I want to point out that this is how the <strong>local development experience</strong> starts for a developer. It is all inclusive, seamless and is just there for you.</p>\n<h3>Running the Users Service</h3>\n<p>With the local development setup done, we are ready to run our <code class=\"language-text\">users</code> service.</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/blog_app_sls_run_users.gif\"></p>\n<p>There are a couple of things that are happening here:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"> Serverless     Function <span class=\"token string\">'users-register'</span> loaded\n Event Gateway  Function <span class=\"token string\">'users-register'</span> registered\n Event Gateway  Subscription created <span class=\"token keyword\">for</span> event <span class=\"token string\">'http'</span> and <span class=\"token keyword\">function</span> <span class=\"token string\">'users-register'</span></code></pre></div>\n<p>Here the Serverless Framework detects the <code class=\"language-text\">register</code> function in the <code class=\"language-text\">users</code> service and deploys it to the local Emulator.</p>\n<p>Then the <code class=\"language-text\">register</code> function from the <code class=\"language-text\">users</code> service is registered with the Event Gateway. And, a subscription is created for the <code class=\"language-text\">http</code> event and the <code class=\"language-text\">register</code> function.</p>\n<h3>Running the Email Service</h3>\n<p>Let’s run the <code class=\"language-text\">email</code> service now.</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/blog_app_sls_run_email.gif\"></p>\n<p>There are a couple of things that are happening here:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"> Serverless     Function <span class=\"token string\">'email-service-sendWelcomeEmail'</span> loaded\n Event Gateway  Function <span class=\"token string\">'email-service-sendWelcomeEmail'</span> registered\n Event Gateway  Subscription created <span class=\"token keyword\">for</span> event <span class=\"token string\">'user.registered'</span> and <span class=\"token keyword\">function</span> <span class=\"token string\">'email-service-sendWelcomeEmail'</span></code></pre></div>\n<p>Here the Serverless Framework detects the <code class=\"language-text\">sendWelcomeEmail</code> function in the <code class=\"language-text\">email</code> service and deploys it to the local Emulator.</p>\n<p>Then the <code class=\"language-text\">sendWelcomeEmail</code> function from the <code class=\"language-text\">email</code> service is registered with the Event Gateway. Further, a subscription is created for the <code class=\"language-text\">user.registered</code> event and the <code class=\"language-text\">sendWelcomeEmail</code> function.</p>\n<h3>Calling the Services</h3>\n<p>To simulate an application user interface, we will use <code class=\"language-text\">curl</code> to call the user service API for registering a user. We have the current <code class=\"language-text\">serverless run</code> session running on one pane and we will run the frontend curl commands in another pane.</p>\n<p>Run the following <code class=\"language-text\">curl</code> command on the other pane:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token builtin class-name\">cd</span> mailman/frontend \n$ <span class=\"token function\">curl</span> -X POST <span class=\"token punctuation\">\\</span>\n  http://localhost:4000/users <span class=\"token punctuation\">\\</span>\n  -H <span class=\"token string\">'content-type: application/json'</span> <span class=\"token punctuation\">\\</span>\n  -d <span class=\"token string\">'{\"name\":\"Rupak Ganguly\", \"email\":\"yourname@mail.com\"}'</span>\n\n<span class=\"token punctuation\">{</span><span class=\"token string\">\"id\"</span>:26,<span class=\"token string\">\"session\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"e40e0d06ed05f17385dee72a56cfda48\"</span>,<span class=\"token string\">\"email\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"yourname@mail.com\"</span>,<span class=\"token string\">\"name\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"Rupak Ganguly\"</span><span class=\"token punctuation\">}</span>%</code></pre></div>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/blog_app_sls_run_curl.gif\"></p>\n<p>Let’s break it up and discuss what just happened.</p>\n<ol>\n<li>\n<p>Event Gateway receives the <code class=\"language-text\">http</code> event <code class=\"language-text\">POST http://localhost:4000/users</code></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"> Event Gateway  Event <span class=\"token string\">'http'</span> received:\n\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"event\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"http\"</span>,\n    <span class=\"token string\">\"id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"825e723f-dc75-4368-bd43-abf26b28d46d\"</span>,\n    <span class=\"token string\">\"receivedAt\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">1505103914033</span>,\n    <span class=\"token string\">\"data\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"headers\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"Accept\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n          <span class=\"token string\">\"*/*\"</span>\n        <span class=\"token punctuation\">]</span>,\n        <span class=\"token string\">\"Content-Length\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n          <span class=\"token string\">\"52\"</span>\n        <span class=\"token punctuation\">]</span>,\n        <span class=\"token string\">\"Content-Type\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n          <span class=\"token string\">\"application/json\"</span>\n        <span class=\"token punctuation\">]</span>,\n        <span class=\"token string\">\"User-Agent\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n          <span class=\"token string\">\"curl/7.54.0\"</span>\n        <span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span>,\n      <span class=\"token string\">\"query\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>,\n      <span class=\"token string\">\"body\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"email\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"yourname@mail.com\"</span>,\n        <span class=\"token string\">\"name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Rupak Ganguly\"</span>\n      <span class=\"token punctuation\">}</span>,\n      <span class=\"token string\">\"path\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"/users\"</span>,\n      <span class=\"token string\">\"method\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"POST\"</span>\n    <span class=\"token punctuation\">}</span>,\n    <span class=\"token string\">\"dataType\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"application/json\"</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n<li>\n<p>The <code class=\"language-text\">http</code> event triggered the <code class=\"language-text\">register</code> function from the <code class=\"language-text\">users</code> service. The <code class=\"language-text\">register</code> function emitted an <code class=\"language-text\">user.registered</code> event, which was received by the Event Gateway. You can see the data payload for the event as well.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"> Serverless     Function <span class=\"token string\">'users-register'</span> triggered by event <span class=\"token string\">'http'</span>\n\n Event Gateway  Event <span class=\"token string\">'user.registered'</span> received:\n\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"event\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"user.registered\"</span>,\n    <span class=\"token string\">\"id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"77071ceb-459e-4eb6-a8ba-813a75d39567\"</span>,\n    <span class=\"token string\">\"receivedAt\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">1505103914805</span>,\n    <span class=\"token string\">\"data\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"email\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"yourname@mail.com\"</span>,\n      <span class=\"token string\">\"id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">79</span>,\n      <span class=\"token string\">\"name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Rupak Ganguly\"</span>,\n      <span class=\"token string\">\"session\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"e40e0d06ed05f17385dee72a56cfda48\"</span>\n    <span class=\"token punctuation\">}</span>,\n    <span class=\"token string\">\"dataType\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"application/json\"</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n<li>\n<p>The <code class=\"language-text\">user.registered</code> event triggered the <code class=\"language-text\">sendWelcomeEmail</code> function from the <code class=\"language-text\">email</code> service. Then, the <code class=\"language-text\">register</code> function which had started async in Step 2, finishes.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"> Serverless     Function <span class=\"token string\">'email-service-sendWelcomeEmail'</span> triggered by event <span class=\"token string\">'user.registered'</span>\n\n Serverless     Function <span class=\"token string\">'users-register'</span> finished:\n\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">79</span>,\n    <span class=\"token string\">\"session\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"e40e0d06ed05f17385dee72a56cfda48\"</span>,\n    <span class=\"token string\">\"email\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"yourname@mail.com\"</span>,\n    <span class=\"token string\">\"name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Rupak Ganguly\"</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n<li>\n<p>Then the <code class=\"language-text\">email.sent</code> event emitted by <code class=\"language-text\">sendWelcomeEmail</code> function is received by the Event Gateway. Then, the <code class=\"language-text\">sendWelcomeEmail</code> function which had started async in Step 3, finishes.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"> Event Gateway  Event <span class=\"token string\">'email.sent'</span> received:\n\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"event\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"email.sent\"</span>,\n    <span class=\"token string\">\"id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"227979c0-667e-4b0f-a9e8-dae8d750fa85\"</span>,\n    <span class=\"token string\">\"receivedAt\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">1505103915082</span>,\n    <span class=\"token string\">\"data\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"email\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"yourname@mail.com\"</span>,\n      <span class=\"token string\">\"id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">79</span>,\n      <span class=\"token string\">\"name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Rupak Ganguly\"</span>\n    <span class=\"token punctuation\">}</span>,\n    <span class=\"token string\">\"dataType\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"application/json\"</span>\n  <span class=\"token punctuation\">}</span>\n\n Serverless     Function <span class=\"token string\">'email-service-sendWelcomeEmail'</span> finished:\n\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"statusCode\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">200</span>,\n    <span class=\"token string\">\"body\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"{<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>message<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>Email sent.<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>}\"</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ol>\n<p>That concludes the discussion about the application. </p>\n<p>Hopefully, you followed the workflow I laid out and can see how easy it is to write an event-driven serverless application that can be tested and run locally.</p>\n<p>The terminal visualization during development is crucial to debugging and tracing async event-driven applications, and can greatly help speed up application development cycles. </p>\n<blockquote>\n<p>Code: Get the <a href=\"https://github.com/rupakg/mailman\">full source code</a> to the <code class=\"language-text\">mailman</code> application project on Github.</p>\n</blockquote>\n<h2>Summary</h2>\n<p>The serverless event-driven application that we created was limited to a couple of services to keep it simple and easy to follow. We have a <a href=\"https://github.com/serverless/event-gateway-example\">reference example application</a> that showcases many other event-driven use cases utilizing a variety of services, spanning multiple cloud providers.</p>","frontmatter":{"title":"Writing an Event-driven Serverless Application with Full Local Development Experience","date":"September 12, 2017","description":"Learn how to write an event-driven serverless application with full local development experience using the Serverless Application Platform."}}},"pageContext":{"slug":"/posts/2017-09-12-event-driven-serverless-app-local-dev-exp/","previous":{"fields":{"slug":"/posts/2017-09-11-serverless-api-gateway-domain/"},"frontmatter":{"title":"How to set up a custom domain name for Lambda & API Gateway with Serverless"}},"next":{"fields":{"slug":"/posts/2017-09-14-serverless-v1.22.0/"},"frontmatter":{"title":"Serverless v1.22 - CLI-based plugin discovery, encrypted variables support and new provider SpotInst"}}}}}