{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/2019-08-21-deploy-serverless-cdn-with-serverless-components/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"0d8cdbb8-1941-50da-8c89-e4ea59406468","excerpt":"Update: This post is based on the beta version of Serverless Components, which is not compatible with the latest, and much faster, GA version. Please check out…","html":"<blockquote>\n<p><strong>Update:</strong> This post is based on the beta version of Serverless Components, which is not compatible with the latest, and much faster, GA version. Please check out the <a href=\"https://github.com/serverless/components\">latest docs</a> for more up to date information.</p>\n</blockquote>\n<p>Two weeks ago we released a complete solution for deploying serverless websites that supports custom domain, SSL &#x26; CDN in a single <a href=\"https://github.com/serverless-components/website\">website component</a>. Since then we’ve received great feedback about related use cases of the underlying infrastructure and we realized there is a need for a standalone content delivery network solution to serve your static assets, even if they’re not directly related to your website.</p>\n<p>Today we’re releasing the zero-config <a href=\"https://github.com/serverless-components/cdn\">Serverless CDN component</a> to serve that exact use case. Just like the <a href=\"https://github.com/serverless-components/website\">website component</a>, it supports secure SSL-enabled custom domains and is powered by AWS S3, <a href=\"https://www.serverless.com/amazon-cloudfront/\">AWS CloudFront</a>, AWS Route53 &#x26; AWS Certificate Manager. All can be deployed with <strong>only 2 lines of YAML</strong>.</p>\n<h4>Deploying the Serverless CDN Component</h4>\n<p>To deploy the <a href=\"https://github.com/serverless-components/cdn\">Serverless CDN component</a>, you’ll need to first install the latest version of the Serverless Framework if you haven’t done that already.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm i -g serverless</code></pre></div>\n<p>Once installed, make sure you have set your AWS keys in your machine. For more info regarding setting AWS keys, <a href=\"https://github.com/serverless/components#credentials\">checkout this guide</a>.</p>\n<p>Once you’re done with that, you’ll have over <a href=\"https://github.com/serverless-components\">30 serverless components</a> that you can instantly deploy with a single YAML file. In this article, we will focus on the <a href=\"https://github.com/serverless-components/cdn\">Serverless CDN component</a>. To deploy the <a href=\"https://github.com/serverless-components/cdn\">Serverless CDN component</a>, just create a <code class=\"language-text\">serverless.yml</code> template file in the current working directory. This YAML template file should have the following content:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">myServerlessCDN</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">component</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"@serverless/cdn\"</span></code></pre></div>\n<p>That’s literally all the YAML you need to deploy a complete serverless content delivery network. All you need to do now is just run the <code class=\"language-text\">serverless</code> command in the current working directory:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">myApp (master)$ serverless\n\n  myServerlessCDN:\n    bucketName: 9c7hh2-f1swq5c\n    region:     us-east-1\n    url:        https://d29sqymsceo6j1.cloudfront.net\n\n  18s › myServerlessCDN › done\n\nmyApp (master)$</code></pre></div>\n<p>There you have it! Your Serverless CDN has been deployed. It may take a few minutes for AWS CloudFront to propagate across edge locations and be completely ready. While this is happening, you can upload your first file to your CDN. Just visit the AWS S3 console, find the bucket that is shown in the CLI outputs (in this case it’s <code class=\"language-text\">9c7hh2-f1swq5c</code>) and upload your first file to it. You may of course do that programatically from your application. Also keep in mind that visiting the root URL shown in the CLI will likely show an error because you don’t have any content in your CDN.</p>\n<p>After you upload your first file, you can request &#x26; view this file via your CDN by prefixing the root URL you see in the CLI. In this case that would be:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">https://d29sqymsceo6j1.cloudfront.net/my-first-image.png</code></pre></div>\n<h4>Adding a Custom Domain to Your Serverless CDN</h4>\n<p>Just like the <a href=\"https://github.com/serverless-components/website\">website component</a>, you can add your own custom domain to your content delivery network with a single input.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">myServerlessCDN</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">component</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"@serverless/cdn\"</span>\n  <span class=\"token key atrule\">inputs</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">domain</span><span class=\"token punctuation\">:</span> cdn.example.com</code></pre></div>\n<p>Please note that your domain (<code class=\"language-text\">example.com</code> in this example) must have been purchased via AWS Route53 and available in your AWS account. For advanced users, you may also purchase it elsewhere, then configure the name servers to point to an AWS Route53 hosted zone. How you do that depends on your registrar.</p>\n<p>To deploy your custom domain, just run <code class=\"language-text\">serverless</code> again:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">myApp (master)$ serverless\n\n  myServerlessCDN:\n    bucketName: 9c7hh2-f13wq5c\n    region:     us-east-1\n    url:        https://d29sqymsceo6j1.cloudfront.net\n    domain:     https://cdn.example.com\n\n  14s › myServerlessCDN › done\n\nmyApp (master)$</code></pre></div>\n<p>You’ll now notice there’s a new <code class=\"language-text\">domain</code> output in the CLI and that it’s already SSL-enabled and completely secure by default, as the <a href=\"https://github.com/serverless-components/cdn\">Serverless CDN component</a> creates a free certificate for you automatically via AWS Certificate Manager. If this is the first time you use your domain with AWS, deployment may take a while during certificate creation and validation.</p>\n<p>You may now use this domain instead of the root CloudFront URL we used earlier to access our file. Again, keep in mind that domain propagation may take a few minutes:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">https://cdn.example.com/my-first-image.png</code></pre></div>\n<h4>Composing Your Serverless CDN with Other Components</h4>\n<p>As mentioned before, the Serverless CDN is just one of <a href=\"https://github.com/serverless-components\">30+ components we already have available for you</a>. You will likely need to use this serverless content delivery network with other components of your application (for example the <a href=\"https://github.com/serverless-components/backend\">backend component</a>) to be able to dynamically upload files from your backend to the bucket that was created for you. For a full stack application, your YAML file may look something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">website</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">component</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"@serverless/website\"</span>\n  <span class=\"token key atrule\">inputs</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">code</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">src</span><span class=\"token punctuation\">:</span> ../website\n    <span class=\"token key atrule\">domain</span><span class=\"token punctuation\">:</span> www.example.com\n\n<span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">component</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"@serverless/backend\"</span>\n  <span class=\"token key atrule\">inputs</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">code</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">src</span><span class=\"token punctuation\">:</span> ../backend\n    <span class=\"token key atrule\">domain</span><span class=\"token punctuation\">:</span> api.example.com\n    <span class=\"token comment\"># dynamically passing the bucket name output to the backend as an environment variable</span>\n    <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">CDN_BUCKET</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>cdn.bucketName<span class=\"token punctuation\">}</span>\n\n<span class=\"token key atrule\">cdn</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">component</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"@serverless/cdn\"</span>\n  <span class=\"token key atrule\">inputs</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">domain</span><span class=\"token punctuation\">:</span> cdn.example.com</code></pre></div>\n<p>Checkout the docs for the <a href=\"https://github.com/serverless-components/backend\">backend component</a> and the <a href=\"https://github.com/serverless-components/website\">website component</a> for more information.</p>\n<h4>Using the Serverless CDN Component in Your Own Custom Component</h4>\n<p>If you’re building <a href=\"https://github.com/serverless/components#building-components\">your own custom component</a>, we’ve also created a custom <code class=\"language-text\">upload</code> function that you can use to directly upload files to your bucket, without even knowing the bucket name. Here’s an example on how this might look like:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// serverless.js</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> Component <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"@serverless/core\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">myCustomComponent</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Componetn</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">async</span> <span class=\"token keyword\">default</span><span class=\"token punctuation\">(</span>inputs <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...your custom component default logic here</span>\n\n    <span class=\"token comment\">// load the @serverless/cdn component</span>\n    <span class=\"token comment\">// must be in your package.json file</span>\n    <span class=\"token keyword\">const</span> myCdn <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"@serverless/cdn\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"myCdn\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// deploy your serverles CDN</span>\n    <span class=\"token keyword\">const</span> myCdnOutputs <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">myCdn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> domain<span class=\"token operator\">:</span> <span class=\"token string\">\"cdn.example.com \"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// upload a single file to your CDN</span>\n    <span class=\"token keyword\">await</span> myCdn<span class=\"token punctuation\">.</span><span class=\"token function\">upload</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> file<span class=\"token operator\">:</span> <span class=\"token string\">\"./assets/my-image.png\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// or upload an entire directory like a boss!</span>\n    <span class=\"token keyword\">await</span> myCdn<span class=\"token punctuation\">.</span><span class=\"token function\">upload</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> dir<span class=\"token operator\">:</span> <span class=\"token string\">\"./assets\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> myCustomComponent<span class=\"token punctuation\">;</span></code></pre></div>\n<p>Needless to say, you must deploy your <a href=\"https://github.com/serverless-components/cdn\">Serverless CDN component</a> before you’re able to use the <code class=\"language-text\">upload</code> function as it stores the required CDN data in the state.</p>\n<h4>Wrapping up</h4>\n<p>In this article, we’ve seen how you can deploy a zero-config Serverless CDN, and adding your own custom domain to it using the <a href=\"https://github.com/serverless-components/cdn\">Serverless CDN component</a>. We’ve also seen how you could use this CDN component in your existing application by composing it with other <a href=\"https://github.com/serverless-components\">serverless components</a>, and finally, we demonstrated how you could use this <a href=\"https://github.com/serverless-components/cdn\">Serverless CDN component</a> as a child component in <a href=\"https://github.com/serverless/components#building-components\">your own custom component</a> and how you could utilize the custom <code class=\"language-text\">upload</code> function we’re exposing to <a href=\"https://github.com/serverless/components#building-components\">your custom component</a> to easily upload files and directories to your new serverless content delivery network.</p>\n<p>We hope you will find this <a href=\"https://github.com/serverless-components/cdn\">Serverless CDN component</a> useful for your application, and we can’t wait to see what you’ll do with it. If you have any questions, feedback or showoffs (we love those!), <a href=\"https://twitter.com/eahefnawy\">feel free to contact me directly on Twitter</a>.</p>\n<p>Go Serverless!</p>","frontmatter":{"title":"Easily Deploy A Serverless CDN With Serverless Components","date":"August 21, 2019","description":"How to easily deploy a serverless content delivery network (CDN) using Serverless Components."}}},"pageContext":{"slug":"/posts/2019-08-21-deploy-serverless-cdn-with-serverless-components/","previous":{"fields":{"slug":"/posts/2019-08-20-zero-instrumentation-observability-aws-lambda-functions/"},"frontmatter":{"title":"Zero instrumentation observability for AWS Lambda"}},"next":{"fields":{"slug":"/posts/2019-08-27-setup-monitoring-for-existing-serverless-projects-in-2min/"},"frontmatter":{"title":"Setup monitoring for existing Serverless projects in 2 minutes"}}}}}