{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/2017-11-14-abcs-of-iam-permissions/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"47bb2ed0-05ae-5f44-bc79-ad8c61b80fff","excerpt":"When getting started with Serverless, one of the hardest things to grok is IAM—AWS Identity and Access Management. IAM is how you manage access to resources in…","html":"<p>When getting started with Serverless, one of the hardest things to grok is IAM—<a href=\"https://aws.amazon.com/iam/\">AWS Identity and Access Management</a>.</p>\n<p>IAM is how you manage access to resources in your AWS account. Who is allowed to create a Lambda function? To <em>delete</em> a function?</p>\n<p>This isn’t the only IAM guide you’ll ever need, but you should understand how IAM works with Lambda and the Serverless Framework. We’ll cover the basics of IAM to get you on your way.</p>\n<p>In this guide, we’ll go over:</p>\n<ul>\n<li>Basic IAM concepts</li>\n<li>The two kinds of IAM entities with the Serverless Framework</li>\n<li>Managing permissions for the Serverless Framework user</li>\n<li>Managing permissions with your Lambda functions</li>\n</ul>\n<p>Let’s get started!</p>\n<h4>Basic IAM concepts</h4>\n<p>There are three basic concepts you should understand in the world of IAM: users, roles, and permissions.</p>\n<p>An <strong>IAM user</strong> is pretty close to what it sounds like—a user that is created to interact with AWS. Usually, this is an actual person within your organization who will use the credentials to log into the AWS console.</p>\n<p>This person often has <em>access keys</em> to programmatically interact with AWS resources. Access keys consist of an “access key ID” and a “secret access key”. Together, they can authenticate a particular user to AWS to access certain resources.</p>\n<p>You might use them with the <a href=\"https://aws.amazon.com/cli/\">AWS CLI</a> or a particular language’s SDK, like <a href=\"http://boto3.readthedocs.io/en/latest/\">Boto3</a> for Python.</p>\n<p>An <strong>IAM role</strong> is similar to an IAM user, but is meant to be assumed by anyone or anything that needs to use it.</p>\n<p>An IAM user could assume an IAM role for a time, in order to access certain resources. An IAM role could also be assumed by another AWS service, such as an EC2 instance or a Lambda function.</p>\n<p>Your Lambda function assuming an IAM role will be important later when we discuss <a href=\"#managing-permissions-for-your-lambda-functions\">managing permissions with your Lambda functions</a>.</p>\n<p>Finally, an <strong>IAM permission</strong> is a statement that grants/blocks an action(s) on a resource or set of resources. An IAM permission contains three elements: <em>Effect</em>, <em>Action</em>, and <em>Resource</em>. (It may optionally include a <em>Condition</em> element, but that’s outside the scope of this article.)</p>\n<ul>\n<li><strong>Effect</strong> tells what effect the IAM permission statement has—whether to Allow or Deny access. Generally, an IAM user does not have access to AWS resources. Most IAM permissions have an Effect of “Allow” to grant access to a particular resource. Occasionally, you might have an Effect of “Deny” to override any other “Allow” permissions.</li>\n<li><strong>Action</strong> tells what action an IAM user or role can take as a result of the IAM permission statement. An Action has two parts: a service namespace and the action in that namespace. For example, the Action of <code class=\"language-text\">s3:GetObject</code> affects the GetObject action in the s3 service namespace. You can use wildcards in the Action, such as <code class=\"language-text\">ec2:*</code> to allow all actions in the EC2 namespace, or simply <code class=\"language-text\">*</code> to allow all actions anywhere. (Hint: Don’t do this).</li>\n<li><strong>Resource</strong> tells what resources the permission statement affects. The value is an <a href=\"http://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html\">ARN</a> or list of ARNs to which the statement applies. This lets you give permissions on a more granular basis, such as limiting the ability to query a particular DynamoDB table rather than granting the ability to query <em>all</em> DynamoDB tables in your account. Like the Action element, you can use the wildcard <code class=\"language-text\">*</code> to apply the statement to <em>all</em> resources in your account.</li>\n</ul>\n<p>To make this more concrete, let’s see one of these statements in action.</p>\n<p>Imagine you’ve created a DynamoDB table named “my-new-table”, and it has the ARN of <code class=\"language-text\">arn:aws:dynamodb:us-west-2:111110002222:table/my-new-table</code>. Now, you want to create a policy that allows your application to do read &#x26; write commands against your table.</p>\n<p>You would have a policy like:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"Version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2012-10-17\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"Statement\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Effect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Action\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    \t<span class=\"token string\">\"dynamodb:Query\"</span><span class=\"token punctuation\">,</span>\n    \t<span class=\"token string\">\"dynamodb:Scan\"</span><span class=\"token punctuation\">,</span>\n    \t<span class=\"token string\">\"dynamodb:GetItem\"</span><span class=\"token punctuation\">,</span>\n    \t<span class=\"token string\">\"dynamodb:PutItem\"</span><span class=\"token punctuation\">,</span>\n    \t<span class=\"token string\">\"dynamodb:UpdateItem\"</span><span class=\"token punctuation\">,</span>\n    \t<span class=\"token string\">\"dynamodb:DeleteItem\"</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Resource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"arn:aws:dynamodb:us-west-2:111110002222:table/my-new-table\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We see the three permission elements noted above. The Effect is “Allow”, which grants the listed actions on the listed resources.</p>\n<p>The Action block contains a list of needed DynamoDB actions, such as GetItem, PutItem, and Query. Notice that it does not include CreateTable and DeleteTable—that is more of an administrative role that your application wouldn’t need.</p>\n<p>Finally, the Resource block has our table’s ARN. This limits the scope of the permissions to our table only, so our application wouldn’t have the ability to query other tables in our AWS account.</p>\n<p><strong>IAM permissions</strong> can be attached to <strong>users</strong> or <strong>roles</strong> (or other things that we won’t cover here). This means you can create an AWS user and give it the permission to create DynamoDB tables, view CloudWatch logs, or any of the many other things you can do with AWS.</p>\n<h4>The Two Types of IAM entities with the Serverless Framework</h4>\n<p>When talking about IAM permissions with the Serverless Framework, there are two different entities (users or roles) that you need to worry about:</p>\n<ul>\n<li>The IAM user used <em>by the Framework</em> to deploy your Serverless service (the <strong>Framework user</strong>)</li>\n<li>The IAM role used <em>by a Lambda function</em> when it’s executed (a <strong>function role</strong>).</li>\n</ul>\n<p>To see the distinction, consider the example application in our <a href=\"https://serverless.com/blog/serverless-express-rest-api/\">Express REST API walkthrough</a>. In that example, we deploy an Express application with a DynamoDB table backing it.</p>\n<p>When we run <code class=\"language-text\">sls deploy</code> to deploy the application, we need to be concerned about the IAM user used by the Framework. This is the user referenced to by the <code class=\"language-text\">profile</code> property in the <code class=\"language-text\">provider</code> block of your <code class=\"language-text\">serverless.yml</code>, or the “default” profile if you don’t set it. The Framework will look in <code class=\"language-text\">~/.aws/credentials</code> for your access keys, then deploy your application.</p>\n<p>In deploying your application, your IAM user will need permissions to:</p>\n<ul>\n<li>Create an S3 bucket for your function deployments</li>\n<li>Upload your function zip files to that S3 bucket</li>\n<li>Submit a CloudFormation template</li>\n<li>Create the log groups for your Lambda functions</li>\n<li>Create a REST API in API Gateway</li>\n<li>Create a DynamoDB table</li>\n</ul>\n<p>Once your service is deployed, you have a different set of IAM issues to worry about. The functions handling your HTTP requests have permissions issues of their own—they need the ability to query the DynamoDB tables and send log messages to CloudWatch.</p>\n<p>With this understanding in mind, let’s walk through how we configure and manage the <strong>Framework user</strong> and how we manage the IAM permissions for our <strong>function roles</strong>.</p>\n<h4>Managing permissions for the Serverless Framework user</h4>\n<p>Let’s talk about IAM permissions for the Serverless Framework user. This is any permissions that are required when you run a command with the Serverless Framework, such as <code class=\"language-text\">sls deploy</code> or <code class=\"language-text\">sls logs</code>.</p>\n<p>The Framework is making its calls to AWS using the Node <a href=\"https://aws.amazon.com/sdk-for-node-js/\">aws-sdk</a>. This means credentials are generally loaded from a file in <code class=\"language-text\">~/.aws/credentials</code> (for Mac/Linux users) or <code class=\"language-text\">C:\\Users\\USERNAME\\.aws\\credentials</code> for Windows users.</p>\n<p>If you haven’t set up permissions before, you’ll need to create an IAM user with access keys and the required permissions. There are basically two ways you can approach this:</p>\n<ul>\n<li><strong>Fast but risky (aka <a href=\"https://www.youtube.com/watch?v=z5Otla5157c\">YOLO</a>):</strong> The fastest way to get started with Serverless is to create an IAM user with Administrator Access. This IAM user will have full access to your AWS account and <strong>should not</strong> be used for your company’s production AWS account. The best approach here is to create a new AWS account or a new <a href=\"https://aws.amazon.com/organizations/\">AWS organization</a> with limited ability to affect other resources. This will give you the widest latitude to experiment with Serverless without getting tangled in a web of IAM permissions.</li>\n</ul>\n<blockquote>\n<p>Check out a video to create a user with Administrator Access <a href=\"https://www.youtube.com/watch?v=KngM5bfpttA\">here</a>.</p>\n</blockquote>\n<ul>\n<li><strong>Slow but safe:</strong> If you’re using Serverless in production, you’ll want more tightly-scoped permissions. With security, you generally want to follow the <a href=\"https://en.wikipedia.org/wiki/Principle_of_least_privilege\">principle of least privilege</a>. For AWS, this means your Serverless IAM user shouldn’t have the ability to alter the Lambda functions and resources of other services in your AWS account. This can be quite difficult but is worth the added security, particularly in a production account.</li>\n</ul>\n<p>One of our community members has contributed a <a href=\"https://github.com/dancrumb/generator-serverless-policy\">Yeoman generator template</a>. This generator makes it much easier to create a narrow IAM policy template that will cover many Serverless use cases.</p>\n<p>To use it, first install Yeoman and the <code class=\"language-text\">serverless-policy</code> generator:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">npm</span> <span class=\"token function\">install</span> -g yo generator-serverless-policy</code></pre></div>\n<p>Then run the generator and answer the prompts:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ yo serverless-policy\n? Your Serverless <span class=\"token function\">service</span> name test-service\n? You can specify a specific stage, <span class=\"token keyword\">if</span> you like: dev\n? You can specify a specific region, <span class=\"token keyword\">if</span> you like: us-west-1\n? Does your <span class=\"token function\">service</span> rely on DynamoDB? Yes\n? Is your <span class=\"token function\">service</span> going to be using S3 buckets? Yes\napp name test-service\napp stage dev\napp region us-west-1\nWriting to test-service-dev-us-west-1-policy.json</code></pre></div>\n<p>This will create a JSON file in your working directory with permissions scoped to your service. It’s not perfect, but it will get you closer.</p>\n<p>Create an IAM user with that policy file—or ship it to the person in charge of IAM security at your company—and you should be on your way.</p>\n<h4>Managing permissions for your Lambda Functions</h4>\n<p>The second aspect of IAM with Serverless is the permissions for your Lambda functions themselves. If your functions read from a DynamoDB table, write to an SQS queue, or use a KMS key to decrypt a string, they’ll need to be given specific permission to do that.</p>\n<p>You can add these additional permission statements directly in your <code class=\"language-text\">serverless.yml</code>. To add these permissions, use the <code class=\"language-text\">iamRoleStatements</code> section of the <code class=\"language-text\">provider</code> block.</p>\n<p>Let’s use our DynamoDB example from the first section:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token key atrule\">runtime</span><span class=\"token punctuation\">:</span> nodejs6.10\n  <span class=\"token key atrule\">iamRoleStatements</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">Effect</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Allow\"</span>\n      <span class=\"token key atrule\">Action</span><span class=\"token punctuation\">:</span>\n       <span class=\"token punctuation\">-</span> dynamodb<span class=\"token punctuation\">:</span>Query\n       <span class=\"token punctuation\">-</span> dynamodb<span class=\"token punctuation\">:</span>Scan\n       <span class=\"token punctuation\">-</span> dynamodb<span class=\"token punctuation\">:</span>GetItem\n       <span class=\"token punctuation\">-</span> dynamodb<span class=\"token punctuation\">:</span>PutItem\n       <span class=\"token punctuation\">-</span> dynamodb<span class=\"token punctuation\">:</span>UpdateItem\n       <span class=\"token punctuation\">-</span> dynamodb<span class=\"token punctuation\">:</span>DeleteItem\n      <span class=\"token key atrule\">Resource</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"arn:aws:dynamodb:us-west-2:111110002222:table/my-new-table\"</span></code></pre></div>\n<p>This block gives our functions the ability to query, scan, and manipulate items on a particular DynamoDB table.</p>\n<p><strong>Pro-tip</strong>: You can use <a href=\"http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference.html\">CloudFormation Intrinsic Functions</a> to make it easier to refer to specific resources. For example, if you’ve created your DynamoDB table in the <code class=\"language-text\">resources</code> section of your <code class=\"language-text\">serverless.yml</code>, you can use the <code class=\"language-text\">Fn::GetAtt</code> intrinsic function to get the ARN:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token comment\"># serverless.yml</span>\n\n<span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">Resources</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">MyDynamoTable</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">...</span> Rest of CloudFormation defining the table <span class=\"token punctuation\">...</span>\n\n<span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token key atrule\">runtime</span><span class=\"token punctuation\">:</span> nodejs6.10\n  <span class=\"token key atrule\">iamRoleStatements</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">Effect</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Allow\"</span>\n      <span class=\"token key atrule\">Action</span><span class=\"token punctuation\">:</span>\n       <span class=\"token punctuation\">-</span> dynamodb<span class=\"token punctuation\">:</span>Query\n       <span class=\"token punctuation\">-</span> dynamodb<span class=\"token punctuation\">:</span>Scan\n      <span class=\"token key atrule\">Resource</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">Fn::GetAtt</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> MyDynamoTable\n          <span class=\"token punctuation\">-</span> Arn</code></pre></div>\n<p>Here, we dynamically grab the DynamoDB table ARN by using <code class=\"language-text\">Fn::GetAtt</code>, and pass in the logical Id of the resource <code class=\"language-text\">MyDynamoTable</code> from the <code class=\"language-text\">resources</code> block. Then we request the <code class=\"language-text\">Arn</code> property.</p>\n<p>You can see which attributes are available for a particular CloudFormation resources by checking the <code class=\"language-text\">Return Values</code> section of the CloudFormation reference—see <a href=\"http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-dynamodb-table.html#w2ab2c21c10d328c13\">here for a DynamoDB example</a>.</p>\n<p>You can also craft <a href=\"https://serverless.com/framework/docs/providers/aws/guide/iam#custom-iam-roles\">custom IAM roles</a> for each function in your <code class=\"language-text\">serverless.yml</code>, but be advised this is an advanced feature. You’ll need to make sure to specify <em>all</em> permissions of your functions, including some that Serverless usually handles for you, such as the ability to write to CloudWatch logs.</p>\n<p>There’s a <a href=\"https://github.com/puresec/serverless-puresec-cli\"><code class=\"language-text\">serverless-puresec-cli</code></a> plugin that assists in this process. Puresec scans your functions to see which AWS resources they’re accessing and how to automatically create least-privilege roles. It doesn’t cover all resources yet, but it is a good start if you’re interested.</p>\n<h4>Conclusion</h4>\n<p>IAM permissions are complex, and there’s a lot more to learn than what is covered in this article. But this should be a great starting point.</p>\n<p>Live long and permission. 🖖</p>","frontmatter":{"title":"The ABCs of IAM: Managing permissions with Serverless","date":"November 14, 2017","description":"Learn the basics of IAM permissions with your Serverless projects."}}},"pageContext":{"slug":"/posts/2017-11-14-abcs-of-iam-permissions/","previous":{"fields":{"slug":"/posts/2017-11-13-crdt-explained-supercharge-serverless-at-edge/"},"frontmatter":{"title":"CRDTs explained - supercharge your serverless with CRDTs at the Edge"}},"next":{"fields":{"slug":"/posts/2017-11-15-flask-python-rest-api-serverless-lambda-dynamodb/"},"frontmatter":{"title":"Build a Python REST API with Serverless, Lambda, and DynamoDB"}}}}}