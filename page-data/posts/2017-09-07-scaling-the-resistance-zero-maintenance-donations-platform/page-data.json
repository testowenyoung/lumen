{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/2017-09-07-scaling-the-resistance-zero-maintenance-donations-platform/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"4bb6b8da-81b8-530e-bebc-e7f4e3fb5ff8","excerpt":"Hey folks, I’m Victor Stone, technology lead for MovementVote.org. The business of “funding the resistance” is a volatile one. There are big spikes of donations…","html":"<p>Hey folks, I’m Victor Stone, technology lead for <a href=\"https://movementvote.org/\">MovementVote.org</a>.</p>\n<p>The business of “funding the resistance” is a volatile one. There are big spikes of donations after major events (Charlottesville, Harvey, etc.), followed by relatively quiet periods. And those traffic spikes can be huge.</p>\n<p>As a non-profit running on volunteerism and a shoestring budget, it’s a lot to manage, and we wondered where to turn. Atomic services (like AWS) were both a flexible blessing and a rigid curse. Sometimes they practically require a PhD in configuration files.</p>\n<p>When we tried out the Serverless Framework, all that power and flexibility suddenly seemed within reach. Serverless meant we could have a pay-as-you-go, zero-maintanence site that we could build, deploy and host in a single environment. We were pumped to try it out.</p>\n<h2>Background</h2>\n<p>Gamechanger Labs has grown up over the last few decades. We started as a scrappy little non-profit relying on part-time contractors and volunteer love; now we’ve become a concierge platform for major donors that moves <a href=\"https://movementvote.org\">millions of dollars</a> into the hands of nearly 100 different grassroots organizations.</p>\n<p>The rise in attention was overwhelming for our tiny, free-tier EC2 / Nodejs-React donations site. Too much energy was going to things like <a href=\"https://github.com/expressjs/express/issues/2997\">chasing memory leaks in expressjs</a> and (frankly) keeping the site from crashing. </p>\n<h2>Foreground</h2>\n<p>Taking a step back, it was obvious that the website didn’t really do any computing at all.</p>\n<p>It was a single-page app with five static pages. There were also a small set of services (e.g. contacting staff and managing donations plans) that had very little to do with the webpages itself.</p>\n<p>The site’s content lived on a completely separate hosting service. We used that as a headless Wordpress installation where the admins could edit the site via plugins and the Wordpress app. That WP installation emitted a <a href=\"https://github.com/Movement-2016/movement2016-wp/blob/master/wp-content/themes/movement-admin-theme/inc/movement-json.php\">JSON RPC API</a>, which was then fed to React components that populated the website.</p>\n<p>As thin as our React app was, it wasn’t thin enough to save it from being overwhelmed.</p>\n<p>Because the AWS universe is highly componentized, we could migrate the server side functions and our completely static website in an S3 bucket - one piece at a time. There was a period when I was wedging AWS services into our environment, and that worked perfectly.</p>\n<p>The goal was to move concierge’s <a href=\"https://github.com/Movement-2016/concierge/blob/master/src/server/api.js#L18\">server side functionality</a> (running on EC2) over into Lambda. It was critical for that move to be completely transparent to the React code in the browser.</p>\n<p>The mantra of the project became “this should be easier.” In fact, I hit a wall when it came to Lambda. The service itself was pretty easy to understand conceptually, but one look behind the scenes of what the Serverless Framework is actually doing and it’s obvious there are many 1000s of man hours involved in creating a seamless development environment.</p>\n<p>We didn’t have the resources to invest anything close to that.</p>\n<h3>Server -> Serverless</h3>\n<p>The server functions were moved into a new Git project called <a href=\"https://github.com/Movement-2016/bellman\">bellman</a>. Each API gets their own <code class=\"language-text\">serverless.yml</code> configuration.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  src\n    |- contact\n        |-serverless.yml\n        |-handler.js\n    |- users\n        |-serverless.yml\n        |-handler.js</code></pre></div>\n<p>Some of our services are CRUD, some are just straight up RPC APIs. For all cases I created a base class (<a href=\"https://github.com/Movement-2016/bellman/blob/master/src/lib/LambdaFunc.js\">LambdaFunc</a>) to encapsulate and normalize some of the more arcane AWS structures and methods. </p>\n<p>It was stunning to see how much of the previous code was http server plumbing versus functionality. When I started migrating from the Expressjs environment to Lambda, the code shrunk an order of magnitude and focused 100% on app functionality.</p>\n<p>Here’s how I encapsulated the ‘contact’ form hander:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">/* src/contact/handler.js */</span>\n<span class=\"token keyword\">import</span> LamdaFunc <span class=\"token keyword\">from</span> <span class=\"token string\">'../lib/LambdaFunc'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> mailer    <span class=\"token keyword\">from</span> <span class=\"token string\">'../lib/email'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> templates  <span class=\"token keyword\">from</span> <span class=\"token string\">'./templates'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ContactEmail</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">LamdaFunc</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token function\">perform</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">const</span> body      <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> email <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> body<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> subject   <span class=\"token operator\">=</span> <span class=\"token string\">'New contact form submission from '</span> <span class=\"token operator\">+</span> email<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token function\">mailer</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">{</span> body<span class=\"token operator\">:</span> templates<span class=\"token punctuation\">.</span><span class=\"token function\">contact</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> subject <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>thenHandler <span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>errorHandler <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Exporting the method was encapsulated in a property of the base class:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  contact<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ContactEmail</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>handler\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>For CRUD APIs I created a <a href=\"https://github.com/Movement-2016/bellman/blob/master/src/lib/RESTService.js\">RESTService class</a> that encapsulated boilerplate DynamoDB access to the point where I didn’t even have to code the methods.</p>\n<p>By passing the name of the DynamoDB table in the environment:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> users\n\n<span class=\"token key atrule\">custom</span><span class=\"token punctuation\">:</span> \n  <span class=\"token key atrule\">stage</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"${opt:stage, self:provider.stage}\"</span>\n  <span class=\"token key atrule\">tableName</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>self<span class=\"token punctuation\">:</span>service<span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">{</span>self<span class=\"token punctuation\">:</span>custom.stage<span class=\"token punctuation\">}</span>\n<span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>  \n  <span class=\"token key atrule\">Resources</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">restTable</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">Type</span><span class=\"token punctuation\">:</span> AWS<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>DynamoDB<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Table\n      <span class=\"token key atrule\">Properties</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">TableName</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>self<span class=\"token punctuation\">:</span>custom.tableName<span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">AttributeDefinitions</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">AttributeName</span><span class=\"token punctuation\">:</span> email\n            <span class=\"token key atrule\">AttributeType</span><span class=\"token punctuation\">:</span> S  </code></pre></div>\n<p>the default REST code reduced to almost none (this is the <em>entire</em> code for the CRUD interface for managing users):</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">/* src/users/handler.js */</span>\n<span class=\"token keyword\">import</span> Service <span class=\"token keyword\">from</span> <span class=\"token string\">'../lib/RESTService'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">UserTableFunc</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Service</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">get</span> <span class=\"token function\">Key</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> email <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> email <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">UserTableFunc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">;</span></code></pre></div>\n<h3>Client SDK</h3>\n<p>It’s important to encapsulate the API for browser consumers, so that when you install the <code class=\"language-text\">bellman</code> package it is very OOP/API-like. </p>\n<p>The API Gateway has a feature to generate a client SDK for your remote Lambda function. I generated that SDK, but it looked very much like a generic catch-all. Here’s a hint: if the process to generate the client is 100% automated, it will feel like that to the caller. My old friend and mentor used to call this condition “implementation-bubble-up-itis.”</p>\n<p>I chose to create my own system that generated a client SDK. My system was mostly automated but needed some manual guidance. First, I created a <a href=\"https://github.com/Movement-2016/bellman/blob/master/clients/lib/Client.js\">client side helper class</a> for all cases. Next, a specialized derivation for <a href=\"https://github.com/Movement-2016/bellman/blob/master/clients/lib/Service.js\">REST/CRUD APIs</a>.</p>\n<p>With these in place, I could expose a CRUD interface with less than 10 lines of code.</p>\n<p>For custom APIs, I had to manually create the end point class with the shape of the API:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> Client <span class=\"token keyword\">from</span> <span class=\"token string\">'../lib/Client'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">EmailClient</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Client</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token function\">contact</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">_post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'contact'</span><span class=\"token punctuation\">,</span><span class=\"token operator\">...</span>arguments<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">party</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">_post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'party'</span><span class=\"token punctuation\">,</span><span class=\"token operator\">...</span>arguments<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>The last piece to the client SDK is a rather funky <a href=\"https://github.com/Movement-2016/bellman/blob/master/bin/genclients.js\">build-time script</a> that 1) extracts the API endpoints for both stages and 2) creates a <code class=\"language-text\">module.exports</code> that encapsulates each endpoint into an instance of the <code class=\"language-text\">Client</code> class:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">/* generated by build */</span>\n<span class=\"token keyword\">var</span> a <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./lib/Service'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> b <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./email'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  prod<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function-variable function\">users</span><span class=\"token operator\">:</span>  <span class=\"token parameter\">cfg</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">a</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token operator\">...</span>cfg<span class=\"token punctuation\">,</span>endpoint<span class=\"token operator\">:</span><span class=\"token string\">'https://xxxxhtuk84.execute-api.us-west-2.amazonaws.com/prod'</span><span class=\"token punctuation\">,</span>slug<span class=\"token operator\">:</span><span class=\"token string\">'users'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function-variable function\">email</span><span class=\"token operator\">:</span>  <span class=\"token parameter\">cfg</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">b</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token operator\">...</span>cfg<span class=\"token punctuation\">,</span>endpoint<span class=\"token operator\">:</span><span class=\"token string\">'https://xxxxc17imc.execute-api.us-west-2.amazonaws.com/prod'</span><span class=\"token punctuation\">,</span>slug<span class=\"token operator\">:</span><span class=\"token string\">'email'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n   <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  dev<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function-variable function\">users</span><span class=\"token operator\">:</span>  <span class=\"token parameter\">cfg</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">a</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token operator\">...</span>cfg<span class=\"token punctuation\">,</span>endpoint<span class=\"token operator\">:</span><span class=\"token string\">'https://xxx9e9xf9.execute-api.us-west-2.amazonaws.com/dev'</span><span class=\"token punctuation\">,</span>slug<span class=\"token operator\">:</span><span class=\"token string\">'users'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function-variable function\">email</span><span class=\"token operator\">:</span>  <span class=\"token parameter\">cfg</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">b</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token operator\">...</span>cfg<span class=\"token punctuation\">,</span>endpoint<span class=\"token operator\">:</span><span class=\"token string\">'https://xxx2tv0ka.execute-api.us-west-2.amazonaws.com/dev'</span><span class=\"token punctuation\">,</span>slug<span class=\"token operator\">:</span><span class=\"token string\">'email'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>This then allows for a ‘natural’ interface in the browser:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> bellman <span class=\"token keyword\">from</span> <span class=\"token string\">'bellman'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> authorizationStuff <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  sessionId<span class=\"token punctuation\">,</span>\n  <span class=\"token operator\">...</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  \n <span class=\"token keyword\">const</span> users <span class=\"token operator\">=</span> bellman<span class=\"token punctuation\">.</span>prod<span class=\"token punctuation\">.</span><span class=\"token function\">users</span><span class=\"token punctuation\">(</span>authorizationStuff<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n \n users<span class=\"token punctuation\">.</span><span class=\"token function\">list</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span> <span class=\"token parameter\">users</span> <span class=\"token operator\">=></span> users<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">...</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>Static Site</h3>\n<p>Having moved our server code into Lambda, it was now possible to serve our website from a static S3 bucket.</p>\n<p>What I learned in this migration, however, is that AWS CodeBuild deploys to a directory off of the root of your bucket, but the Web hosting feature of S3 wants your <code class=\"language-text\">index.html</code> file to be at the root. CodeBuild also leaves the files encrypted, but the Web hoster wants the files to be <em>public</em> and <em>unencrypted</em>. </p>\n<p>I couldn’t figure out a way to handle that with AWS services. So I wrote a couple of lines of script and pushed it <a href=\"https://github.com/Movement-2016/bellman/tree/master/src/deploy\">into our bellman API project</a>. It gets triggered from the AWS CloudWatch event after the CodeBuild project is finalized.</p>\n<h2>Conclusion</h2>\n<p>On paper, this setup seems like it will be a huge time and cost savings for us. I suppose we’ll come to that when we’ve traversed another event that inspires folks to open their checkbooks!</p>\n<p>Either way, none of this, not one piece of it, would have been possible without a tool like Serverless to glide us into the future.</p>","frontmatter":{"title":"Scaling the Resistance - a Zero-maintenance Donations Platform with Serverless and AWS","date":"September 07, 2017","description":"To raise millions of dollars in donations, you need a zero-maintenance architecture that never turns a donor away"}}},"pageContext":{"slug":"/posts/2017-09-07-scaling-the-resistance-zero-maintenance-donations-platform/","previous":{"fields":{"slug":"/posts/2017-09-06-running-multi-cloud-functions-at-spot-instance-prices/"},"frontmatter":{"title":"Run Serverless Functions at half the cost with Spotinst & Serverless Framework"}},"next":{"fields":{"slug":"/posts/2017-09-08-serverless-ops-logs/"},"frontmatter":{"title":"Serverless Ops 102 - CloudWatch Logs and Centralized Logging with AWS Lambda"}}}}}