{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/2020-02-10-preview-deployments/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"4d82cf55-f5a2-5e98-bd69-3ccd732ec7cd","excerpt":"In this guide, I’ll explain what Framework Pro preview deployments are, why you might want to take advantage of them and then show you how to enable these on…","html":"<p>In this guide, I’ll explain what Framework Pro preview deployments are, why you might want to take advantage of them and then show you how to enable these on your own applications. I’ll use a version of a song vote counting service I created called Serverless Jams to help illustrate this and you can follow along with me step by step.</p>\n<h2>So What Are Preview Deployments?</h2>\n<p>You might be familiar with the concept of preview deployments from frontend tooling like Netlify that allow you to create a preview of frontend builds before they are merged into a production website.</p>\n<p>Well, we at Serverless thought - “Why don’t we have that for our backends?”</p>\n<p>In the past, the answer to this question has been simple - it costs too much. In the days of expensive, sprawling backend infrastructures it took far too much money and developer time to replicate these environments effectively for testing and staging - let alone for every PR. </p>\n<p>But with serverless applications, managed services, and microservice architectures that’s no longer the case. Take a typical AWS microservice with the serverless framework. What resources are included? Probably some of these:</p>\n<ul>\n<li>Lambda Functions</li>\n<li>API Gateway Endpoints</li>\n<li>DynamoDB Tables</li>\n<li>SQS Queues</li>\n<li>SNS Topics</li>\n<li>S3 Buckets</li>\n<li>SSM Parameters</li>\n</ul>\n<p>What characteristics do these resources share? They’re virtually all pay-as-you-go or pay-per-use/invocation style services or can be configured very cheaply. This means, we can create an entire separate stack of our infrastructure for every feature branch without spending much at all. </p>\n<h2>Why Use Preview Deployments?</h2>\n<p>The preview deployments benefits for frontend code are clearly apparent - you get some preview URL of a deployment and you can see what changed and make sure it looks great. So what do we really get out of doing something similar for the backend? Let’s take a look.</p>\n<p><strong>Automated Tests and Serverless Safeguard</strong></p>\n<p>When you create your Preview Deployment, the Framework Pro CI/CD system will still run any <a href=\"https://serverless.com/framework/docs/dashboard/safeguards/\">Safeguards</a> you have configured for the <code class=\"language-text\">default</code> profile. You’ll also still have any automated <a href=\"https://serverless.com/framework/docs/dashboard/cicd/running-tests/\">tests</a> you have setup run against the deployment. This gives you all the same benefits you might otherwise have waited until a staging environment to check against.</p>\n<p><strong>They Can Supplement Existing CI/CD</strong></p>\n<p>You can use Preview Deployments in combination with Serverless CI/CD for stages like production and staging. Or, you can use them in addition to whatever existing CI/CD tools you have. Already using another tool for your workflow? Great! You can still add Preview Deployments without disrupting any of your existing processes!</p>\n<p><strong>A Clean Environment for Code Review</strong></p>\n<p>Because you’re spinning up an entire set of infrastructure, it’s open season for your code reviewers to play with the API endpoints and infrastructure resources.</p>\n<p>They can run manual tests to confirm the deployment meets expectations, run API contract tests against the API endpoints that are created or integrate the feature branch into local frontends for a fuller test experience. This can be especially helpful when you want validation from a frontend team on the expected functionality for a new API. And because the preview branch is discrete from other environments they don’t have to worry about stepping on any toes during the review.</p>\n<p>After this, they can go straight back to the PR, and make sure that any issues and feedback they discover are addressed before the PR is even merged into a staging environment.</p>\n<p><strong>Automated Spin Up and Spin Down</strong></p>\n<p>Because these resources are all spun up automatically by opening the PR, there’s no manual process for the developer or reviewers to create a full environment to test against. The best part is that when the PR is finally closed or merged you can configure your deployment to automatically remove the infrastructure resources that were created in AWS.</p>\n<h2>How to Use Preview Deployments</h2>\n<p>So how do we configure all this? In this section, I’ll take you through how to get started with preview deployments. You’ll be able to follow along with every step by cloning my <a href=\"https://github.com/fernando-mc/serverless-preview-deployments\">Serverless Preview Deployments</a> project and using it in your own <a href=\"https://dashboard.serverless.com/\">Framework Pro</a> account.</p>\n<h3>Prerequisites</h3>\n<p>In order to get started with Preview Deployments, you’ll need a Framework Pro account. You can get a free account for personal use <a href=\"http://dashboard.serverless.com/\">here</a> and configure it using <a href=\"https://serverless.com/framework/docs/dashboard#enabling-the-dashboard-on-existing-serverless-framework-services\">these steps</a>.</p>\n<p>As of this post, preview deployments require you to:</p>\n<ul>\n<li>Have your code in GitHub</li>\n<li>Be deploying services to AWS</li>\n<li>Be using either Node or Python</li>\n<li>Be using a recent version of the Serverless Framework (I’m using v1.62.0)</li>\n</ul>\n<p>With all of these perquisites met, you should be able to configure your repository to use preview deployments.</p>\n<h3>Setting Up Preview Deployments</h3>\n<p>First, you’ll need to follow some steps to get any CI/CD working with your Framework Pro account. The steps are documented <a href=\"https://serverless.com/framework/docs/dashboard/cicd/\">here</a> but let’s walk through them together.</p>\n<p><strong>1. Link Your AWS Account to a Default Profile</strong></p>\n<p>When using preview deployments, we’ll be deploying to a stage name based on the feature branch name. This helps avoid conflicts with resource names because feature branch names should be unique. </p>\n<p>This also means we need to configure the “default” Framework Pro <a href=\"https://serverless.com/framework/docs/dashboard/profiles/\">deployment profile</a> with a role so it can deploy feature branches. You can do that by clicking the profiles menu and then clicking on the “default” profile. </p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/2020-02-10-preview-deployments/01-profiles.png\" alt=\"Screenshot of profiles\"></p>\n<p>From here, you’ll need to configure a “shared AWS account” to use when deploying your preview deployments:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/2020-02-10-preview-deployments/02-default-profile.png\" alt=\"Screenshot of default profile\"></p>\n<p>This setting will require you to create an AWS IAM Role if you haven’t already and give it permissions to Framework Pro to deploy your services. Once you save the default profile, you can then move to deploying and configuring your service with preview deployments.</p>\n<p><strong>2. Get Your GitHub Repo Setup</strong></p>\n<p>For this example, I’ll use a version of Serverless Jams - a vote counting system for different coding-related songs. We’ll open a feature branch PR to add some functionality to Serverless Jams after we create it in our own GitHub repo.</p>\n<p>Go ahead and sign in to GitHub and take a moment to <a href=\"https://github.com/new\">create a new GitHub Repository</a>. You can make it public or private, just give it a memorable name because we’ll have to find it later. I’ll call mine <code class=\"language-text\">preview-deployments-test</code>:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/2020-02-10-preview-deployments/03-new-repo.png\" alt=\"Screenshot of new repo creation page on GitHub\"></p>\n<p>Then copy down the git URL for your repo for later. Mine is: <code class=\"language-text\">https://github.com/fernando-mc/preview-deployments-test.git</code></p>\n<p>We need to do this step because we’ll need our own repository in our own GitHub account to push code to and then configure with Preview Deployments later on.</p>\n<p>After you create that repo, you can clone the code we’ll be using:</p>\n<ul>\n<li>Run <code class=\"language-text\">git clone https://github.com/fernando-mc/serverless-preview-deployments.git</code> to get the code</li>\n<li>Enter the project directory with <code class=\"language-text\">cd serverless-preview-deployments</code></li>\n<li>Then change the git origin with <code class=\"language-text\">git remote set-url origin &lt;YOUR_GIT_REPO_URL&gt;</code>, for example, mine would be: <code class=\"language-text\">git remote set-url origin git@github.com:fernando-mc/preview-deployments-test.git</code></li>\n<li>You can confirm that you’ve correctly updated the remote URL with <code class=\"language-text\">git remote -v</code></li>\n<li>Then run <code class=\"language-text\">git push origin master</code> to push this code to your own repo.</li>\n</ul>\n<p>I’m jumping through all these hoops to make sure this repo is yours and yours alone and not associated with mine in any way. That way I can make sure you don’t inadvertently open feature requests against <em>my</em> repo, which will unfortunately fail for you!</p>\n<p>With this repo setup, we now need to create and configure an App in Framework Pro.</p>\n<p><strong>3. Configuring Your App in Framework Pro</strong></p>\n<p>Navigate to the <a href=\"https://dashboard.serverless.com/\">Framework Pro dashboard</a> and click the “Add App” button. Add an app and make sure to update the name of the app and org values inside of <code class=\"language-text\">serverless.yml</code> in your newly pushed project.</p>\n<p>One snazzy way to do this is to run <code class=\"language-text\">serverless --org orgname --app appname</code>. You can also just open the <code class=\"language-text\">serverless.yml</code> file and confirm you see something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">org</span><span class=\"token punctuation\">:</span> fernandosdemos\n<span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> preview<span class=\"token punctuation\">-</span>deployments\n<span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> serverlessjams</code></pre></div>\n<p>Where <code class=\"language-text\">fernandosdemos</code> is your org name and <code class=\"language-text\">preview-deployments</code> is your app name. Then make sure to save the <code class=\"language-text\">serverless.yml</code> file and push this change to the GitHub repo with: <code class=\"language-text\">git add . &amp;&amp; git commit -m &quot;update app and org&quot; &amp;&amp; git push origin master</code>.</p>\n<p>Now that you have the correct org and app values, you can connect GitHub. Click into your app, and visit the “ci/cd settings” tab. Then connect your GitHub account and install the Serverless GitHub application. </p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/2020-02-10-preview-deployments/04-connect-github.png\" alt=\"Screenshot of connecting GitHub\"></p>\n<p>If you have multiple organizations associated with your account, you’ll need to pick the one you put the repo in.</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/2020-02-10-preview-deployments/05-select-org-user.png\" alt=\"Screenshot of selecting the Org or User account in GitHub\"></p>\n<p>After this, you will at least need to grant permissions to access the repo we just created.</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/2020-02-10-preview-deployments/06-select-repositories.png\" alt=\"Screenshot of selecting repositories in GitHub\"></p>\n<p>At some point, you might also have another screen or two prompting you to install the Serverless Application in GitHub. After you’re done with this process, you can head back to the Framework Pro dashboard and you should now see a repo dropdown to pick from:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/2020-02-10-preview-deployments/07-connect-repo.png\" alt=\"Screenshot of connecting the repo in the Framework Pro dashboard\"></p>\n<p>After you select the repo your using, preview deployments should be configured by default as shown below:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/2020-02-10-preview-deployments/08-preview-deploy-settings.png\" alt=\"Screenshot of the preview deployment settings\"></p>\n<p>You could also configure deployments for other branches (like whenever changes are made in master). But for now, just save the settings and continue.</p>\n<h3>Testing Preview Deployments</h3>\n<p>In this example, we’ll have a <code class=\"language-text\">master</code> branch in your GitHub repository. When a PR is made against the <code class=\"language-text\">master</code> branch from a feature branch, we’ll want to create a Preview Deployment for that PR. To set this all up, go back to your code, and run <code class=\"language-text\">git checkout -b preview-test-feature</code> to create a new feature branch. Then, in the <code class=\"language-text\">backend/vote.py</code> file change the integer on line 44 from <code class=\"language-text\">1</code> to <code class=\"language-text\">4</code>. This will have us vote by 4 instead of by 1. Now, add and push the changes:</p>\n<ul>\n<li>Run <code class=\"language-text\">git add .</code> to add your changes</li>\n<li>Then commit the change <code class=\"language-text\">git commit -m &quot;vote by 4&quot;</code></li>\n<li>And finally push them to the feature branch at the origin with <code class=\"language-text\">git push origin preview-test-feature</code></li>\n</ul>\n<p>The output of this should include something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">remote: Create a pull request for &#39;preview-test-feature&#39; on GitHub by visiting:\nremote:      https://github.com/fernando-mc/preview-deployments-test/pull/new/preview-test-feature</code></pre></div>\n<p>If you see that, you can click on the link to automatically open a PR. Otherwise, visit your repo in GitHub and open a PR manually:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/2020-02-10-preview-deployments/09-compare-pull-request.png\" alt=\"Screenshot of the open a pull request button\"></p>\n<p>Then, actually open the PR:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/2020-02-10-preview-deployments/10-create-pull-request.png\" alt=\"Screenshot of pull request creation page\"></p>\n<p>After you open the PR, you should see the GitHub checks running on your PR like this:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/2020-02-10-preview-deployments/11-serverless-cicd-preview-checks.png\" alt=\"Screenshot of the preview checks run in GitHub by Serverless\"></p>\n<p>If you see a failure like this click the “Details”:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/2020-02-10-preview-deployments/12-serverless-cicd-preview-failed.png\" alt=\"Screenshot of a failed build in GitHub\"></p>\n<p>This should direct you to the deployments section of the Framework Pro dashboard. From there, you can review the log for your preview deployment to see what happened:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/2020-02-10-preview-deployments/13-deployment-log-failure.png\" alt=\"Screenshot of a failed build log in Framework Pro\"></p>\n<p>If you followed all the earlier steps above your build probably succeeded, but you might also see an error that will help you fix whatever failed in the build. In this case, we see an error related to our deployment profile: “AWS provider credentials not found. Learn how to set up AWS provider credentials in our docs here: <a href=\"http://slss.io/aws-creds-setup\">http://slss.io/aws-creds-setup</a>.” </p>\n<p>If you saw this error, make sure to configure the deployment profile mentioned in step 1 above and then push an update to the preview branch to get it to rebuild. After you do this, (or if you didn’t make this mistake in the first place) you should see this:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/2020-02-10-preview-deployments/14-serverless-cicd-preview-success.png\" alt=\"Screenshot of successful preview deployment in GitHub\"></p>\n<p>Clicking the “Details” link inside of the Serverless check should direct you to the Framework Pro dashboard where you can review the logs from the build:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/2020-02-10-preview-deployments/15-deployment-log-p1.png\" alt=\"Screenshot of successful deployment log in Framework Pro\"></p>\n<p>You should see any configured safeguards run against your deployment:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/2020-02-10-preview-deployments/16-deployment-log-p2-safeguards.png\" alt=\"Screenshot of Safeguards running in Framework Pro\"></p>\n<p>And the safeguards should also display any warnings that might apply to this preview deployment:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/2020-02-10-preview-deployments/17-deployment-log-p3-safeguards-warns.png\" alt=\"Screenshot of safeguards warning in Framework Pro CICD log\"></p>\n<p>Finally, after the deployment is completed, you’ll see any API endpoints and other relevant resources that were created:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/2020-02-10-preview-deployments/18-deployment-log-api-endpoints.png\" alt=\"Screenshot of API endpoints being output in Framework Pro logs\"></p>\n<p>At this point, any reviewer could copy and paste those API endpoints and test them out. If I were reviewing, I could test out the new API using something like Postman or even copy the API endpoint directly into the frontend and test it out within the UI. Let’s give that a shot now for fun.</p>\n<p>Copy the base of the API endpoint from the log, in my case: </p>\n<p><code class=\"language-text\">https://myj49ah5kk.execute-api.us-east-1.amazonaws.com/preview-test-feature/</code></p>\n<p>Then, paste it into the <code class=\"language-text\">frontend/app.js</code> file where the <code class=\"language-text\">REPLACE_ME</code> value currently is on line 10 so it becomes the new <code class=\"language-text\">endpoint_url_root</code>.</p>\n<p>Then, change directories into the <code class=\"language-text\">frontend</code> repository and run <code class=\"language-text\">python3 -m http.server</code> to start a webserver for the frontend and open up <a href=\"http://localhost:8000/\">localhost:8000</a>. It should look something like this:</p>\n<p><img src=\"https://s3-us-west-2.amazonaws.com/assets.blog.serverless.com/2020-02-10-preview-deployments/19-frontend-test-1.png\" alt=\"Screenshot of the frontend application\"></p>\n<p>From there, you can try using the app! Make sure to enter your number in with the plus sign and the country code at the beginning. After you submit a vote you’ll see that it is incremented by 4 instead of 1. From here, we could keep testing the API endpoints, go and comment on the PR and suggest any changes we needed made.</p>\n<p>When we’re done, we can either merge the PR or close it. At that point, It’s also self-cleaning. After your branch is merged or deleted Serverless CI/CD will automatically remove your service. Bear in mind, you will have to delete the branch, not just close the PR for the infrastructure to be removed.</p>\n<h2>What Next?</h2>\n<p>So by now I hope I’ve convinced you of the utility and possibilities of preview deployments. Next, try taking a look at the <a href=\"https://serverless.com/framework/docs/dashboard/cicd/\">other features</a> of Serverless CI/CD like <a href=\"https://serverless.com/framework/docs/dashboard/cicd/branch-deployments/\">branch deployments</a>, and <a href=\"https://serverless.com/framework/docs/dashboard/cicd/running-tests/\">testing</a>.</p>\n<p>If you have suggestions about what you want from Serverless CI/CD next let us know in the comments below!</p>","frontmatter":{"title":"A Guide to Preview Deployments with Serverless CI/CD","date":"February 10, 2020","description":"A closer look at working with Preview Deployments in the Serverless CI/CD solution."}}},"pageContext":{"slug":"/posts/2020-02-10-preview-deployments/","previous":{"fields":{"slug":"/posts/2020-02-03-announcement-cicd/"},"frontmatter":{"title":"Announcing Serverless CI/CD"}},"next":{"fields":{"slug":"/posts/2020-02-11-cicd-promotion-pipelines/"},"frontmatter":{"title":"Promotion Pipelines"}}}}}