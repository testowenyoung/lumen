{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/2017-06-05-devops-serverless-variables/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"0da9df06-64b9-5cad-9b72-3397f607936e","excerpt":"The Serverless Framework has a powerful built-in variable system that helps secure your sensitive data and can be used to keep even the most complex…","html":"<p>The Serverless Framework has a powerful built-in variable system that helps secure your sensitive data and can be used to keep even the most complex configuration simple and manageable. We have pretty comprehensive coverage of all of the features of the variable system in <a href=\"https://serverless.com/framework/docs/providers/aws/guide/variables/#variables\">our documentation</a>, but when combined together in creative ways these features enable some extremely powerful workflows and real world use cases.</p>\n<p>In this article we’ll explore some ideas on how you can use these features to better automate your serverless operations.</p>\n<h1>Dynamic Configuration</h1>\n<p>You can use the variable system to dynamically generate configuration data for your config files with the help of JS scripts, which is normally not supported by YAML/JSON. Some examples include generating random numbers, dates, doing mathematical computation, or fetching remote data. Let’s look at two of these examples..</p>\n<h3>Generating Random ID</h3>\n<p>Let’s say you want to create a bucket with a unique id attached to the name. It wouldn’t be possible to generate that random id inside of serverless.yml without the magic of programming. You can utilize the variable system for this use case like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token comment\"># serverless.yml</span>\n\n<span class=\"token key atrule\">Resources</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">Resources</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">myBucket</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">Type</span><span class=\"token punctuation\">:</span> AWS<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>S3<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Bucket\n      <span class=\"token key atrule\">Properties</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">BucketName</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>bucket<span class=\"token punctuation\">-</span>with<span class=\"token punctuation\">-</span>id<span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">{</span>file(vars.js)<span class=\"token punctuation\">:</span>bucketId<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And in vars.js</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">module<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span>bucketId <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>Fetching Remote Data</h3>\n<p>You can go even further with JS scripts by working with promises and async operations, which is supported out of the box by the Framework. That means you can fetch data needed for your configuration from any remote source you want.</p>\n<p>For example, if you need to use your Github first name as the function name, you can fetch that data from the Github API using a vars.js file like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">module<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">githubFirstName</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/*\n   * some async logic here calling the Github API...\n   */</span>\n  <span class=\"token keyword\">const</span> githubFirstName <span class=\"token operator\">=</span> “Mike”<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>githubFirstName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Then in serverless.yml you can do something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">myPersonalFunction</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>file(vars.js)<span class=\"token punctuation\">:</span>githubFirstName<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The use cases of this feature are limitless! You can fetch global config from DynamoDB, get sensitive data from KMS, or interact with your own API. Whatever is needed by your application.</p>\n<h2>Predeployment Processing</h2>\n<p>A super creative usage of the variable system is to use it without having any actual variables at all! One use case of that is doing some pre-deployment processing as a build script, maybe to prepare or build certain AWS resources that your service depends on or make some changes to your config files. This works out of the box because processing variables happens at the beginning on Serverless initialization. You’ll just need to write your script and reference it wherever needed, most likely in the <code class=\"language-text\">custom</code> property of your <code class=\"language-text\">serverless.yml</code>.</p>\n<p>Let’s take a look at an example. Say you want to control which AWS account to use based on certain logical conditions. You can make use of the variable system to setup the correct value for AWS_PROFILE environment variable for you before deployment. All you have to do is just reference a JS variables file that contain that logic. So in serverless.yml</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> myservice\n<span class=\"token key atrule\">custom</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">setup</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>file(vars.js)<span class=\"token punctuation\">:</span>setup<span class=\"token punctuation\">}</span> <span class=\"token comment\"># this is just to trigger the code. This var is not needed at all!</span></code></pre></div>\n<p>Then in vars.js, you can write your logic:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">module<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">setup</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/*\n   * some logic here...\n   */</span>\n  process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">AWS_PROFILE</span> <span class=\"token operator\">=</span> “mike”<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">AWS_PROFILE</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// you don’t even need to return because you’d never use that value!</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>This way, vars.js could determine which AWS_Profile to use.</p>\n<h2>Organizing Your Serverless Configuration</h2>\n<p>If you’ve been using Serverless in production for a while now, most likely you’ve realized how complex your serverless.yml can become. Many of the configuration options could actually be reused, not only within your services, but throughout all your services.</p>\n<p>As the framework matured, we started to notice patterns in how users are organizing their config file with the help of the variable system. Here are some common structures:</p>\n<h3>Custom Resources Files</h3>\n<p>Real world serverless applications require the use of many AWS resources that you’ll need to set up in the <code class=\"language-text\">resources</code> section of <code class=\"language-text\">serverless.yml</code>. Those resources themselves have many configurations on their own and they will most likely reference other variables. To keep <code class=\"language-text\">serverless.yml</code> from getting bloated, many users keep all their AWS resources in a single <code class=\"language-text\">resources.json</code> file, and reference that file in <code class=\"language-text\">serverless.yml</code> like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">Resources</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>file(resources.json)<span class=\"token punctuation\">}</span></code></pre></div>\n<p>You can also have an outputs.json file and reference it the same way:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">Resources</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>file(resources.json)<span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">outputs</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>file(outputs.json)<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Then, inside of your resources.json &#x26; outputs.json, you can still reference other variables as required by your resources.</p>\n<h3>Function Config Files</h3>\n<p>Some users decide to follow a monolithic architecture when working the Serverless Framework. That means they have a single service, containing all their functions, for their entire project. As the number of functions grows, it become very difficult to manage configuration. Variables allow you to keep each function config in a separate file, for example sitting next to the handler in the service directory structure. Here is an example of what a serverless.yml might look like in this case:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">hello</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>file(hello/config.yml)<span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">world</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>file(world/config.yml)<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And the directory structure would look something like this</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">service\n  |-serverless.yml\n  |-hello:\n      |-config.yml\n      |-handler.js\n  |-world:\n      |-config.yml\n      |-handler.js</code></pre></div>\n<h3>Central Variables File</h3>\n<p>If you make extensive use of the variable system, and define a lot of variables for your project, you can keep them all in a single vars.json, vars.yml or vars.js file. Keeping them in a JS file is the most powerful option because it ensures that you can use logic to dynamically manipulate your exported variable values before they’re populated in serverless.yml.</p>\n<p>So you’d have a vars.js file that looks something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">module<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span>stage <span class=\"token operator\">=</span> ‘$<span class=\"token punctuation\">{</span>opt<span class=\"token operator\">:</span>stage<span class=\"token punctuation\">,</span> self<span class=\"token operator\">:</span>provider<span class=\"token punctuation\">.</span>stage<span class=\"token punctuation\">}</span>’<span class=\"token punctuation\">;</span>\nmodule<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span>region <span class=\"token operator\">=</span> ‘$<span class=\"token punctuation\">{</span>opt<span class=\"token operator\">:</span>region<span class=\"token punctuation\">,</span> self<span class=\"token operator\">:</span>provider<span class=\"token punctuation\">.</span>region<span class=\"token punctuation\">}</span>’<span class=\"token punctuation\">;</span>\nmodule<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span>now <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token number\">.100</span> other variables<span class=\"token operator\">...</span></code></pre></div>\n<p>And then reference this file in <code class=\"language-text\">serverless.yml</code> like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">hello</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> hello<span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">{</span>file(vars.js)<span class=\"token punctuation\">:</span>stage<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This way, if you want to make changes to your variables, you’ll only have to do it once in this central vars.js file.</p>\n<h2>Final Thoughts</h2>\n<p>We just touched the surface on what the variable system could do for your application. There are really no limits with what you can do thanks to the support for JS scripts. We hope this article gave you some inspiration on how to use the variable system in even more creative ways as needed by your application.</p>","frontmatter":{"title":"DevOps Use Cases With Serverless Variables","date":"June 05, 2017","description":"Serverless Framework Engineer Eslam Hefnawy explores creative use cases for using Serverless Variables to optimize and automate operations."}}},"pageContext":{"slug":"/posts/2017-06-05-devops-serverless-variables/","previous":{"fields":{"slug":"/posts/2017-05-24-serverless-v1.14.0/"},"frontmatter":{"title":"Serverless v1.14 - Deploy to Google Cloud Functions & rollback function support added"}},"next":{"fields":{"slug":"/posts/2017-06-09-serverless-v1.15.0/"},"frontmatter":{"title":"Serverless v1.15 - CLI autocomplete & Cognito User Pool trigger events added"}}}}}